  <link rel="stylesheet" type="text/css" href="node_modules/datatables.net-bs4/css/dataTables.bootstrap4.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/datatables.net-select-bs4/css/select.bootstrap4.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/datatables.net-scroller-bs4/css/scroller.bootstrap4.min.css" />

  <div id="table-wrapper" class="table-responsive">
    <table id="table" class="table table-striped table-hover table-sm" cellspacing="0"></table>
  </div>

  <button type="button" class="btn btn-light view_settings_button" data-toggle="modal" data-target="#table_settings_modal">
    <span class="oi oi-cog"></span>
  </button>

  <div id="table-type-panel">
    <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
      <label class="btn btn-secondary active">
        <input type="radio" name="nodelink" id="nodes" autocomplete="off" checked> Nodes
      </label>
      <label class="btn btn-secondary">
        <input type="radio" name="nodelink" id="links" autocomplete="off"> Links
      </label>
      <label class="btn btn-secondary">
        <input type="radio" name="nodelink" id="clusters" autocomplete="off"> Clusters
      </label>
    </div>
  </div>

  <div id="table_settings_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Table Options</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item active">
              <a href="#tableConfigurations" id="table-tab" class="nav-link active" aria-controls="table" role="tab" data-toggle="tab">Table</a>
            </li>
          </ul>
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tableConfigurations" role="tabpanel" aria-labelledby="table-tab">
              <div class="form-group row">
                <div class="col-3">Text Size</div>
                <div class="col-9"><input type="range" id="font-size-slider" min="6" value="14" max="72" step="1" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3">Header Tilt</div>
                <div class="col-9"><input type="range" id="tiltHeaders" min="-7.5" value="0" max="7.5" step=".25" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3">Columns</div>
                <div class="col-9"><select id="columns" class="chosen-select" multiple></select></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script src="node_modules/datatables.net/js/jquery.dataTables.js"></script>
  <script src="node_modules/datatables.net-bs4/js/dataTables.bootstrap4.js"></script>
  <script src="node_modules/datatables.net-select/js/dataTables.select.min.js"></script>
  <script src="node_modules/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
  <script type="text/javascript">
  (function(){

    var meta = ['index', 'padding', 'selected', 'visible', 'orig', 'mst'];

    var table = { destroy: function(){} };

    session.data.clusterFields = Object.keys(session.data.clusters[0]);

    function updateTable(){
      var data_type = $('input[name=nodelink]:checked')[0].id;
      var data = [];
      if(data_type === 'clusters'){
        data = session.data.clusters.filter(c => c.nodes > 1);
      } else {
        data = session.data[data_type].filter(function(thing){ return thing.visible; });
      }
      var columns = session.data[data_type.slice(0,-1) + 'Fields'];
      table.destroy();
      var options = {
        dom: 'rti',
        data: data,
        columns: columns.map(k => ({title:app.titleize(k), data:k, mData:k, sTitle:app.titleize(k)})),
        deferRender: true,
        scrollY: $('#table-wrapper').height() - 100,
        scrollCollapse: true,
        scroller: true,
        select: {
          style: 'multi'
        }
      };
      var selectedColumn = columns.findIndex(d => d === 'selected');
      if(selectedColumn >= 0) options.orderFixed = [selectedColumn, 'desc'];
      table = $('#table').empty().DataTable(options);
      var colsToKeep = $('#columns').val().map(parseFloat);
      columns.forEach((col, i) => table.column(i).visible(colsToKeep.includes(i)));
      table.on('user-select', (e, dt, type, cell) => {
        var index = cell.index().row;
        if(data_type === 'nodes'){
          session.data[data_type][index].selected = !session.data[data_type][index].selected;
          $(window).trigger('node_selected');
        } else {
          reorder();
        }
      });
      selectRows();
      resetTextsize();
    }

    $(window).on('node_selected', selectRows);

    function selectRows(){
      var data_type = $('input[name=nodelink]:checked')[0].id;
      table
        .rows()
          .deselect()
        .rows(
          session.data[data_type]
            .filter(n => n.selected)
            .map(n => n.index)
        ).select();
      reorder();
    }

    function reorder(){ table.draw(false); }

    function updateColumns(){
      var type = $('input[name=nodelink]:checked')[0].id.slice(0,-1);
      $('#columns')
        .chosen('destroy')
        .html(
          session.data[type+'Fields'].map((d, i) => {
            if(meta.includes(d)) return;
            return `<option value="${i}"${(i < 7) ? " selected" : ""}>${app.titleize(d)}</option>`
          }).join('\n')
        ).chosen({width: "100%"}).change(e => {
          var colsToKeep = $('#columns').val().map(parseFloat);
          session.data[type+'Fields'].forEach((col, i) => table.column(i).visible(colsToKeep.includes(i)));
        });
    }

    updateColumns();

    $('#tiltHeaders').on('input', function(e){
      var theta = $(this).val();
      var h = $('th:first').width() * Math.sin(Math.abs(theta) * Math.PI / 180);
      $('th').css({
        'transform': `rotate(${-theta}deg)`,
        'border-bottom': '0px',
        'height': `${h}px`,
        'overflow': 'visible'
      });
      if($(this).val() === 0){
        $('th').css({
          'border-bottom': '1px solid black',
          'overflow': 'hidden'
        });
      }
    });

    function resetTextsize(){
      var s = $('#font-size-slider').val();
      $('#table').css({
        'font-size': s + 'px',
        'line-height': s/10
      });
    }

    $('input[name=nodelink]').on('change', e => {
      updateColumns();
      updateTable();
    });

    $('#columns').on('change', e => updateTable());

    $('#font-size-slider').on('input', resetTextsize);

    $('#linkSortVariable, #default-link-threshold').on('input', e => {
      if($('input[name=nodelink]:checked')[0].id === 'clusters'){
        updateTable();
      }
    });

    $('#showMSTLinks, #showAllLinks').on('input', function(){
      if($('input[name=nodelink]:checked')[0].id === 'links'){
        updateTable();
      }
    });

    $('#ShowSingletons, #HideSingletons').on('input', function(){
      if($('input[name=nodelink]:checked')[0].id === 'nodes'){
        updateTable();
      }
    });

    setTimeout(updateTable, 100);

  })();

  $.fn.dataTable.ext.errMode = 'none';

  </script>
