  <button type="button" class="btn btn-light view_settings_button" data-toggle="modal" data-target="#table_settings_modal">
    <span class="oi oi-cog"></span>
  </button>

  <div id="table-type-panel">
    <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
      <label class="btn btn-secondary active">
        <input type="radio" name="nodelink" id="nodes" autocomplete="off" checked> Nodes
      </label>
      <label class="btn btn-secondary">
        <input type="radio" name="nodelink" id="links" autocomplete="off"> Links
      </label>
      <label class="btn btn-secondary">
        <input type="radio" name="nodelink" id="clusters" autocomplete="off"> Clusters
      </label>
    </div>
  </div>

  <div id="table_settings_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Table Options</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item active">
              <a href="#tableConfigurations" id="table-tab" class="nav-link active" aria-controls="table" role="tab" data-toggle="tab">Table</a>
            </li>
          </ul>
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tableConfigurations" role="tabpanel" aria-labelledby="table-tab">
              <div class="form-group row">
                <div class="col-3">Text Size</div>
                <div class="col-9"><input type="range" id="font-size-slider" min="6" value="14" max="72" step="1" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3">Header Tilt</div>
                <div class="col-9"><input type="range" id="tiltHeaders" min="-7.5" value="0" max="7.5" step=".25" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3">Columns</div>
                <div class="col-9"><select id="columns" class="chosen-select" multiple></select></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="container-fluid">
    <div id="table-wrapper" class="table-responsive">
      <mt-table
        :data="gridData"
        :columns="gridColumns">
      </mt-table>
    </div>
  </div>

  <!-- component template -->
  <script type="text/x-template" id="mt-table-template">
    <table class="table table-hover table-sm" cellspacing="0">
      <thead>
        <tr>
          <th v-for="key in columns"
            @click="sortBy(key)"
            :class="{ active: sortKey == key }">
            {{ app.titleize(key) }}
            <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="entry in filteredData"
          @click="select(entry)"
          :class="entry.selected ? 'table-active' : ''">
          <td v-for="key in columns">{{ entry[key] }}</td>
        </tr>
      </tbody>
    </table>
  </script>

  <script type="text/javascript">
  (function(){
    var table;

    var meta = ['index', 'padding', 'selected', 'visible', 'mst'];

    session.data.clusterFields = Object.keys(session.data.clusters[0]);

    Vue.component('mt-table', {
      template: '#mt-table-template',
      props: {
        data: Array,
        columns: Array
      },
      data: function(){
        var sortOrders = {};
        this.columns.forEach(function(key){
          sortOrders[key] = 1;
        });
        return {
          sortKey: 'id',
          sortOrders: sortOrders
        }
      },
      computed: {
        filteredData: function(){
          var sortKey = this.sortKey;
          var order = this.sortOrders[sortKey] || 1;
          var data = this.data.filter(d => d.visible);
          if(sortKey){
            data = data.slice().sort(function(a, b){
              if(a.selected && !b.selected) return -1;
              if(b.selected && !a.selected) return 1;
              return (a[sortKey] === b[sortKey] ? 0 : a[sortKey] > b[sortKey] ? 1 : -1) * order;
            });
          }
          return data;
        }
      },
      methods: {
        sortBy: function(key){
          this.sortKey = key;
          this.sortOrders[key] = this.sortOrders[key] * -1;
        },
        select: function(entry){
          entry.selected = !entry.selected
          if($('input[name=nodelink]:checked')[0].id === 'nodes'){
            $(window).trigger('node_selected');
          }
        }
      }
    });

    function updateTable(){
      var data_type = $('input[name=nodelink]:checked')[0].id;
      var colsToKeep = $('#columns').val();
      table.gridColumns = $('#columns').val();
      table.gridData = session.data[$('input[name=nodelink]:checked')[0].id];
      resetTextsize();
    }

    function updateColumns(){
      var type = $('input[name=nodelink]:checked')[0].id.slice(0,-1);
      $('#columns')
        .chosen('destroy')
        .html(
          session.data[type+'Fields'].map((d, i) => {
            if(meta.includes(d)) return;
            return `<option value="${d}"${(i < 7) ? " selected" : ""}>${app.titleize(d)}</option>`
          }).join('\n')
        ).chosen({width: "100%"}).change(updateTable);
    }

    updateColumns();

    $('#tiltHeaders').on('input', function(e){
      var theta = $(this).val();
      var h = $('th:first').width() * Math.sin(Math.abs(theta) * Math.PI / 180);
      $('th').css({
        'transform': `rotate(${-theta}deg)`,
        'border-bottom': '0px',
        'height': `${h}px`,
        'overflow': 'visible'
      });
      if($(this).val() === 0){
        $('th').css({
          'border-bottom': '1px solid black',
          'overflow': 'hidden'
        });
      }
    });

    function resetTextsize(){
      var s = $('#font-size-slider').val();
      $('#table-wrapper').css({
        'font-size': s + 'px',
        'line-height': s/10
      });
    }

    $('input[name=nodelink]').on('change', e => {
      updateColumns();
      updateTable();
    });

    $('#columns').on('change', updateTable);

    $('#font-size-slider').on('input', resetTextsize);

    $('#linkSortVariable, #default-link-threshold').on('input', e => {
      if($('input[name=nodelink]:checked')[0].id === 'clusters'){
        updateTable();
      }
    });

    setTimeout(function(){
      table = new Vue({
        el: '#table-wrapper',
        data: {
          gridColumns: $('#columns').val(),
          gridData: session.data[$('input[name=nodelink]:checked')[0].id]
        }
      });
      resetTextsize();
    }, 100);

  })();

  </script>
