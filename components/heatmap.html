  <div id="heatmap_panel"></div>

  <div class="view_controls">
    <button type="button" class="btn btn-light btn-sm" data-toggle="modal" data-target="#heatmap_settings_modal">
      <span class="oi oi-cog"></span>
    </button>
  </div>

  <div class="modal fade" id="heatmap_settings_modal" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Heatmap Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="form-group row">
              <div class="col-3">Distance Metric</div>
              <div class="col-9">
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons" id="heatmap_distanceMetric"></div>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-3">Invert Axes</div>
              <div class="col-9">
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                  <label class="btn btn-secondary">
                    <input id="heatmap_invertX" type="checkbox"> X
                  </label>
                </div>
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                  <label class="btn btn-secondary">
                    <input id="heatmap_invertY" type="checkbox"> Y
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-3">Color Scheme</div>
              <div class="col-9">
                <input type="color" id="heatmap_lowColor" value="#313695" />
                <input type="color" id="heatmap_medianColor" value="#ffffbf" />
                <input type="color" id="heatmap_highColor" value="#a50026" />
              </div>
            </div>
            <div class="form-group row">
              <div class="col-3">Axis Labels</div>
              <div class="col-9">
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                  <label class="btn btn-secondary">
                    <input type="radio" name="axisLabels" id="heatmap_showAxisLabels" autocomplete="off"> Show
                  </label>
                  <label class="btn btn-secondary active">
                    <input type="radio" name="axisLabels" id="heatmap_hideAxisLabels" autocomplete="off" checked> Hide
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
  (function(){

    $('#heatmap_distanceMetric').html(
      Object.keys(session.data.distance_matrix).filter(k => k !== 'labels').map((k, i) => `
        <label class="btn btn-secondary${(i===0)? ' active':''}">
          <input type="radio" name="distanceMetric" id="${k}" autocomplete="off"${(i===0)? ' checked':''}>${app.titleize(k)}</input>
        </label>
      `).join('')
    );

    function redrawHeatmap(){
      if(!session.data.distance_matrix.tn93 && !session.data.distance_matrix.snps){
        return alertify.error('No distance matrix could be found!');
      }

      if(window.plot) Plotly.purge('heatmap_panel');

      var xLabels = session.data.distance_matrix.labels.map(d => 'N' + d);
      var yLabels = xLabels.slice();
      var data = session.data.distance_matrix[$('[name="distanceMetric"]:checked')[0].id].map(l => l.slice());

      if($('#heatmap_invertX').is(':checked')){
        data.forEach(l => l.reverse());
        xLabels.reverse();
      }

      if($('#heatmap_invertY').is(':checked')){
        data.reverse();
        yLabels.reverse();
      }

      var config = {
        autotick: false,
        showticklabels: $('#heatmap_showAxisLabels').is(':checked')
      };

      if(!$('#heatmap_showAxisLabels').is(':checked')){
        config.ticks = '';
      }

      window.plot = Plotly.newPlot('heatmap_panel', [{
        x: xLabels,
        y: yLabels,
        z: data,
        type: 'heatmap',
        colorscale: [
          [0, $('#heatmap_lowColor').val()],
          [0.5, $('#heatmap_medianColor').val()],
          [1, $('#heatmap_highColor').val()]
        ]
      }], {
        xaxis: config,
        yaxis: config,
        width: $('#heatmap_panel').parent().width(),
        height: $('#heatmap_panel').parent().height()
      }, {
        displaylogo: false,
        displayModeBar: false
      });
    }

    $('input[name="distanceMetric"]').change(redrawHeatmap);
    $('input[name="axisLabels"]').change(redrawHeatmap);
    $('input[type="color"]').change(redrawHeatmap);
    $('#heatmap_invertX, #heatmap_invertY').change(redrawHeatmap);

    setTimeout(redrawHeatmap, 80);

  })();
  </script>
