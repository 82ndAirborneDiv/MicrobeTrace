  <div id="heatmap_panel"></div>

  <div class="view_controls">
    <button type="button" id="toggle_heatmap_settings" class="btn btn-light btn-sm">
      <span class="oi oi-cog"></span>
    </button>
    <button type="button" class="btn btn-light btn-sm"  data-toggle="modal" data-target="#export_heatmap_modal" title="Export Heatmap">
      <span class="oi oi-data-transfer-download"></span>
    </button>
  </div>

  <div id="heatmap_settings_pane" class="left_pane">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item active">
        <a href="#heatmapConfigurations" id="heatmap-tab" class="nav-link active" aria-controls="heatmap" role="tab" data-toggle="tab">Heatmap</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="heatmapConfigurations" role="tabpanel" aria-labelledby="heatmap-tab">
        <div class="form-group row">
          <div class="col-3">Distance Metric</div>
          <div class="col-9">
            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons" id="heatmap_distanceMetric"></div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Invert Axes</div>
          <div class="col-9">
            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
              <label class="btn btn-secondary">
                <input id="heatmap_invertX" type="checkbox"> X
              </label>
            </div>
            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
              <label class="btn btn-secondary">
                <input id="heatmap_invertY" type="checkbox"> Y
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Color Scheme</div>
          <div class="col-9">
            <input type="color" id="heatmap_highColor" class="custom-select custom-select-sm" value="#a50026" />
            <input type="color" id="heatmap_medianColor" class="custom-select custom-select-sm" value="#ffffbf" />
            <input type="color" id="heatmap_lowColor" class="custom-select custom-select-sm" value="#313695" />
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Axis Labels</div>
          <div class="col-9">
            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
              <label class="btn btn-secondary">
                <input type="radio" name="axisLabels" id="heatmap_showAxisLabels" autocomplete="off"> Show
              </label>
              <label class="btn btn-secondary active">
                <input type="radio" name="axisLabels" id="heatmap_hideAxisLabels" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="export_heatmap_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Heatmap</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="export-heatmap-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select id="export-heatmap-file-type" class="form-control form-control-sm">
                <option selected>csv</option>
                <option>png</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="heatmap_export" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
  (function(){

    var plot;

    $('#heatmap_distanceMetric').html(
      Object.keys(session.data.distance_matrix).filter(k => k !== 'labels').map((k, i) => `
        <label class="btn btn-secondary${(i===0)? ' active':''}">
          <input type="radio" name="distanceMetric" id="${k}" autocomplete="off"${(i===0)? ' checked':''}>${app.titleize(k)}</input>
        </label>
      `).join('')
    );

    function redrawHeatmap(){
      if(!$('#heatmap_panel').length) return;
      if(plot) Plotly.purge('heatmap_panel');
      if(!session.data.distance_matrix.tn93 && !session.data.distance_matrix.snps){
        return alertify.error('No distance matrix could be found!');
      }
      var xLabels = session.data.distance_matrix.labels.map(d => 'N' + d);
      var yLabels = xLabels.slice();
      var data = session.data.distance_matrix[$('[name="distanceMetric"]:checked')[0].id].map(l => l.slice());

      if($('#heatmap_invertX').is(':checked')){
        data.forEach(l => l.reverse());
        xLabels.reverse();
      }

      if($('#heatmap_invertY').is(':checked')){
        data.reverse();
        yLabels.reverse();
      }

      var config = {
        autotick: false,
        showticklabels: $('#heatmap_showAxisLabels').is(':checked')
      };

      if(!$('#heatmap_showAxisLabels').is(':checked')){
        config.ticks = '';
      }

      plot = Plotly.newPlot('heatmap_panel', [{
        x: xLabels,
        y: yLabels,
        z: data,
        type: 'heatmap',
        colorscale: [
          [0, $('#heatmap_lowColor').val()],
          [0.5, $('#heatmap_medianColor').val()],
          [1, $('#heatmap_highColor').val()]
        ]
      }], {
        xaxis: config,
        yaxis: config,
        width: $('#heatmap_panel').parent().width(),
        height: $('#heatmap_panel').parent().height()
      }, {
        displaylogo: false,
        displayModeBar: false
      });
    }

    $('#toggle_heatmap_settings').click(function(){
      var pane = $('#heatmap_settings_pane');
      if(pane.is(':visible')){
        pane.animate({left: '-400px'}, function(){ pane.hide(); });
      } else {
        pane.show(0, function(){ pane.animate({left: '0px'}); });
      }
    });

    $('#heatmap_export').on('mousedown', function(){
      var filetype = $('#export-heatmap-file-type').val();
      var name = $('#export-heatmap-file-name').val();
      if(filetype === 'csv'){
        content = app.unparseDM(session.data.distance_matrix[$('[name="distanceMetric"]:checked')[0].id]);
        var blob = new Blob([content]);
        saveAs(blob, name + '.' + filetype);
        return;
      }
      var network = $('#heatmap_panel image').get(0);
      if(filetype === 'png'){
        var bin = atob(network.href.baseVal.slice(22));
        var length = bin.length;
        var buf = new ArrayBuffer(length);
        var arr = new Uint8Array(buf);
        for (var i = 0; i < length; i++) {
          arr[i] = bin.charCodeAt(i);
        }
        var blob = new Blob([buf], {type: 'image/png'});
        saveAs(blob, $('#export-heatmap-file-name').val() + '.' + filetype);
      }
    });

    $('input[name="distanceMetric"]').change(redrawHeatmap);
    $('input[name="axisLabels"]').change(redrawHeatmap);
    $('input[type="color"]').change(redrawHeatmap);
    $('#heatmap_invertX, #heatmap_invertY').change(redrawHeatmap);


    layout.on('stateChanged', redrawHeatmap);
    setTimeout(redrawHeatmap, 80);

  })();
  </script>
