  <script src="node_modules/d3-force-3d/build/d3-force-3d.min.js"></script>

  <div id="3d-network"></div>

  <div class="view_controls">
    <button type="button" id="toggle_3d_network_settings" class="btn btn-light btn-sm">
      <span class="oi oi-cog"></span>
    </button>
    <!--button type="button" class="btn btn-light btn-sm"  data-toggle="modal" data-target="#export_3d_modal" title="Export Network">
      <span class="oi oi-data-transfer-download"></span>
    </button-->
  </div>

  <div id="3d_network_settings_pane" class="left_pane">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="nav-item active">
        <a href="#networkConfigurations" class="nav-link active" aria-controls="profile" role="tab" data-toggle="tab">3D Network</a>
      </li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
      <div id="networkConfigurations" class="tab-pane fade show active" role="tabpanel">
        <div class="form-group row">
          <div class="col-4"><strong>Property</strong></div>
          <div class="col-8"><strong>Value</strong></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color should the nodes be?">Node Color</a></div>
          <div class="col-8"><input type="color" id="3d_network_default-node-color" value="#5656ff" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="How large should the nodes be?">Node Size</a></div>
          <div class="col-8"><input type="range" id="3d_network_default-node-radius" min=".1" value="4" step=".1" max="20" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color should the links be?">Link Color</a></div>
          <div class="col-8"><input type="color" id="3d_network_default-link-color" value="#5f5f5f" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="How transparent should the links be?">Link Transparency</a></div>
          <div class="col-8"><input type="range" id="3d_network_default-link-opacity" min="0" max="1" value="0.5" step="0.01" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color would you like the background to be?">Background Color</a></div>
          <div class="col-8"><input type="color" id="3d_network-color" value="#ffffff" /></div>
        </div>
      </div>
    </div>
  </div>

  <div id="export_3d_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Network Image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="export-3d-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select id="export-img-file-type" class="form-control form-control-sm">
                <option selected>png</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="3d_network_export" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script src="vendor/3d-force-graph.min.js"></script>
  <script>
  (function(){
    var graph = ForceGraph3D()($('#3d-network')[0]);

    function drawGraph3D(){
      var lc = $('#3d_network_default-link-color').val();
      var nodeColor = $('#3d_network_default-node-color').val();
      var links = UltraDeepClone(session.data.links.filter(l => l.visible));
      var nodes = UltraDeepClone(session.data.nodes);
      nodes.forEach(d => {
        delete d.x;
        delete d.y;
        delete d.fx;
        delete d.fy;
        delete d.vx;
        delete d.vy;
      });
      graph
        .backgroundColor($('#3d_network-color').val())
        .nodeRelSize($('#3d_network_default-node-radius').val())
        .colorField(d => nodeColor)
        .lineOpacity($('#3d_network_default-link-opacity').val())
        .linkColorField(l => lc)
        .graphData({
          nodes: nodes,
          links: links
        });
    }

    $('#toggle_3d_network_settings').click(function(){
      var pane = $('#3d_network_settings_pane');
      if(pane.is(':visible')){
        pane.animate({left: '-400px'}, function(){ pane.hide(); });
      } else {
        pane.show(0, function(){ pane.animate({left: '0px'}); });
      }
    });

    $('#3d_network_export').click(function(){
      $('#3d-network canvas').get(0).toBlob(function(blob){
        saveAs(blob, $('#export-3d-file-name').val()+'.png');
      });
    });

    $('#linkSortVariable, #default-link-threshold').change(drawGraph3D);
    $('#3d_network_default-node-color, #3d_network_default-link-color, #3d_network-color, #3d_network_default-node-radius, #3d_network_default-link-opacity').change(drawGraph3D);

    drawGraph3D();
  })();
  </script>
