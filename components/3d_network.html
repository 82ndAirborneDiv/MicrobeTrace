  <script src="node_modules/d3-force-3d/build/d3-force-3d.min.js"></script>

  <div id="3d-network"></div>

  <div class="view_controls">
    <button type="button" id="toggle_3d_network_settings" class="btn btn-light btn-sm">
      <span class="oi oi-cog"></span>
    </button>
  </div>

  <div id="3d_network_settings_pane" class="left_pane">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="nav-item active">
        <a href="#networkConfigurations" class="nav-link active" aria-controls="profile" role="tab" data-toggle="tab">3D Network</a>
      </li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
      <div id="networkConfigurations" class="tab-pane fade show active" role="tabpanel">
        <div class="form-group row">
          <div class="col-4"><strong>Property</strong></div>
          <div class="col-8"><strong>Value</strong></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color should the nodes be?">Node Color</a></div>
          <div class="col-8"><input type="color" id="3d_network_default-node-color" value="#5656ff" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="How large should the nodes be?">Node Size</a></div>
          <div class="col-8"><input type="range" id="3d_network_default-node-radius" min=".1" value="4" step=".1" max="20" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color should the links be?">Link Color</a></div>
          <div class="col-8"><input type="color" id="3d_network_default-link-color" value="#5f5f5f" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="How transparent should the links be?">Link Transparency</a></div>
          <div class="col-8"><input type="range" id="3d_network_default-link-opacity" min="0" max="1" value="0.5" step="0.01" /></div>
        </div>
        <div class="form-group row">
          <div class="col-4"><a href="#" data-toggle="tooltip" title="What color would you like the background to be?">Background Color</a></div>
          <div class="col-8"><input type="color" id="3d_network-color" value="#ffffff" /></div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="vendor/3d-force-graph.min.js"></script>
  <script>
  (function(){
    var graph = ForceGraph3D()($('#3d-network')[0]);

    function drawGraph3D(){
      var lc = $('#3d_network_default-link-color').val();
      var pv = $('#linkSortVariable').val();
      var t = $('#default-link-threshold').val();
      var nodeColor = $('#3d_network_default-node-color').val();
      var links = UltraDeepClone(session.data.links.filter(l => l[pv] < t));
      var nodes = UltraDeepClone(session.data.nodes);
      nodes.forEach(d => {
        delete d.x;
        delete d.y;
        delete d.fx;
        delete d.fy;
        delete d.vx;
        delete d.vy;
      });
      graph
        .backgroundColor($('#3d_network-color').val())
        .nodeRelSize($('#3d_network_default-node-radius').val())
        .colorField(d => nodeColor)
        .lineOpacity($('#3d_network_default-link-opacity').val())
        .linkColorField(l => lc)
        .graphData({
          nodes: nodes,
          links: links
        });
    }

    $('#toggle_3d_network_settings').click(function(){
      var pane = $('#3d_network_settings_pane');
      if(pane.is(':visible')){
        pane.animate({left: '-400px'}, function(){ pane.hide(); });
      } else {
        pane.show(0, function(){ pane.animate({left: '0px'}); });
      }
    });

    $('#linkSortVariable, #default-link-threshold').change(drawGraph3D);
    $('#3d_network_default-node-color, #3d_network_default-link-color, #3d_network-color, #3d_network_default-node-radius, #3d_network_default-link-opacity').change(drawGraph3D);

    drawGraph3D();
  })();
  </script>
