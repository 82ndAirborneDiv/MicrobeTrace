  <svg id="phylogenetic_tree_panel"></svg>

  <table id="phylogenetic_tree_statistics">
    <tr>
      <td>Selected Branches</td>
      <td id="phylogenetic_tree_selected_branch_counter">0</td>
    </tr>
  </table>

  <button type="button" class="view_settings_button btn btn-light" data-toggle="modal" data-target="#phylogenetic_tree_settings_modal">
    <span class="oi oi-cog"></span>
  </button>

  <div class="modal fade" id="phylogenetic_tree_settings_modal" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Phylogenetic Tree Configuration</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <label id="show-length">
              <input type="checkbox"> Show branch length
            </label>
          </div>
          <div class="row">
            <div class="col-xs-3">Distance Metric</div>
            <div class="col-xs-9">
              <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-default btn-xs active">
                  <input type="radio" name="distanceMetric" id="tn93" autocomplete="off" checked> TN93
                </label>
                <label class="btn btn-default btn-xs">
                  <input type="radio" name="distanceMetric" id="snps" autocomplete="off"> SNPs
                </label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-3">Layout Tweaks</div>
            <div class="col-xs-9">
              <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm" data-direction="vertical" data-amount="1" title="Expand vertical spacing">
                    <i class="fa fa-arrows-v"></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" data-direction="vertical" data-amount="-1" title="Compress vertical spacing">
                    <i class="fa fa-compress fa-rotate-135"></i>
                </button>
                <button type="button" class="btn btn-default btn-sm" data-direction="horizontal" data-amount="1" title="Expand horizonal spacing">
                    <i class="fa fa-arrows-h"></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" data-direction="horizontal" data-amount="-1" title="Compress horizonal spacing">
                    <i class="fa fa-compress fa-rotate-45"></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id="sort_ascending" title="Sort deepest clades to the bottom">
                    <i class="fa fa-sort-amount-asc"></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id="sort_descending" title="Sort deepsest clades to the top">
                    <i class="fa fa-sort-amount-desc"></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id="sort_original" title="Restore original order">
                    <i class="fa fa-sort"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-3">Layout</div>
            <div class="col-xs-9">
              <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-default active btn-sm">
                  <input type="radio" name="options" class="phylotree-layout-mode" data-mode="linear" autocomplete="off" checked title="Layout left-to-right"> Linear
                </label>
                <label class="btn btn-default  btn-sm">
                  <input type="radio" name="options" class="phylotree-layout-mode" data-mode="radial" autocomplete="off" title="Layout radially"> Radial
                </label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-3">Label Alignment</div>
            <div class="col-xs-9">
              <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-default active btn-sm">
                  <input type="radio" class="phylotree-align-toggler" data-align="left" name="options-align" autocomplete="off" checked title="Align tips labels to branches">
                      <i class="fa fa-align-left"></i>
                  </input>
                </label>
                <label class="btn btn-default btn-sm">
                 <input type="radio" class="phylotree-align-toggler" data-align="right" name="options-align" autocomplete="off" title="Align tips labels to the edge of the plot">
                      <i class="fa fa-align-right"></i>
                  </input>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">OK</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>

  function parseNewick(a){for(var e=[],r={},s=a.split(/\s*(;|\(|\)|,|:)\s*/),t=0;t<s.length;t++){var n=s[t];switch(n){case"(":var c={};r.branchset=[c],e.push(r),r=c;break;case",":var c={};e[e.length-1].branchset.push(c),r=c;break;case")":r=e.pop();break;case":":break;default:var h=s[t-1];")"==h||"("==h||","==h?r.name=n:":"==h&&(r.length=parseFloat(n))}}return r}

  var outerRadius = 960 / 2,
      innerRadius = outerRadius - 170;

  var color = d3.scaleOrdinal()
      .domain(["Bacteria", "Eukaryota", "Archaea"])
      .range(d3.schemeCategory10);

  var cluster = d3.cluster()
      .size([360, innerRadius])
      .separation(function(a, b) { return 1; });

  var tree_zoomer = d3.zoom().on('zoom', () => tree_svg.attr('transform', d3.event.transform))

  var tree_svg = d3.select("svg#phylogenetic_tree_panel")
      .attr("width", outerRadius * 2)
      .attr("height", outerRadius * 2)
      .call(session.network.zoom)
      .append(g);

  var legend = tree_svg.append("g").attr("class", "legend")
    .selectAll("g").data(color.domain())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(" + (outerRadius * 2 - 10) + "," + (i * 20 + 10) + ")"; });

  legend.append("rect")
      .attr("x", -18)
      .attr("width", 18)
      .attr("height", 18)
      .attr("fill", color);

  legend.append("text")
      .attr("x", -24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .text(function(d){ return d; });

  var chart = tree_svg.append("g")
      .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");

  d3.text("data/life.txt", function(error, life) {
    if (error) throw error;

    var root = d3.hierarchy(parseNewick(life), function(d) { return d.branchset; })
        .sum(function(d) { return d.branchset ? 0 : 1; })
        .sort(function(a, b) { return (a.value - b.value) || d3.ascending(a.data.length, b.data.length); });

    cluster(root);

    var input = d3.select("#show-length input").on("change", changed);

    setRadius(root, root.data.length = 0, innerRadius / maxLength(root));
    setColor(root);

    var linkExtension = chart.append("g")
        .attr("class", "link-extensions")
      .selectAll("path")
      .data(root.links().filter(function(d) { return !d.target.children; }))
      .enter().append("path")
        .each(function(d) { d.target.linkExtensionNode = this; })
        .attr("d", linkExtensionConstant);

    var link = chart.append("g")
        .attr("class", "links")
      .selectAll("path")
      .data(root.links())
      .enter().append("path")
        .each(function(d) { d.target.linkNode = this; })
        .attr("d", linkConstant)
        .attr("stroke", function(d) { return d.target.color; });

    chart.append("g")
        .attr("class", "labels")
      .selectAll("text")
      .data(root.leaves())
      .enter().append("text")
        .attr("dy", ".31em")
        .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (innerRadius + 4) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
        .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
        .text(function(d) { return d.data.name.replace(/_/g, " "); })
        .on("mouseover", mouseovered(true))
        .on("mouseout", mouseovered(false));

    function changed(){
      var t = d3.transition().duration(750);
      linkExtension.transition(t).attr("d", this.checked ? linkExtensionVariable : linkExtensionConstant);
      link.transition(t).attr("d", this.checked ? linkVariable : linkConstant);
    }

    function mouseovered(active) {
      return function(d) {
        d3.select(this).classed("label--active", active);
        d3.select(d.linkExtensionNode).classed("link-extension--active", active).each(moveToFront);
        do d3.select(d.linkNode).classed("link--active", active).each(moveToFront); while (d = d.parent);
      };
    }

    function moveToFront() {
      this.parentNode.appendChild(this);
    }
  });

  // Compute the maximum cumulative length of any node in the tree.
  function maxLength(d) {
    return d.data.length + (d.children ? d3.max(d.children, maxLength) : 0);
  }

  // Set the radius of each node by recursively summing and scaling the distance from the root.
  function setRadius(d, y0, k) {
    d.radius = (y0 += d.data.length) * k;
    if (d.children) d.children.forEach(function(d) { setRadius(d, y0, k); });
  }

  // Set the color of each node by recursively inheriting.
  function setColor(d) {
    var name = d.data.name;
    d.color = color.domain().indexOf(name) >= 0 ? color(name) : d.parent ? d.parent.color : null;
    if (d.children) d.children.forEach(setColor);
  }

  function linkVariable(d) {
    return linkStep(d.source.x, d.source.radius, d.target.x, d.target.radius);
  }

  function linkConstant(d) {
    return linkStep(d.source.x, d.source.y, d.target.x, d.target.y);
  }

  function linkExtensionVariable(d) {
    return linkStep(d.target.x, d.target.radius, d.target.x, innerRadius);
  }

  function linkExtensionConstant(d) {
    return linkStep(d.target.x, d.target.y, d.target.x, innerRadius);
  }

  // Like d3.svg.diagonal.radial, but with square corners.
  function linkStep(startAngle, startRadius, endAngle, endRadius) {
    var c0 = Math.cos(startAngle = (startAngle - 90) / 180 * Math.PI),
        s0 = Math.sin(startAngle),
        c1 = Math.cos(endAngle = (endAngle - 90) / 180 * Math.PI),
        s1 = Math.sin(endAngle);
    return "M" + startRadius * c0 + "," + startRadius * s0
        + (endAngle === startAngle ? "" : "A" + startRadius + "," + startRadius + " 0 0 " + (endAngle > startAngle ? 1 : 0) + " " + startRadius * c1 + "," + startRadius * s1)
        + "L" + endRadius * c1 + "," + endRadius * s1;
  }

  </script>
