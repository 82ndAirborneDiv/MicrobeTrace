<div id="tree"></div>

<div class="view-controls">
  <button id="toggle-tree-settings" type="button" class="btn btn-light btn-sm" title="Toggle Tree Settings">
    <span class="oi oi-cog"></span>
  </button>
  <button type="button" class="btn btn-light btn-sm" data-toggle="modal" data-target="#tree-export-modal"
    title="Export Tree">
    <span class="oi oi-data-transfer-download"></span>
  </button>
  <button id="tree-fitbutton" type="button" class="btn btn-light btn-sm" title="Center and Scale Phylogenetic Tree">
    <span class="oi oi-target"></span>
  </button>
</div>

<div id="tree-settings-pane" class="left-pane">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a href="#tree-configurations" id="tree-tab" class="nav-link active" aria-controls="tree" role="tab"
        data-toggle="tab">Tree</a>
    </li>
    <li class="nav-item">
      <a href="#tree-branch-configurations" id="tree-branch-tab" class="nav-link" aria-controls="tree" role="tab"
        data-toggle="tab">Branches</a>
    </li>
    <li class="nav-item">
      <a href="#tree-leaf-configurations" id="tree-leaf-tab" class="nav-link" aria-controls="tree" role="tab"
        data-toggle="tab">Leaves</a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="tree-configurations" role="tabpanel" aria-labelledby="tree-tab">
      <div class="form-group row" title="What kind of layout would you like to use for this tree?">
        <div class="col-3">
          <label for="tree-type">Type</label>
        </div>
        <div class="col-9">
          <select id="tree-type" class="form-control form-control-sm">
            <option value="tree">Tree</option>
            <option value="weighted" selected>Weighted Dendrogram</option>
            <option value="dendrogram">Unweighted Dendrogram</option>
          </select>
        </div>
      </div>
      <div class="form-group row" title="What kind of layout would you like to use for this tree?">
        <div class="col-3">Layout</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm active col">
              <input type="radio" name="tree-layout" id="tree-layout-vertical" autocomplete="off" checked>
              Vertical
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-layout" id="tree-layout-horizontal" autocomplete="off"> Horizontal
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-layout" id="tree-layout-circular" autocomplete="off"> Circular
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row" title="Would you like to vertically stretch (or squish) the Tree?">
        <div class="col-3">
          <label for="tree-vertical-stretch">Vertical Stretch</label>
        </div>
        <div class="col-9">
          <input id="tree-vertical-stretch" type="range" min="0.1" max="10" value="1" step="0.1" />
        </div>
      </div>
      <div class="form-group row" title="Would you like to horizontally stretch (or squish) the Tree?">
        <div class="col-3">
          <label for="tree-horizontal-stretch">Horizontal Stretch</label>
        </div>
        <div class="col-9">
          <input id="tree-horizontal-stretch" type="range" min="0.1" max="10" value="1" step="0.1" />
        </div>
      </div>
      <div class="form-group row hideForCircular"
        title="Would you like to see a ruler indicating patristic distances next to your tree?">
        <div class="col-3">Ruler</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-ruler" id="tree-ruler-show" autocomplete="off" checked> Show
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-ruler" id="tree-ruler-hide" autocomplete="off"> Hide
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row" title="Would you like to see animations as your tree updates?">
        <div class="col-3">Animation</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-animation" id="tree-animation-on" autocomplete="off" checked> On
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-animation" id="tree-animation-off" autocomplete="off"> Off
            </label>
    </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="tree-branch-configurations" role="tabpanel" aria-labelledby="tree-branch-tab">
      <div class="form-group row" title="What would you like the branches to be shaped like?">
        <div class="col-3">Type</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-mode" id="tree-mode-square" autocomplete="off" checked> Square
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-mode" id="tree-mode-smooth" autocomplete="off"> Smooth
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-mode" id="tree-mode-straight" autocomplete="off"> Straight
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row" title="Would you like to render nodes at the tree's branchpoints?">
        <div class="col-3">Nodes</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-branch-nodes" id="tree-branch-nodes-show" autocomplete="off">
              Show
            </label>
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-branch-nodes" id="tree-branch-nodes-hide" autocomplete="off" checked>
              Hide
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row" title="Would you like to see branch distances written on the Branches?">
        <div class="col-3">Length Labels</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-branch-distances" id="tree-branch-distances-show" autocomplete="off">
              Show
            </label>
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-branch-distances" id="tree-branch-distances-hide" autocomplete="off"
                checked>
              Hide
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row tree-branch-distance-row"
        title="Would you like to round distances in the tree to integers?">
        <div class="col-3">Round Labels</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm active col">
              <input type="radio" name="tree-round" id="tree-round-false" autocomplete="off" checked>
              Unrounded
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-round" id="tree-round-true" autocomplete="off"> Rounded
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row tree-branch-distance-row" title="How big should the branch distance labels be?">
        <div class="col-3">
          <label for="tree-branch-distance-size">Label Size</label>
        </div>
        <div class="col-9">
          <input id="tree-branch-distance-size" type="range" min="1" max="32" value="6" step="1" />
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="tree-leaf-configurations" role="tabpanel" aria-labelledby="tree-leaf-tab">
      <div class="accordion" id="tree-node-controls-accordion">
        <div class="card">
          <div class="card-header p-0">
            <button class="bg-transparent border-0 w-100" type="button" data-toggle="collapse"
              data-target="#tree-node-controls-labels" aria-expanded="true" aria-controls="tree-node-controls-labels"
              style="color:#495057">Labels and Tooltips</button>
          </div>
          <div id="tree-node-controls-labels" class="collapse show" data-parent="#tree-node-controls-accordion">
            <div class="card-body">
      <div class="form-group row tree-leaf-node-row">
        <div class="col-3">
          <label class="form-switch">Tooltip</label>
        </div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-tooltips" id="tree-tooltip-show" autocomplete="off" checked> Show
            </label>
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-tooltips" id="tree-tooltip-hide" autocomplete="off"> Hide
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-3">Labels</div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
            <label class="btn btn-light btn-sm col">
              <input type="radio" name="tree-leaf-labels" id="tree-leaf-label-show" autocomplete="off"> Show
            </label>
            <label class="btn btn-light btn-sm col active">
              <input type="radio" name="tree-leaf-labels" id="tree-leaf-label-hide" autocomplete="off" checked>
              Hide
            </label>
          </div>
        </div>
      </div>
      <div id="tree-leaf-label-size-row" class="form-group row">
        <div class="col-3">
          <label for="tree-leaf-label-size">Label Size</label>
        </div>
        <div class="col-9">
          <input id="tree-leaf-label-size" type="range" min="1" max="32" value="6" step="1" />
        </div>
      </div>
    </div>
  </div>
</div>
        <div class="card">
          <div class="card-header p-0">
            <button class="bg-transparent border-0 w-100" type="button" data-toggle="collapse"
              data-target="#tree-node-controls-geometry" aria-expanded="false"
              aria-controls="tree-node-controls-geometry" style="color:#495057">Shapes and Sizes</button>
          </div>
          <div id="tree-node-controls-geometry" class="collapse" data-parent="#tree-node-controls-accordion">
            <div class="card-body">
              <div class="form-group row">
                <div class="col-3">Nodes</div>
                <div class="col-9">
                  <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                    <label class="btn btn-light btn-sm col active">
                      <input type="radio" name="tree-leaf-nodes" id="tree-leaf-node-show" autocomplete="off" checked>
                      Show
                    </label>
                    <label class="btn btn-light btn-sm col">
                      <input type="radio" name="tree-leaf-nodes" id="tree-leaf-node-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row tree-leaf-node-row">
                <div class="col-3">
                  <label for="tree-leaf-node-size">Node Size</label>
                </div>
                <div class="col-9">
                  <input id="tree-leaf-node-size" type="range" min="1" max="32" value="9" step="1" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header p-0">
            <button class="bg-transparent border-0 w-100 launch-color-options collapsed" type="button"
              data-toggle="collapse" aria-expanded="false" style="color:#495057">Colors</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="tree-context-menu" class="dropdown-menu">
  <a href="#" id="tree-rotate" class="dropdown-item">Rotate</a>
  <a href="#" id="tree-flip" class="dropdown-item">Flip</a>
  <a href="#" id="tree-reroot" class="dropdown-item">Set As Root</a>
</div>

<div id="tree-export-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Export Phylogenetic Tree</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group row">
          <div class="col-9">
            <input type="text" id="tree-export-file-name" class="form-control form-control-sm" placeholder="Filename" />
          </div>
          <div class="col-3">
            <select id="tree-export-file-type" class="form-control form-control-sm">
              <option selected>png</option>
              <option>jpeg</option>
              <option>webp</option>
              <option>svg</option>
              <option>nwk</option>
            </select>
          </div>
        </div>
        <button id="tree-export-advanced-button" class="btn btn-primary btn-sm" type="button" data-toggle="collapse"
          data-target="#tree-export-advanced" aria-expanded="false"
          aria-controls="tree-export-advanced">Advanced</button>
        <div class="collapse" id="tree-export-advanced">
          <div class="card card-body">
            <div class="form-group row">
              <div class="col-3">
                <label for="tree-export-scale">Scale</label>
              </div>
              <div class="col-9">
                <input type="number" id="tree-export-scale" class="form-control form-control-sm" min="0" step="0.1"
                  value="1" />
              </div>
            </div>
            <div class="form-group row">
              <div class="col-3">Resolution</div>
              <div id="tree-export-dimensions" class="col-9 text-right"></div>
            </div>
            <div class="row">
              <div class="col-3">
                <label for="tree-export-quality">Quality</label>
              </div>
              <div class="col-9">
                <input type="range" id="tree-export-quality" min="0" max="1.0" value="0.92" step="0.01"></input>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
        <button type="button" id="tree-export" class="btn btn-primary" data-dismiss="modal">Export</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
  (function () {
    var tree;

    function drawTree() {
      var panel = $('#tree').parent();
      if (!panel.length) return;

      var metric = session.style.widgets['default-distance-metric'];
      if (!temp.trees[metric]) {
        MT.computeTree(metric, drawTree);
        return;
      }

      tree = new TidyTree(temp.trees[metric], {
        parent: '#tree',
        layout:
          session.style.widgets['tree-layout-vertical'] ? 'vertical' :
            session.style.widgets['tree-layout-horizontal'] ? 'horizontal' :
              'circular',
        type: session.style.widgets['tree-type'],
        mode:
          session.style.widgets['tree-mode-square'] ? 'square' :
            session.style.widgets['tree-mode-smooth'] ? 'smooth' :
              'straight',
        animation: 0,
        branchNodes: session.style.widgets['tree-branch-nodes-show'],
        branchDistances: !session.style.widgets['tree-branch-distances-hide'],
        leafNodes: true,
        leafLabels: session.style.widgets['tree-leaf-label-show'],
        margin: [60, 100, 20, 20]
      }, {
          select: select,
          contextmenu: contextMenu,
          showtooltip: tooltip,
          hidetooltip: hideTooltip
        });

      $('#tree').on('click', hideContext);

      redrawTree();
    }

    function redrawTree() {
      var size = session.style.widgets['tree-leaf-node-size'],
        color = session.style.widgets['node-color'],
        ncv = session.style.widgets['node-color-variable'];

      if (ncv === 'None') {
        tree.eachLeafNode(d => d3.select(d).attr('r', size).style('fill', color));
      } else {
        var ncm = temp.style.nodeColorMap;
        tree.eachLeafNode(circle => d3.select(circle).attr('r', size).style('fill', data => {
          var id = data.data.id;
          var match = session.data.nodes.find(node => node.id === id);
          if (match) {
            return ncm(match[ncv]);
          } else {
            return color;
          }
        }));
      }

      tagSelected();
    }

    function select(d) {
      var e = d3.event;
      var n = d[0].data;
      e.preventDefault();
      if (e.ctrlKey) {
        session.data.nodes.find(node => node.id === n.id).selected = !n.selected;
      } else {
        session.data.nodes.forEach(node => {
          if (node.id === n.id) {
            node.selected = !n.selected;
          } else {
            node.selected = false;
          }
        });
      }
      $window.trigger('node-selected');
    }

    function contextMenu(d) {
      var e = d3.event;
      e.preventDefault();
      hideTooltip();
      var menu = d3.select('#tree-context-menu');
      d3.select('#tree-reroot').on('click', function () {
        tree.setData(d[0].data.reroot());
        $('#tree-branch-distance-size').trigger('input');
        menu.style('z-index', -1).style('display', 'none');
      });
      d3.select('#tree-rotate').on('click', function () {
        tree.setData(d[0].data.rotate().getRoot());
        menu.style('z-index', -1).style('display', 'none');
      });
      d3.select('#tree-flip').on('click', function () {
        tree.setData(d[0].data.rotate(true).getRoot());
        menu.style('z-index', -1).style('display', 'none');
      });
      menu
        .style('display', 'block')
        .style('opacity', 1)
        .style('top', e.offsetY + 'px')
        .style('left', e.offsetX + 'px')
        .style('z-index', 1000);
    }

    function hideContext() {
      var menu = d3.select('#tree-context-menu');
      menu
        .transition().duration(100)
        .style('opacity', 0)
        .on('end', () => menu.style('z-index', -1));
    }

    function tooltip(d) {
      if (session.style.widgets['tree-tooltip-show']) {
        var e = d3.event;
        e.preventDefault();
        d3.select('#tooltip')
          .text(d[0].data.id)
          .style('top', e.pageY + 'px')
          .style('left', (e.pageX + 5) + 'px')
          .style('z-index', 1000)
          .style('opacity', 1);
      }
    }

    function hideTooltip() {
      var tooltip = d3.select('#tooltip');
      tooltip
        .transition().duration(100)
        .style('opacity', 0)
        .on('end', () => tooltip.style('z-index', -1));
    }

    $('#toggle-tree-settings').on('click', function () {
      var pane = $('#tree-settings-pane');
      if (pane.is(':visible')) {
        pane.animate({ left: '-400px' }, function () { pane.hide(); });
      } else {
        pane.show(0, function () { pane.animate({ left: '0px' }); });
      }
    });

    $('#tree-type').on('change', function () {
      session.style.widgets['tree-type'] = this.value;
      tree.setType(session.style.widgets['tree-type']);
    });

    $('#tree-layout-vertical').parent().on('click', function () {
      session.style.widgets['tree-layout-vertical'] = true;
      session.style.widgets['tree-layout-horizontal'] = false;
      session.style.widgets['tree-layout-circular'] = false;
      tree.setLayout('vertical').recenter();
      $('.hideForCircular').slideDown();
    });

    $('#tree-layout-horizontal').parent().on('click', function () {
      session.style.widgets['tree-layout-vertical'] = false;
      session.style.widgets['tree-layout-horizontal'] = true;
      session.style.widgets['tree-layout-circular'] = false;
      tree.setLayout('horizontal').recenter();
      $('.hideForCircular').slideDown();
    });

    $('#tree-layout-circular').parent().on('click', function () {
      session.style.widgets['tree-layout-vertical'] = false;
      session.style.widgets['tree-layout-horizontal'] = false;
      session.style.widgets['tree-layout-circular'] = true;
      tree.setLayout('circular').recenter();
      $('.hideForCircular').slideUp();
    });

    $('#tree-vertical-stretch').on('input', function () {
      var val = parseFloat(this.value);
      session.style.widgets['tree-vertical-stretch'] = val;
      var cached = tree.animation;
      tree.setAnimation(0);
      tree.setVStretch(val);
      tree.setAnimation(cached);
    });

    $('#tree-horizontal-stretch').on('input', function () {
      var val = parseFloat(this.value);
      session.style.widgets['tree-horizontal-stretch'] = val;
      var cached = tree.animation;
      tree.setAnimation(0);
      tree.setHStretch(val);
      tree.setAnimation(cached);
    });

    $('#tree-ruler-show').parent().on('click', function () {
      session.style.widgets['tree-ruler-hide'] = false;
      tree.setRuler(true);
    });

    $('#tree-ruler-hide').parent().on('click', function () {
      session.style.widgets['tree-ruler-hide'] = true;
      tree.setRuler(false);
    });

    $('#tree-animation-on').parent().on('click', function () {
      session.style.widgets['tree-animation-on'] = true;
      tree.setAnimation(1200);
    });

    $('#tree-animation-off').parent().on('click', function () {
      session.style.widgets['tree-animation-on'] = false;
      tree.setAnimation(0);
    });

    $('#tree-mode-square').parent().on('click', function () {
      session.style.widgets['tree-mode-square'] = true;
      session.style.widgets['tree-mode-smooth'] = false;
      session.style.widgets['tree-mode-straight'] = false;
      tree.setMode('square');
    });

    $('#tree-mode-smooth').parent().on('click', function () {
      session.style.widgets['tree-mode-square'] = false;
      session.style.widgets['tree-mode-smooth'] = true;
      session.style.widgets['tree-mode-straight'] = false;
      tree.setMode('smooth');
    });

    $('#tree-mode-straight').parent().on('click', function () {
      session.style.widgets['tree-mode-square'] = false;
      session.style.widgets['tree-mode-smooth'] = false;
      session.style.widgets['tree-mode-straight'] = true;
      tree.setMode('straight');
    });

    $('#tree-branch-nodes-show').parent().on('click', function () {
      session.style.widgets['tree-branch-nodes-hide'] = false;
      tree.setBranchNodes(true);
    });

    $('#tree-branch-nodes-hide').parent().on('click', function () {
      session.style.widgets['tree-branch-nodes-hide'] = true;
      tree.setBranchNodes(false);
    });

    $('#tree-branch-distances-show').parent().on('click', function () {
      session.style.widgets['tree-branch-distances-hide'] = false;
      $('.tree-branch-distance-row').slideDown();
      tree.setBranchDistances(true);
    });

    $('#tree-branch-distances-hide').parent().on('click', function () {
      session.style.widgets['tree-branch-distances-hide'] = true;
      $('.tree-branch-distance-row').slideUp();
      tree.setBranchDistances(false);
    });

    $('#tree-round-true').parent().on('click', function () {
      session.style.widgets['tree-round-true'] = true;
      tree.eachBranchDistance(function (label, data) {
        d3.select(label).text(Math.round(data.target.data.length));
      });
    });

    $('#tree-round-false').parent().on('click', function () {
      session.style.widgets['tree-round-true'] = false;
      tree.redraw();
    });

    $('#tree-branch-distance-size').on('input', function () {
      var speed = tree.animation;
      tree.animation = 0;
      var size = parseFloat(this.value);
      session.style.widgets['tree-branch-distance-size'] = size;
      tree.eachBranchDistance(function (label, data) {
        d3.select(label).style('font-size', size + 'px');
      });
      tree.animation = speed;
    });

    $('#tree-leaf-node-show').parent().on('click', function () {
      session.style.widgets['tree-leaf-node-show'] = true;
      $('.tree-leaf-node-row').slideDown();
      tree.setLeafNodes(true);
    });

    $('#tree-leaf-node-hide').parent().on('click', function () {
      session.style.widgets['tree-leaf-node-show'] = false;
      $('.tree-leaf-node-row').slideUp();
      tree.setLeafNodes(false);
    });

    $('#tree-leaf-node-size').on('input', function () {
      var speed = tree.animation;
      tree.animation = 0;
      var size = parseFloat(this.value);
      session.style.widgets['tree-leaf-node-size'] = size;
      tree.eachLeafNode(function (node, data) {
        d3.select(node).attr('r', size);
      });
      tree.animation = speed;
    });

    $('#tree-tooltip-show').parent().on('click', function () {
      session.style.widgets['tree-tooltip-show'] = true;
    });

    $('#tree-tooltip-hide').parent().on('click', function () {
      session.style.widgets['tree-tooltip-show'] = false;
    });

    $('#tree-leaf-label-show').parent().on('click', function () {
      session.style.widgets['tree-leaf-label-show'] = true;
      $('#tree-leaf-label-size-row').slideDown();
      tree.setLeafLabels(true);
    });

    $('#tree-leaf-label-hide').parent().on('click', function () {
      session.style.widgets['tree-leaf-label-show'] = false;
      $('#tree-leaf-label-size-row').slideUp();
      tree.setLeafLabels(false);
    });

    $('#tree-leaf-label-size').on('input', function () {
      var speed = tree.animation;
      tree.animation = 0;
      var size = parseFloat(this.value);
      session.style.widgets['tree-leaf-label-size'] = size;
      tree.eachLeafLabel(function (label, data) {
        d3.select(label).style('font-size', size + 'px');
      });
      tree.animation = speed;
    });

    $('#tree-export-filetype').on('change', function () {
      if (this.value === 'svg' || this.value === 'nwk') {
        $('#tree-export-advanced-button').slideUp();
      } else {
        $('#tree-export-advanced-button').slideDown();
      }
    });

    $('#tree-export-scale').on('input', function () {
      var scale = parseFloat(this.value);
      var wrapper = $('#tree').parent();
      $('#tree-export-dimensions').text(
        Math.round(wrapper.width() * scale) + 'x' +
        Math.round(wrapper.height() * scale) + 'px'
      );
    }).trigger('input');

    $('#tree-export').on('click', function () {
      var filetype = $('#tree-export-file-type').val();
      var filename = $('#tree-export-file-name').val();
      if (filetype === 'nwk') {
        var blob = new Blob([temp.trees[session.style.widgets['default-distance-metric']].toNewick()], { type: 'application/newick;charset=utf-8' });
        saveAs(blob, $('#tree-export-file-name').val() + '.nwk');
      } else if (filetype === 'svg') {
        var blob = new Blob([MT.unparseSVG($('#tree svg')[0])], { type: 'image/svg+xml;charset=utf-8' });
        saveAs(blob, $('#tree-export-file-name').val() + '.svg');
      } else {
        var $root = $('#tree svg');
        var root = $root[0];
        var watermark = d3.select(root).append('text')
          .text('MicrobeTrace')
          .attr('x', $root.width() - 150)
          .attr('y', $root.height() - 20)
          .attr('class', 'watermark');
        saveSvgAsPng(root, filename + '.' + filetype, {
          scale: parseFloat($('#tree-export-scale').val()),
          backgroundColor: session.style.widgets['background-color'],
          encoderType: 'image/' + filetype,
          encoderOptions: parseFloat($('#tree-export-quality').val())
        }).then(() => watermark.remove());
      }
    });

    $('#tree-fitbutton').on('click', function () { tree.recenter(); });

    function tagSelected() {
      tree.eachLeafNode(function (circle, data) {
        var node = session.data.nodes.find(d => d.id === data.data.id);
        if (node.selected) {
          d3.select(circle)
            .style('stroke', session.style.widgets['selected-color'])
            .style('stroke-width', 2);
        } else {
          d3.select(circle)
            .style('stroke', '#ffffff')
            .style('stroke-width', 1);
        }
      });
    }

    $window
      .on('node-selected', tagSelected)
      .on('node-color-change', redrawTree)
      .on('background-color-change', function () {
        $('#tree svg').parent().css('background-color', session.style.widgets['background-color']);
      });

    $('#tree svg').parent().css('background-color', session.style.widgets['background-color']);

    layout.on('stateChanged', function () {
      if ($('#tree').length) {
        setTimeout(function () {
          redrawTree();
          var wrapper = $('#tree').parent();
          $('#tree-export-width').val(wrapper.width());
          $('#tree-export-height').val(wrapper.height());
        }, 200);
      }
    });

    drawTree();
  })();
</script>
