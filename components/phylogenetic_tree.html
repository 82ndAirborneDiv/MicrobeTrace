  <div id="phylogenetic_tree_panel"></div>

  <div class="view_controls">
    <button id="toggle_tree_settings" type="button" class="btn btn-light btn-sm">
      <span class="oi oi-cog"></span>
    </button>
    <button type="button" class="btn btn-light btn-sm"  data-toggle="modal" data-target="#export_tree_modal" title="Export Tree">
      <span class="oi oi-data-transfer-download"></span>
    </button>
  </div>

  <div id="tree_settings_pane" class="left_pane">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item active">
        <a href="#phylogeneticTreeConfigurations" id="phylogeneticTree-tab" class="nav-link active" aria-controls="phylogeneticTree" role="tab" data-toggle="tab">Phylogenetic Tree</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="phylogeneticTreeConfigurations" role="tabpanel" aria-labelledby="phylogeneticTree-tab">
        <div class="form-group row">
          <div class="col-3">Distance Metric</div>
          <div class="col-9">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-secondary btn-sm active">
                <input type="radio" name="tree_distanceMetric" data-value="tn93" autocomplete="off" checked> TN93
              </label>
              <label class="btn btn-secondary btn-sm">
                <input type="radio" name="tree_distanceMetric" data-value="snps" autocomplete="off"> SNPs
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Layout</div>
          <div class="col-9">
            <select id="tree_layout" class="custom-select custom-select-sm">
              <option checked>Rectangular</option>
              <option>Diagonal</option>
              <option>Hierarchical</option>
              <option>Circular</option>
              <option>Radial</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Labels</div>
          <div class="col-9">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-secondary btn-sm">
                <input type="radio" name="tree_labels" id="tree_labels_align" autocomplete="off"> Align
              </label>
              <label class="btn btn-secondary btn-sm">
                <input type="radio" name="tree_labels" id="tree_labels_show" autocomplete="off"> Show
              </label>
              <label class="btn btn-secondary btn-sm active">
                <input type="radio" name="tree_labels" id="tree_labels_hide" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Text Size</div>
          <div class="col-9"><input type="range" id="tree_font-size-slider" min="6" value="10" max="24" step="1" /></div>
        </div>
        <div class="form-group row">
          <div class="col-3">Node Radius</div>
          <div class="col-9"><input type="range" id="tree_node-size-slider" min="1" value="4" max="36" step="1" /></div>
        </div>
      </div>
    </div>
  </div>

  <div id="export_tree_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export SVG</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="tree_export-img-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select id="tree_export-img-file-type" class="form-control form-control-sm">
                <option selected>png</option>
                <option>nwk</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="tree_export" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
  (function(){
    let phylocanvas;

    function redrawTree(){
      if(!$('#phylogenetic_tree_panel').length) return;
      let typeSelector = $('input[type="radio"][name="tree_distanceMetric"]');
      let type = typeSelector.filter(':checked').data('value');

      if(!session.data.trees[type]){
        let RNJ = new RapidNeighborJoining(session.data.distance_matrix[type], session.data.distance_matrix.labels.map(function(l){
          return {
            'name': l,
            'genotype': l
          }
        }));
        RNJ.run();
        session.data.trees[type] = RNJ.getAsNewick();
      }

      let root = $('#phylogenetic_tree_panel').empty();

      phylocanvas = new Phylocanvas.Tree(root[0], {
        hoverLabel: true,
        showLabels: !$('#tree_labels_hide').is(':checked'),
        alignLabels: $('#tree_labels_align').is(':checked'),
        selectedColour: 'rgb(255,130,21)',
        backColour: false,
        branchColour: session.style.widgets['node-color']
      });
      phylocanvas.load(session.data.trees[type]); // load your tree file
      let parent = root.parent();
      phylocanvas.setSize(parent.width(), parent.height());
      phylocanvas.setTreeType($('#tree_layout').val().toLowerCase());
      phylocanvas.fitInPanel();

      phylocanvas.on('updated', function(e){
        session.data.nodes.forEach(function(node){
          node.selected = e.nodeIds.includes(node.id);
        });
        $(window).trigger('node_selected');
      });
    }

    $('#toggle_tree_settings').click(function(){
      let pane = $('#tree_settings_pane');
      if(pane.is(':visible')){
        pane.animate({left: '-400px'}, function(){ pane.hide(); });
      } else {
        pane.show(0, function(){ pane.animate({left: '0px'}); });
      }
    });

    $('[name="tree_distanceMetric"]').change(function(){
      redrawTree();
      phylocanvas.draw();
    });

    $('#tree_layout').change(e => {
      phylocanvas.setTreeType(e.target.value.toLowerCase());
      phylocanvas.fitInPanel();
    });

    $('#tree_font-size-slider').on('input', e => {
      phylocanvas.setTextSize(e.target.value);
    });

    $('#tree_node-size-slider').on('input', e => {
      phylocanvas.setNodeSize(e.target.value);
    });

    $('#tree_labels_align').parent().click(e => {
      phylocanvas.showLabels = true;
      phylocanvas.alignLabels = true;
      phylocanvas.draw();
    });

    $('#tree_labels_show').parent().click(e => {
      phylocanvas.showLabels = true;
      phylocanvas.alignLabels = false;
      phylocanvas.draw();
    });

    $('#tree_labels_hide').parent().click(e => {
      phylocanvas.showLabels = false;
      phylocanvas.draw();
    });

    $('#tree_export').click(e => {
      let type = $('#tree_export-img-file-type').val();
      if(type === 'png'){
        $('#phylogenetic_tree_panel canvas')[0].toBlob(function(blob) {
          saveAs(blob, $('#tree_export-img-file-name').val() + '.png');
        });
      } else if(type === 'nwk'){
        let blob = new Blob([session.data.trees[$('[name="tree_distanceMetric"]:checked').data('value')]], {type: "application/newick;charset=utf-8"});
        saveAs(blob, $('#tree_export-img-file-name').val() + '.nwk');
      }
    });

    $(window)
      .on('node-color-change', e => {
        phylocanvas.branchColour = session.style.widgets['node-color'];
        phylocanvas.draw();
      })
      .on('node_selected', function(e){
        session.data.nodes.filter(d => d.selected).forEach(node => {
          phylocanvas.branches[node.id].selected = true;
        });
        phylocanvas.draw();
      });

    layout.on('stateChanged', redrawTree);
    setTimeout(redrawTree, 80);
  })();
  </script>
