<svg id="network"></svg>

<button type="button" class="view_settings_button btn btn-light" data-toggle="modal" data-target="#2d_network_settings_modal">
  <span class="oi oi-cog"></span>
</button>

<table id="groupKey"></table>

<span id="tooltip"></span>

<ul id="contextmenu" class="dropdown-menu">
  <li><a href="#" id="viewAttributes">View Attributes</a></li>
  <li><a href="#" id="copyID">Copy ID</a></li>
  <li class="showForSequence"><a href="#" id="copySeq">Copy Sequence</a></li>
  <li><a href="#" id="pinNode">Pin Node</a></li>
  <li role="separator" class="divider"></li>
  <li><a href="#" id="isolateCluster">Isolate Cluster</a></li>
  <li><a href="#" id="hideCluster">Hide Cluster</a></li>
</ul>

<div id="attributeModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header"><h4 class="modal-title">Node Attributes</h4></div>
      <div class="modal-body" style="overflow: auto">
        <table class="table table-striped">
          <tbody></tbody>
        </table>
      </div>
      <div class="panel-footer clearfix">
        <button type="submit" class="btn btn-primary pull-right" data-dismiss="modal" title="">OK</button>
      </div>
    </div>
  </div>
</div>

<div id="playtools">
  <div class="btn-group" role="group">
    <button id="playbutton" type="button" class="btn btn-default">
      <span class="oi oi-media-play"></span>
    </button>
  </div>
</div>

<table id="networkStatistics">
  <tbody>
    <tr>
      <td class="text-right">
        <span id="numberOfNodes"></span>
        (<span id="numberOfSelectedNodes"></span>)
      </td>
      <td>Nodes (Selected)</td>
    </tr>
    <tr>
      <td id="numberOfVisibleLinks" class="text-right"></td>
      <td>Links</td>
    </tr>
    <tr>
      <td id="numberOfDisjointComponents" class="text-right"></td>
      <td>Clusters</td>
    </tr>
    <tr id="singletonsRow">
      <td id="numberOfSingletonNodes" class="text-right"></td>
      <td>Singletons</td>
    </tr>
  </tbody>
</table>

<div id="2d_network_settings_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Network Configuration</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Profile</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Contact</a>
            </li>
          </ul>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
              <div class="form-group row">
                <div class="col-3"><strong>Property</strong></div>
                <div class="col-3"><strong>Variable</strong></div>
                <div class="col-6"><strong>Value</strong></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="default-node-symbol" data-toggle="tooltip" title="What shape should the nodes be?">Shape</label></div>
                <div class="col-3"><select id="nodeSymbolVariable" class="custom-select custom-select-sm nodeVariables categorical"><option value="none">None</option></select></div>
                <div class="col-6"><select id="default-node-symbol" class="custom-select custom-select-sm">
                  <option value="symbolCircle" selected>&nbsp;&#11044; (Circle)</option>
                  <option value="symbolTriangle">&nbsp;&#9650; (Up Triangle)</option>
                  <option value="symbolTriangleDown">&nbsp;&#9660; (Down Triangle)</option>
                  <option value="symbolTriangleLeft">&nbsp;&#9664; (Left Triangle)</option>
                  <option value="symbolTriangleRight">&nbsp;&#9654; (Right Triangle)</option>
                  <option value="symbolDiamond">&nbsp;&#10731; (Vertical Diamond)</option>
                  <option value="symbolDiamondAlt">&nbsp;&#10731; (Horizontal Diamond)</option>
                  <option value="symbolSquare">&nbsp;&#9632; (Square)</option>
                  <option value="symbolDiamondSquare">&nbsp;&#9670; (Tilted Square)</option>
                  <option value="symbolPentagon">&nbsp;&#11039; (Pentagon)</option>
                  <option value="symbolHexagon">&nbsp;&#11042; (Hexagon)</option>
                  <option value="symbolHexagonAlt">&nbsp;&#11043; (Tilted Hexagon)</option>
                  <option value="symbolOctagon">&nbsp;&#11204; (Octagon)</option>
                  <option value="symbolOctagonAlt">&nbsp;&#11203; (Tilted Octagon)</option>
                  <option value="symbolCross">&nbsp;&#10010; (Addition Sign)</option>
                  <option value="symbolX">&nbsp;&#10006; (Multiplication Sign)</option>
                  <option value="symbolWye">&nbsp;&#120300; (Wye)</option>
                  <option value="symbolStar">&nbsp;&#9733; (Star)</option>
                </select></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="nodeLabelVariable" data-toggle="tooltip" title="What field should be displayed as a label for the node?">Label</label></div>
                <div class="col-3"><select id="nodeLabelVariable" class="custom-select custom-select-sm nodeVariables categorical"><option value="none">None</option></select></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="nodeTooltipVariable" data-toggle="tooltip" title="What node data should be displayed as a tooltip for the node?">Tooltip</label></div>
                <div class="col-3"><select id="nodeTooltipVariable" class="custom-select custom-select-sm nodeVariables categorical"><option value="none">None</option></select></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="default-node-color" data-toggle="tooltip" title="What color should the nodes be?">Color</label></div>
                <div class="col-3"><select id="nodeColorVariable" class="custom-select custom-select-sm nodeVariables categorical"><option value="none">None</option></select></div>
                <div class="col-6"><input type="color" id="default-node-color" value="#5656ff" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="default-node-opacity" data-toggle="tooltip" title="How transparent should the nodes be?">Transparency</label></div>
                <div class="col-3"><select id="nodeOpacityVariable" class="custom-select custom-select-sm nodeVariables numeric"><option value="none">None</option></select></div>
                <div class="col-6"><input type="range" id="default-node-opacity" min="0" max="1" value="1" step="0.01" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="default-node-radius" data-toggle="tooltip" title="How large should the nodes be?">Size</label></div>
                <div class="col-3"><select id="nodeRadiusVariable" class="custom-select custom-select-sm nodeVariables numeric"><option value="none">None</option></select></div>
                <div class="col-6"><input type="range" id="default-node-radius" min="1" value="250" step="1" max="5000" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3">Singletons</div>
                <div class="col-6 .col-offset-3">
                  <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input type="radio" name="singletons" id="ShowSingletons" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-default">
                      <input type="radio" name="singletons" id="HideSingletons" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <div class="form-group row">
                <div class="col-3"><strong>Property</strong></div>
                <div class="col-3"><strong>Variable</strong></div>
                <div class="col-6"><strong>Value</strong></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label for="linkSortVariable" data-toggle="tooltip" title="By what variable would you like to prune links from the network?">Pruning</label></div>
                <div class="col-3"><select id="linkSortVariable" class="custom-select custom-select-sm linkVariables numeric"><option value="distance">Distance</option></select></div>
                <div class="col-6"><label data-toggle="tooltip" title="What's the maximum genetic distance you're willing to call a link?"><input type="number" class="" id="default-link-threshold" value="0.015" step="0.001" /></label>
                  <button id="computeMST" class="btn btn-default btn-xs showForNotMST">Compute MST</button>
                  <div class="btn-group btn-group-toggle btn-group-sm showForMST" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input type="radio" name="MSTOptions" id="showAllLinks" autocomplete="off" checked> All
                    </label>
                    <label class="btn btn-default">
                      <input type="radio" name="MSTOptions" id="showMSTLinks" autocomplete="off"> MST
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="Are these links directed?">Directionality</label></div>
                <div class="col-3"></div>
                <div class="col-6">
                  <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input type="radio" name="DirectionOptions" id="UndirectedLinks" autocomplete="off" checked> Undirected
                    </label>
                    <label class="btn btn-default">
                      <input type="radio" name="DirectionOptions" id="DirectedLinks" autocomplete="off"> Directed
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="What data should be displayed when you hover over a link?">Tooltip</label></div>
                <div class="col-3"><select id="linkTooltipVariable" class="custom-select custom-select-sm linkVariables"><option value="none">None</option></select></div>
                <div class="col-6"></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="What color should the links be?">Color</label></div>
                <div class="col-3"><select id="linkColorVariable" class="custom-select custom-select-sm linkVariables"><option value="none" selected>None</option></select></div>
                <div class="col-6"><input type="color" id="default-link-color" value="#6f6f6f" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How transparent should the links be?">Transparency</label></div>
                <div class="col-3"><select id="linkOpacityVariable" class="custom-select custom-select-sm linkVariables"><option value="none">None</option></select></div>
                <div class="col-6"><input type="range" id="default-link-opacity" min="0" max="1" value="0.5" step="0.01" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How wide should the links be?">Thickness</label></div>
                <div class="col-3">
                  <select id="linkWidthVariable" class="custom-select custom-select-sm linkVariables"><option value="none">None</option></select><br />
                  <input type="checkbox" id="reciprocal-link-width" />&nbsp;<label data-toggle="tooltip" title="Should link widths be proportioned to the reciprocal of this variable?">Reciprocal?</label>
                </div>
                <div class="col-6"><input type="range" id="default-link-width" min="0.3" max="30" step=".3" value="3" /></div>
              </div>
            </div>
            <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
              <div class="form-group row">
                <div class="col-3"><strong>Property</strong></div>
                <div class="col-9"><strong>Value</strong></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="Display a table of overview statistics for the network">Statistics</label></div>
                <div class="col-9">
                  <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input type="radio" name="networkStatisticsOptions" id="showNetworkStatistics" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-default">
                      <input type="radio" name="networkStatisticsOptions" id="hideNetworkStatistics" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How quickly should moving nodes lose their momentum?">Friction</label></div>
                <div class="col-9"><input type="range" id="network-friction" min="0" max="1" value="0.4" step="0.025" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How long should links be?">Length</label></div>
                <div class="col-9"><input type="range" id="default-link-length" min = "0" max="200" value="50" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How attractive is the mass of the graph?">Gravity</label></div>
                <div class="col-9"><input type="range" id="network-gravity" min="0.025" max="1" value="0.05" step="0.025" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="How strongly are the nodes repulsed by each other?">Charge</label></div>
                <div class="col-9"><input type="range" id="default-node-charge" min="0" max="400" value="200" /></div>
              </div>
              <div class="form-group row">
                <div class="col-3"><label data-toggle="tooltip" title="What color should the background be?">Background</label></div>
                <div class="col-9"><input type="color" id="network-color" value="#ffffff" /></div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <div class="btn-group" data-toggle="buttons">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript" src="node_modules/d3/build/d3.min.js"></script>
<script type="text/javascript" src="node_modules/d3-force-attract/dist/d3-force-attract.min.js"></script>
<script type="text/javascript" src="node_modules/d3-symbol-extra/build/d3-symbol-extra.min.js"></script>
<script type="text/javascript" src="vendor/3d-force-graph.min.js"></script>

<script>
$('.nodeVariables').html(
  '<option value="none">None</option>\n' +
  session.data.nodeFields.map(key =>
    `<option value="${key}">${app.titleize(key)}</option>`
  ).join('\n')
);
$('#nodeTooltipVariable').val('id');

$('.linkVariables').html(
  '<option value="none">None</option>\n' +
  session.data.linkFields.map(key =>
    `<option value="${key}">${app.titleize(key)}</option>`
  ).join('\n')
);
$('#linkSortVariable').val('tn93');

$('#default-link-threshold').show();
app.tagClusters();
setNodeVisibility();
setLinkVisibility();
setupNetwork();
renderNetwork();
app.computeDegree();
session.state.visible_clusters = session.data.clusters.map(c => c.id);
updateStatistics();
setTimeout(e => {
  session.network.fit();
  $('#loadingInformationModal').modal('hide');
}, 1500);

var messageTimeout;

function setNodeVisibility(){
  session.data.nodes.forEach(n => n.visible = 1);
  if(session.state.visible_clusters.length < session.data.clusters.length){
    session.data.nodes.forEach(n => n.visible = n.visible && session.state.visible_clusters.includes(n.cluster));
  }
  if($('#HideSingletons').is(':checked')){
    let clusters = session.data.clusters.map(c => c.nodes);
    session.data.nodes.forEach(n => n.visible = n.visible && clusters[n.cluster-1] > 1);
  }
}

function setLinkVisibility(){
  let metric  = $('#linkSortVariable').val(),
      threshold = $('#default-link-threshold').val();
  session.data.links.forEach(link => link.visible = 1);
  if(metric !== 'none'){
    session.data.links.forEach(link => link.visible = link.visible && (link[metric] <= threshold));
  }
  if($('#showMSTLinks').is(':checked')){
    session.data.links.forEach(link => link.visible = link.visible && link.mst);
  }
  if(session.state.visible_clusters.length < session.data.clusters.length){
    session.data.links.forEach(link => link.visible = link.visible && session.state.visible_clusters.includes(link.cluster));
  }
}

function setupNetwork(){
  session.network = {};
  let width = $(window).width(),
      height = $(window).height(),
      xScale = d3.scaleLinear().domain([0, width]).range([0, width]),
      yScale = d3.scaleLinear().domain([0, height]).range([0, height]);

  session.network.zoom = d3.zoom().on('zoom', () => session.network.svg.attr('transform', d3.event.transform));

  session.network.svg = d3.select('svg')
    .on('click', hideContextMenu)
    .html('') //Let's make sure the canvas is blank.
    .call(session.network.zoom)
    .append('g');

  session.network.fit = function(bounds){
    if(!bounds) bounds = session.network.svg.node().getBBox();
    if (bounds.width == 0 || bounds.height == 0) return; // nothing to fit
    let parent = session.network.svg.node().parentElement,
        midX = bounds.x + bounds.width / 2,
        midY = bounds.y + bounds.height / 2;
    let scale = 0.95 / Math.max(bounds.width / parent.clientWidth, bounds.height / parent.clientHeight);
    d3.select('svg')
      .transition()
      .duration(750)
      .call(session.network.zoom.transform, d3.zoomIdentity
        .translate(parent.clientWidth / 2 - scale * midX, parent.clientHeight / 2 - scale * midY)
        .scale(scale));
  };

  session.network.force = d3.forceSimulation()
    .force('link', d3.forceLink()
      .id(d => d.id)
      .distance($('#default-link-length').val())
      .strength(0.125)
    )
    .force('charge', d3.forceManyBody()
      .strength(-$('#default-node-charge').val())
    )
    .force('gravity', d3.forceAttract()
      .target([width/2, height/2])
      .strength($('#network-gravity').val())
    )
    .force('center', d3.forceCenter(width / 2, height / 2));

  session.network.force.on('end', e => {
    $('#playbutton').data('state', 'paused').html('<span class="oi oi-media-pause"></span>');
  });

  session.network.svg.append('svg:defs').append('marker')
    .attr('id', 'end-arrow')
    .attr('viewBox', '0 0 10 10')
    .attr('refX', 20)
    .attr('refY', 5)
    .attr('markerWidth', 4)
    .attr('markerHeight', 4)
    .attr('orient', 'auto')
    .append('svg:path')
      .attr('d', 'M0,0 L0,10 L10,5 z');

  session.network.svg.append('g').attr('id', 'links');
  session.network.svg.append('g').attr('id', 'nodes');
}

function getVLinks(){
  let vlinks = _.cloneDeep(session.data.links.filter(link => link.visible));
  // vlinks.forEach(l => {
  //   l.source = session.data.nodes.find(d => d.id === l.source),
  //   l.target = session.data.nodes.find(d => d.id === l.target)
  // });
  return vlinks;
}

function renderNetwork(){
  let vnodes = session.data.nodes.filter(node => node.visible);

  //OK, this is a little bit of expert-level D3 voodoo that deserves some explanation.
  let node = d3.select('g#nodes').selectAll('g.node').data(vnodes);
  node.exit().remove(); //Removing nodes with no representation in the dataset.
  node = node.enter().append('g').attr('class', 'node').attr('tabindex', '0') //Adding nodes that weren't represented in the dataset before.
    .call(d3.drag() //A bunch of mouse handlers.
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended))
    .on('mouseenter focusin', showNodeToolTip)
    .on('mouseout focusout', hideTooltip)
    .on('contextmenu', showContextMenu)
    .on('click', clickHandler)
    .on('keydown', n => {
      if(d3.event.code === 'Space') clickHandler(n);
      if(d3.event.shiftKey && d3.event.key === 'F10') showContextMenu(n);
    });

  // What's this?
  node.append('path'); // Adding a path?
  node.append('text'); // And a text? Wouldn't those already be attached to the nodes?
  // Well, they would for nodes that already existed. The wouldn't for new nodes.
  // And until we merge the old and new nodes, `node` refers only to the *added* nodes.
  // Speaking of merging...
  node = node.merge(node);
  // E voila! node now refers to all the g.node elements in the network,
  // and they all have path and text elements, so we can confidently...
  node.select('path').attr('fill', $('#default-node-color').val());
  // And style them according to the DOM State instructions.
  redrawNodes();
  // And append our label text, too!
  node.select('text')
    .attr('dy', 5)
    .attr('dx', 8);

  let vlinks = getVLinks();

  // Links are considerably simpler.
  let link = d3.select('g#links').selectAll('line').data(vlinks);
  link.exit().remove();
  link.enter().append('line')
    .attr('stroke', $('#default-link-color').val())
    .attr('stroke-width', $('#default-link-width').val())
    .attr('opacity', $('#default-link-opacity').val())
    .on('mouseenter', showLinkToolTip)
    .on('mouseout', hideTooltip);

  setLinkColor();
  scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width');

  var nodes = d3.select('g#nodes').selectAll('g.node').data(vnodes);
  var links = d3.select('g#links').selectAll('line').data(vlinks);
  session.network.force.nodes(vnodes).on('tick', function(){
    nodes
      .attr('transform', d => d.fixed ? `translate(${d.fx}, ${d.fy})` : `translate(${d.x}, ${d.y})`);
    links
      .attr('x1', l => l.source.x)
      .attr('y1', l => l.source.y)
      .attr('x2', l => l.target.x)
      .attr('y2', l => l.target.y);
  });

  session.network.force.force('link').links(vlinks);
}

function dragstarted(d){
  if (!d3.event.active) session.network.force.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d){
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d){
  if (!d3.event.active) session.network.force.alphaTarget(0);
  if(!d.fixed){
    d.fx = null;
    d.fy = null;
  }
}

function clickHandler(n){
  if(!d3.event.shiftKey){
    session.data.nodes
      .filter(node => node !== n)
      .forEach(node => node.selected = 0);
  }
  n.selected = !n.selected;
  d3.select('g#nodes').selectAll('g.node').data(session.data.nodes).select('path').classed('selected', d => d.selected);
  $('#numberOfSelectedNodes').text(session.data.nodes.filter(d => d.selected).length.toLocaleString());
}

new Clipboard('#copyID, #copySeq');

function showContextMenu(d){
  d3.event.preventDefault();
  hideTooltip();
  $('#copyID').attr('data-clipboard-text', d.id);
  $('#copySeq').attr('data-clipboard-text', d.seq);
  d3.select('#viewAttributes').on('click', e => {
    showAttributeModal(d);
  }).node().focus();
  if(d.fixed){
    $('#pinNode').text('Unpin Node').click(e => {
      d.fx = null;
      d.fy = null;
      d.fixed = false;
      session.network.force.alpha(0.3).alphaTarget(0).restart();
      hideContextMenu();
    });
  } else {
    $('#pinNode').text('Pin Node').click(e => {
      d.fx = d.x;
      d.fy = d.y;
      d.fixed = true;
      hideContextMenu();
    });
  }
  $('#hideCluster').click(e => {
    session.state.visible_clusters = session.state.visible_clusters.filter(cid => cid !== d.cluster);
    setLinkVisibility();
    setNodeVisibility();
    renderNetwork();
    session.network.force.alpha(0.3).alphaTarget(0).restart();
    hideContextMenu();
  });
  if(session.state.visible_clusters < session.data.clusters.length){
    $('#isolateCluster').text('De-isolate Cluster').click(e => {
      session.state.visible_clusters = session.data.clusters.map(c => c.id);
      setNodeVisibility();
      setLinkVisibility();
      renderNetwork();
      session.network.force.alpha(0.3).alphaTarget(0).restart();
      hideContextMenu();
    });
  } else {
    $('#isolateCluster').text('Isolate Cluster').click(e => {
      session.state.visible_clusters = [d.cluster];
      setLinkVisibility();
      setNodeVisibility();
      renderNetwork();
      session.network.force.alpha(0.3).alphaTarget(0).restart();
      hideContextMenu();
    });
  }
  d3.select('#contextmenu')
    .style('z-index', 1)
    .style('left', (d3.event.pageX) + 'px')
    .style('top', (d3.event.pageY) + 'px')
    .style('opacity', 1);
}

function hideContextMenu(){
  let menu = d3.select('#contextmenu');
  menu
    .transition().duration(100)
    .style('opacity', 0)
    .on('end', () =>  menu.style('z-index', -1));
}

function showAttributeModal(d){
  let target = $('#attributeModal tbody').empty();
  for(var attribute in d){
    target.append(`<tr><td><strong>${attribute}</strong></td><td>${d[attribute]}</td></tr>`);
  }
  $('#attributeModal').modal('show');
  hideContextMenu();
}

function showNodeToolTip(d){
  if($('#nodeTooltipVariable').val() === 'none') return;
  d3.select('#tooltip')
    .html(d[$('#nodeTooltipVariable').val()])
    .style('left', (d3.event.pageX + 8) + 'px')
    .style('top', (d3.event.pageY - 28) + 'px')
    .style('z-index', 1000)
    .transition().duration(100)
    .style('opacity', 1);
}

function showLinkToolTip(d){
  let v = $('#linkTooltipVariable').val();
  if(v === 'none') return;
  d3.select('#tooltip')
    .html((v === 'source' || v === 'target') ? d[v].id : d[v])
    .style('left', (d3.event.pageX + 8) + 'px')
    .style('top', (d3.event.pageY - 28) + 'px')
    .style('z-index', 1000)
    .transition().duration(100)
    .style('opacity', 1);
}

function hideTooltip(){
  let tooltip = d3.select('#tooltip');
  tooltip
    .transition().duration(100)
    .style('opacity', 0)
    .on('end', () => tooltip.style('z-index', -1));
}

function redrawNodes(){
  //Things to track in the function:
  //* Symbols:
  let type = d3[$('#default-node-symbol').val()];
  let symbolVariable = $('#nodeSymbolVariable').val();
  let o = (b => d3[$('#default-node-symbol').val()]);
  if(symbolVariable !== 'none'){
    let map = {};
    let values = _(session.data.nodes).map(symbolVariable).uniq().sort().value();
    $('#nodeShapes select').each(function(i, el){
      map[values[i]] = $(this).val();
    });
    o = (v => map[v]);
  }
  //* Sizes:
  let defaultSize = $('#default-node-radius').val();
  let size = defaultSize;
  let sizeVariable = $('#nodeRadiusVariable').val();
  if(sizeVariable !== 'none'){
    let values = _(session.data.nodes).map(sizeVariable).without(undefined);
    var min = values.min();
    var max = values.max();
    var oldrng = max - min;
    var med = oldrng / 2;
  }
  let vnodes = session.data.nodes.filter(n => n.visible);
  let nodes = session.network.svg.select('g#nodes').selectAll('g.node').data(vnodes);
  nodes.select('path').each(function(d){
    if(symbolVariable !== 'none'){
      type = d3[o(d[$('#nodeSymbolVariable').val()])];
    }
    if(sizeVariable !== 'none'){
      size = med;
      if(typeof d[sizeVariable] !== 'undefined'){
        size = d[sizeVariable];
      }
      size = (size - min + 1) / oldrng
      size = size * size * defaultSize;
    }
    d3.select(this).attr('d', d3.symbol()
      .size(size)
      .type(type));
  });
  //* Labels:
  let labelVar = $('#nodeLabelVariable').val();
  nodes.select('text').text(n => n[labelVar]);
}

function updateStatistics(){
  if($('#hideNetworkStatistics').is(':checked')) return;
  let llinks = _.filter(session.data.links, e => e.visible);
  let lnodes = _.filter(session.data.nodes, e => e.visible);
  let singletons = lnodes.length - _.union(_.map(llinks, 'source'), _.map(llinks, 'target')).length;
  $('#numberOfSelectedNodes').text(lnodes.filter(d => d.selected).length.toLocaleString());
  $('#numberOfNodes').text(lnodes.length.toLocaleString());
  $('#numberOfVisibleLinks').text(llinks.length.toLocaleString());
  $('#numberOfSingletonNodes').text(singletons.toLocaleString());
  $('#numberOfDisjointComponents').text(session.data.clusters.length - singletons);
}

$('#nodeLabelVariable').change(e => {
  if(e.target.value === 'none'){
    session.network.svg.select('g#nodes').selectAll('g.node')
      .select('text').text('');
  } else {
    session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes.filter(n => n.visible))
      .select('text').text(d => d[e.target.value]);
  }
});

$('#default-node-symbol').on('input', redrawNodes);
$('#nodeSymbolVariable').change(e => {
  $('#default-node-symbol').fadeOut();
  $('#nodeShapes').fadeOut(function(){$(this).remove()});
  let table = $('<tbody id="nodeShapes"></tbody>').appendTo('#groupKey');
  if(e.target.value === 'none'){
    redrawNodes();
    $('#default-node-symbol').fadeIn();
    return table.fadeOut(e => table.remove());
  }
  table.append('<tr><th>'+e.target.value+'</th><th>Shape</th><tr>');
  let values = _(session.data.nodes).map(e.target.value).uniq().sort().value();
  let symbolKeys = ['symbolCircle', 'symbolCross', 'symbolDiamond', 'symbolSquare', 'symbolStar', 'symbolTriangle', 'symbolWye'].concat(Object.keys(extraSymbols));
  let o = d3.scaleOrdinal(symbolKeys).domain(values);
  let options = $('#default-node-symbol').html();
  values.forEach(v => {
    let selector = $('<select></select>').append(options).val(o(v)).change(redrawNodes);
    let cell = $('<td></td>').append(selector);
    let row = $('<tr><td>' + v + '</td></tr>').append(cell);
    table.append(row);
  });
  redrawNodes();
  table.fadeIn();
});

$('#default-node-radius').on('input', redrawNodes);
$('#nodeRadiusVariable').change(redrawNodes);

function scaleNodeOpacity(){
  let scalar = $('#default-node-opacity').val();
  let variable = $('#nodeOpacityVariable').val();
  let circles = session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes).select('path');
  if(variable === 'none'){
    return circles.attr('opacity', scalar);
  }
  let values = _(session.data.nodes).map(variable).without(undefined);
  let min = values.min();
  let max = values.max();
  let rng = max - min;
  let med = rng / 2 + min;
  circles.attr('opacity', d => {
    let v = d[variable];
    if(typeof v === 'undefined') v = med;
    return scalar * (v - min) / rng + 0.1;
  });
}

$('#default-node-opacity').on('input', scaleNodeOpacity);
$('#nodeOpacityVariable').change(scaleNodeOpacity);

$('#default-node-color').on('input', e => session.network.svg.select('g#nodes').selectAll('g.node').select('path').attr('fill', e.target.value));
$('#nodeColorVariable').change(e => {
  $('#default-node-color').fadeOut();
  let circles = session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes).select('path');
  $('#nodeColors').fadeOut(function(){$(this).remove()});
  let table = $('<tbody id="nodeColors"></tbody>').appendTo('#groupKey');
  if(e.target.value == 'none'){
    circles.attr('fill', $('#default-node-color').val());
    $('#default-node-color').fadeIn();
    table.fadeOut();
    return;
  }
  table.append('<tr><th>'+e.target.value+'</th><th>Color</th><tr>');
  let values = _.map(session.data.nodes, e.target.value);
  let colors = $.getJSON('components/colors.json');
  let o = d3.scaleOrdinal(colors).domain(values);
  circles.attr('fill', d => o(d[e.target.value]));
  values.forEach(value => {
    let input = $('<input type="color" value="'+o(value)+'" />')
      .on('input', evt => {
        circles
          .filter(d => d[e.target.value] == value)
          .attr('fill', d => evt.target.value);
      });
    let cell = $('<td></td>').append(input);
    let row = $('<tr><td>'+value+'</td></tr>').append(cell);
    table.append(row);
  });
  table.fadeIn();
});

$('#default-node-charge').on('input', e => {
  session.network.force.force('charge').strength(-e.target.value);
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

$('#DirectedLinks').parent().click(e => {
  session.network.svg.select('g#links').selectAll('line').attr('marker-end', 'url(#end-arrow)');
});

$('#UndirectedLinks').parent().click(e => {
  session.network.svg.select('g#links').selectAll('line').attr('marker-end', null);
});

$('#default-link-length').on('input', e => {
  session.network.force.force('link').distance(e.target.value);
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

function setLinkColor(e){
  let variable = $('#linkColorVariable').val();
  if(variable == 'none'){
    session.network.svg.select('g#links').selectAll('line').style('stroke', $('#default-link-color').val());
    $('#default-link-color').fadeIn();
    $('#linkColors').fadeOut();
    return;
  }
  $('#default-link-color').fadeOut();
  let links = session.network.svg.select('g#links').selectAll('line').data(session.data.links.filter(l => l.visible));
  $('#linkColors').remove();
  let table = $('<tbody id="linkColors"></tbody>').appendTo('#groupKey');
  table.append('<tr><th>'+variable+'</th><th>Color</th><tr>');
  let values = _(session.data.links).map(variable).uniq().sort().value();
  let colors = $.getJSON('components/colors.json');
  let o = d3.scaleOrdinal(colors).domain(values);
  links.style('stroke', d => o(d[variable]));
  values.forEach(value => {
    let input = $('<input type="color" name="'+value+'-node-color-setter" value="'+o(value)+'" />')
      .on('input', evt => {
        links
          .filter(d => d[variable] === value)
          .style('stroke', d => evt.target.value);
      });
    let cell = $('<td></td>').append(input);
    let row = $('<tr><td>'+value+'</td></tr>').append(cell);
    table.append(row);
  });
  table.fadeIn();
}

$('#default-link-color').on('input', setLinkColor);
$('#linkColorVariable').change(setLinkColor);

function scaleLinkThing(scalar, variable, attribute, floor){
  let links = session.network.svg.select('g#links').selectAll('line').data(session.data.links.filter(l => l.visible));
  if(variable === 'none'){
    return links.attr(attribute, scalar);
  }
  if(!floor){floor = 1;}
  let values = _(session.data.links).map(variable).without(undefined);
  let min = values.min();
  let max = values.max();
  let rng = max - min;
  let recip = $('#reciprocal-link-width').is(':checked');
  links.attr(attribute, d => {
    let v = d[variable];
    if(typeof v === 'undefined') v = rng / 2 + min;
    if(recip && attribute == 'stroke-width'){
      return scalar * (1 - (v - min) / rng) + floor;
    }
    return scalar * (v - min) / rng + floor;
  });
}

$('#default-link-opacity').on('input', e => scaleLinkThing($('#default-link-opacity').val(), $('#linkOpacityVariable').val(), 'opacity', .1));
$('#linkOpacityVariable').change(e => scaleLinkThing($('#default-link-opacity').val(), $('#linkOpacityVariable').val(), 'opacity', .1));

$('#default-link-width').on('input', e => scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width'));
$('#linkWidthVariable, #reciprocal-link-width').change(e => scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width'));

$('#linkSortVariable').on('change', e => {
  if(e.target.value === 'none'){
    $('#computeMST').fadeOut();
    $('#default-link-threshold').fadeOut();
  } else {
    $('#computeMST').css('display', 'inline-block');
    $('#default-link-threshold').css('visibility', 'visible');
  }
});

$('#computeMST').click(e => {
  //TODO: Write
  $('.showForNotMST').fadeOut(e => {
    $('.showForMST').css('opacity', 0).css('display', 'inline-block').animate({'opacity': 1});
  });
});

$('#showMSTLinks, #showAllLinks').change(e => {
  setLinkVisibility();
  app.tagClusters();
  if($('#HideSingletons').is(':checked')) setNodeVisibility();
  renderNetwork();
  app.computeDegree();
  updateStatistics();
  session.network.force.alpha(0.3).alphaTarget(0).restart();
})

$('#ShowSingletons, #HideSingletons').change(e => {
  app.tagClusters();
  setNodeVisibility();
  renderNetwork();
  app.computeDegree();
  updateStatistics();
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

$('#default-link-threshold').on('input', e => {
  setLinkVisibility();
  app.tagClusters();
  if($('#HideSingletons').is(':checked')) setNodeVisibility();
  renderNetwork();
  app.computeDegree();
  updateStatistics();
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

$('#hideNetworkStatistics').parent().click(() => $('#networkStatistics').fadeOut());
$('#showNetworkStatistics').parent().click(function(){
  updateStatistics();
  $('#networkStatistics').fadeIn();
});

$('#network-friction').on('input', e => {
  session.network.force.velocityDecay(e.target.value);
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

$('#network-gravity').on('input', e => {
  session.network.force.force('gravity').strength(e.target.value);
  session.network.force.alpha(0.3).alphaTarget(0).restart();
});

$('#main_panel').css('background-color', $('#network-color').val());

$('#network-color').on('input', e => $('#main_panel').css('background-color', e.target.value));

$('#playbutton')
  .data('state', 'paused')
  .click(function(e){
    if($(this).data('state') === 'paused'){
      $(this).data('state', 'playing')
        .html('<i class="fa fa-pause" aria-hidden="true"></i>');
      session.network.force.alphaTarget(session.state.alpha).restart();
    } else {
      $(this).data('state', 'paused')
        .html('<i class="fa fa-play" aria-hidden="true"></i>');
      session.network.force.alpha(0).alphaTarget(0);
    }
  });

$('#search').on('input', e => {
  if(e.target.value === ''){
    session.data.nodes.forEach(n => n.selected = 0);
  } else {
    session.data.nodes.forEach(n => n.selected = (n.id.indexOf(e.target.value)>-1));
    if(session.data.nodes.filter(n => n.selected).length === 0) alertify.warning('No matches!');
  }
  d3.select('g#nodes')
    .selectAll('g.node')
    .select('path')
    .data(session.data.nodes)
    .classed('selected', d => d.selected);
  $('#numberOfSelectedNodes').text(session.data.nodes.filter(d => d.selected).length.toLocaleString());
});

</script>
