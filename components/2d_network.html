<svg id="network"></svg>

<div class="view_controls">
  <button type="button" id="toggle_2d_network_settings" class="btn btn-light btn-sm" data-toggle="button" title="Network Settings">
    <span class="oi oi-cog"></span>
  </button>
  <button type="button" class="btn btn-light btn-sm"  data-toggle="modal" data-target="#export_svg_modal" title="Export Network">
    <span class="oi oi-data-transfer-download"></span>
  </button>
  <button id="fitbutton" type="button" class="btn btn-light btn-sm" title="Center and Scale Network">
    <span class="oi oi-target"></span>
  </button>
  <button id="pinbutton" type="button" class="btn btn-light btn-sm" data-toggle="button" aria-pressed="false" autocomplete="off" title="Pin all Nodes">
    <span class="oi oi-pin"></span>
  </button>
</div>

<div id="2d_network_settings_pane" class="left_pane">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="nodes-tab" data-toggle="tab" href="#node_settings" role="tab" aria-controls="node_settings" aria-selected="true">Nodes</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="links-tab" data-toggle="tab" href="#link_settings" role="tab" aria-controls="link_settings" aria-selected="false">Links</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="network-tab" data-toggle="tab" href="#2d_network_settings" role="tab" aria-controls="network_settings" aria-selected="false">Network</a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="node_settings" role="tabpanel" aria-labelledby="nodes-tab">
      <div class="form-group row">
        <div class="col-4"><strong>Property</strong></div>
        <div class="col-8"><strong>Value</strong></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="nodeLabelVariable" data-toggle="tooltip" title="What field should be displayed as a label for the node?">Label</label></div>
        <div class="col-8"><select id="nodeLabelVariable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="nodeTooltipVariable" data-toggle="tooltip" title="What node data should be displayed as a tooltip for the node?">Tooltip</label></div>
        <div class="col-8"><select id="nodeTooltipVariable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="nodeSymbolVariable" data-toggle="tooltip" title="What shape should the nodes be?">Shape By</label></div>
        <div class="col-8"><select id="nodeSymbolVariable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
      </div>
      <div id="node_shape_value_row" class="form-group row">
        <div class="col-4"><label for="default-node-symbol" data-toggle="tooltip" title="What shape should the nodes be?">Shape</label></div>
        <div class="col-8"><select id="default-node-symbol" class="custom-select custom-select-sm">
          <option value="symbolCircle" selected>&nbsp;&#11044; (Circle)</option>
          <option value="symbolTriangle">&nbsp;&#9650; (Up Triangle)</option>
          <option value="symbolTriangleDown">&nbsp;&#9660; (Down Triangle)</option>
          <option value="symbolTriangleLeft">&nbsp;&#9664; (Left Triangle)</option>
          <option value="symbolTriangleRight">&nbsp;&#9654; (Right Triangle)</option>
          <option value="symbolDiamond">&nbsp;&#10731; (Vertical Diamond)</option>
          <option value="symbolDiamondAlt">&nbsp;&#10731; (Horizontal Diamond)</option>
          <option value="symbolSquare">&nbsp;&#9632; (Square)</option>
          <option value="symbolDiamondSquare">&nbsp;&#9670; (Tilted Square)</option>
          <option value="symbolPentagon">&nbsp;&#11039; (Pentagon)</option>
          <option value="symbolHexagon">&nbsp;&#11042; (Hexagon)</option>
          <option value="symbolHexagonAlt">&nbsp;&#11043; (Tilted Hexagon)</option>
          <option value="symbolOctagon">&nbsp;&#11204; (Octagon)</option>
          <option value="symbolOctagonAlt">&nbsp;&#11203; (Tilted Octagon)</option>
          <option value="symbolCross">&nbsp;&#10010; (Addition Sign)</option>
          <option value="symbolX">&nbsp;&#10006; (Multiplication Sign)</option>
          <option value="symbolWye">&nbsp;&#120300; (Wye)</option>
          <option value="symbolStar">&nbsp;&#9733; (Star)</option>
        </select></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="nodeColorVariable" data-toggle="tooltip" title="What color should the nodes be?">Color By</label></div>
        <div class="col-8"><select id="nodeColorVariable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
      </div>
      <div id="node_color_value_row" class="form-group row">
        <div class="col-4"><label for="default-node-color" data-toggle="tooltip" title="What color should the nodes be?">Color</label></div>
        <div class="col-8"><input type="color" id="default-node-color" class="custom-select custom-select-sm" value="#1f77b4" /></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="nodeRadiusVariable" data-toggle="tooltip" title="How large should the nodes be?">Size By</label></div>
        <div class="col-8"><select id="nodeRadiusVariable" class="custom-select custom-select-sm nodeVariables numeric"><option>None</option></select></div>
      </div>
      <div id="node_size_value_row" class="form-group row">
        <div class="col-4"><label for="default-node-radius" data-toggle="tooltip" title="How large should the nodes be?">Size</label></div>
        <div class="col-8"><input type="range" id="default-node-radius" min="1" value="250" step="1" max="5000" /></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label for="highlight-neighbors" data-toggle="tooltip" title="Should MicrobeTrace Highlight a node's neighbors when you hover on it?">Highlight Neighbors?</label></div>
        <div class="col-8"><input type="checkbox" id="highlight-neighbors" /></div>
      </div>
    </div>
    <div class="tab-pane fade" id="link_settings" role="tabpanel" aria-labelledby="links-tab">
      <div class="form-group row">
        <div class="col-4"><strong>Property</strong></div>
        <div class="col-8"><strong>Value</strong></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="What data should be displayed when you hover over a link?">Tooltip</label></div>
        <div class="col-8"><select id="linkTooltipVariable" class="custom-select custom-select-sm linkVariables"><option>None</option></select></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="What color should the links be?">Color By</label></div>
        <div class="col-8"><select id="linkColorVariable" class="custom-select custom-select-sm linkVariables"><option>None</option><option selected>origin</option></select></div>
      </div>
      <div id="link-color-row" class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="What color should the links be?">Color</label></div>
        <div class="col-8"><input type="color" id="default-link-color" class="custom-select custom-select-sm" value="#8dd3c7" /></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="How transparent should the links be?">Transparency By</label></div>
        <div class="col-8"><select id="linkOpacityVariable" class="custom-select custom-select-sm linkVariables"><option>None</option></select></div>
      </div>
      <div id="link-transparency-row" class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="How transparent should the links be?">Transparency</label></div>
        <div class="col-8"><input type="range" id="default-link-opacity" min="0" max="1" value="1" step="0.01" /></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="How wide should the links be?">Thickness By</label></div>
        <div class="col-8"><select id="linkWidthVariable" class="custom-select custom-select-sm linkVariables"><option>None</option></select></div>
      </div>
      <div id="link-reciprocalthickness-row" class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="Should link widths be proportioned to the reciprocal of this variable?" checked>Reciprocal</label></div>
        <div class="col-8"><input type="checkbox" id="reciprocal-link-width" checked /></div>
      </div>
      <div class="form-group row">
        <div class="col-4"><label data-toggle="tooltip" title="How wide should the links be?">Thickness</label></div>
        <div class="col-8"><input type="range" id="default-link-width" min="0.3" max="30" step=".3" value="3" /></div>
      </div>
      <div class="form-group row hideForHIVTrace">
        <div class="col-4"><label data-toggle="tooltip" title="Are these links directed?">Directionality</label></div>
        <div class="col-8">
          <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
            <label class="btn btn-secondary active">
              <input type="radio" name="DirectionOptions" id="UndirectedLinks" autocomplete="off" checked> Undirected
            </label>
            <label class="btn btn-secondary">
              <input type="radio" name="DirectionOptions" id="DirectedLinks" autocomplete="off"> Directed
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="2d_network_settings" role="tabpanel" aria-labelledby="network-tab">
      <div class="form-group row">
        <div class="col-3"><strong>Property</strong></div>
        <div class="col-9"><strong>Value</strong></div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="Display a table of overview statistics for the network">Statistics</label></div>
        <div class="col-9">
          <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
            <label class="btn btn-secondary active">
              <input type="radio" name="2d_network_statisticsOptions" id="show_2d_network_statistics" autocomplete="off" checked> Show
            </label>
            <label class="btn btn-secondary">
              <input type="radio" name="2d_network_statisticsOptions" id="hide_2d_network_statistics" autocomplete="off"> Hide
            </label>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="How quickly should moving nodes lose their momentum?">Friction</label></div>
        <div class="col-9"><input type="range" id="network-friction" min="0" max="1" value="0.4" step="0.025" /></div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="How long should links be?">Length</label></div>
        <div class="col-9"><input type="range" id="default-link-length" min = "0" max="200" value="50" /></div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="How attractive is the mass of the graph?">Gravity</label></div>
        <div class="col-9"><input type="range" id="network-gravity" min="0.025" max="1" value="0.05" step="0.025" /></div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="How strongly are the nodes repulsed by each other?">Charge</label></div>
        <div class="col-9"><input type="range" id="default-node-charge" min="0" max="400" value="200" /></div>
      </div>
      <div class="form-group row">
        <div class="col-3"><label data-toggle="tooltip" title="What color should the background be?">Background</label></div>
        <div class="col-9"><input type="color" id="network-color" class="custom-select custom-select-sm" value="#ffffff" /></div>
      </div>
    </div>
  </div>
</div>

<table id="network_group_key" class="floater"></table>

<div id="2d-context-menu" class="dropdown-menu">
  <a href="#" id="viewAttributes" class="dropdown-item">View Attributes</a>
  <a href="#" id="copyID" class="dropdown-item">Copy ID</a>
  <a href="#" id="copySeq" class="dropdown-item showForSequence">Copy Sequence</a>
  <a href="#" id="pinNode" class="dropdown-item">Pin Node</a>
  <div class="dropdown-divider" />
  <a href="#" id="isolateCluster" class="dropdown-item">Isolate Cluster</a>
  <a href="#" id="hideCluster" class="dropdown-item">Hide Cluster</a>
</div>

<div id="attributeModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Node Attributes</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="overflow: auto">
        <table class="table table-striped">
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" data-dismiss="modal" title="">OK</button>
      </div>
    </div>
  </div>
</div>

<div id="networkStatistics">
  <table>
    <tbody>
      <tr>
        <td class="text-right">
          <span id="numberOfNodes"></span>
          (<span id="numberOfSelectedNodes"></span>)
        </td>
        <td>Nodes (Selected)</td>
      </tr>
      <tr>
        <td id="numberOfVisibleLinks" class="text-right"></td>
        <td>Links</td>
      </tr>
      <tr>
        <td id="numberOfDisjointComponents" class="text-right"></td>
        <td>Clusters</td>
      </tr>
      <tr id="singletonsRow">
        <td id="numberOfSingletonNodes" class="text-right"></td>
        <td>Singletons</td>
      </tr>
    </tbody>
  </table>
</div>

<div id="export_svg_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Export Network Image</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group row">
          <div class="col-9">
            <input type="text" id="export-svg-file-name" class="form-control form-control-sm" placeholder="Filename" />
          </div>
          <div class="col-3">
            <select id="export-img-file-type" class="form-control form-control-sm">
              <option selected>png</option>
              <option>svg</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
        <button type="button" id="svg_export" class="btn btn-primary" data-dismiss="modal">Export</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script src="node_modules/d3-force-attract/dist/d3-force-attract.min.js"></script>
<script src="node_modules/d3-symbol-extra/build/d3-symbol-extra.min.js"></script>
<script>
(function(){

  session.network = {};

  session.network.brush = d3.brush()
    .on('start', brushstarted)
    .on('brush', brushed)
    .on('end', brushended);

  function brushstarted(){
    session.data.nodes.forEach(d => {
      d.previouslySelected = d.selected;
    });
  }

  function brushed(){
    if(d3.event.sourceEvent.type === 'end') return;
    var selection = [
      session.network.transform.invert(d3.event.selection[0]),
      session.network.transform.invert(d3.event.selection[1])
    ];
    if(selection == null) return;
    var node = session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes.filter(d => d.visible));
    if(d3.event.sourceEvent.ctrlKey){
      node.classed('selected', function(d){
        return d.selected = d.previouslySelected ^ (
          selection[0][0] <= d.x && d.x <= selection[1][0] &&
          selection[0][1] <= d.y && d.y <= selection[1][1]);
      });
    } else {
      node.classed('selected', function(d){
        return d.selected =
          selection[0][0] <= d.x && d.x <= selection[1][0] &&
          selection[0][1] <= d.y && d.y <= selection[1][1];
      });
    }
    $(window).trigger('node_selected');
  }

  function brushended() {
    if (d3.event.selection == null) return;
    d3.select(this).call(d3.event.target.move, null);
    session.data.nodes.forEach(d => {
      delete d.previouslySelected;
    });
  }

  session.network.zoom = d3.zoom()
    .on('zoom', zoomed);

  function zoomed(){
    session.network.svg.attr('transform', d3.event.transform);
    session.network.transform = d3.event.transform;
  }

  var width  = $('#network').parent().width(),
      height = $('#network').parent().parent().parent().height();

  d3.select('svg#network')
    .html(null) //Let's make sure the canvas is blank.
    .attr('height', height)
    .attr('width', width)
    .on('click', hideContextMenu)
    .call(session.network.zoom);

  d3.select('svg#network')
      .append('g')
      .attr('class', 'brush')
      .call(session.network.brush)
      .attr('pointer-events', 'none')
    .select('rect.overlay')
      .attr('pointer-events', 'none');

  session.network.svg = d3.select('svg#network')
    .append('g')

  session.network.fit = function(thing, bounds){
    if(!bounds) bounds = session.network.svg.node().getBBox();
    if (bounds.width === 0 || bounds.height === 0) return; // nothing to fit
    var parent = session.network.svg.node().parentElement,
        midX = bounds.x + bounds.width / 2,
        midY = bounds.y + bounds.height / 2;
    var scale = 0.95 / Math.max(bounds.width / parent.clientWidth, bounds.height / parent.clientHeight);
    d3.select('svg#network')
      .transition()
      .duration(750)
      .call(session.network.zoom.transform, d3.zoomIdentity
        .translate(parent.clientWidth / 2 - scale * midX, parent.clientHeight / 2 - scale * midY)
        .scale(scale));
  };

  session.network.force = d3.forceSimulation()
    .force('link', d3.forceLink()
      .id(d => d.id)
      .distance($('#default-link-length').val())
      .strength(0.125)
    )
    .force('charge', d3.forceManyBody()
      .strength(-$('#default-node-charge').val())
    )
    .force('gravity', d3.forceAttract()
      .target([width/2, height/2])
      .strength($('#network-gravity').val())
    )
    .force('center', d3.forceCenter(width / 2, height / 2));

  session.network.svg.append('svg:defs').append('marker')
    .attr('id', 'end-arrow')
    .attr('viewBox', '0 0 10 10')
    .attr('refX', 20)
    .attr('refY', 5)
    .attr('markerWidth', 4)
    .attr('markerHeight', 4)
    .attr('orient', 'auto')
    .append('svg:path')
      .attr('d', 'M0,0 L0,10 L10,5 z');

  session.network.svg.append('g').attr('id', 'links');
  session.network.svg.append('g').attr('id', 'nodes');

  session.network.render = function(){
    var vnodes = session.data.nodes.filter(node => node.visible);

    //OK, this is a little bit of expert-level D3 voodoo that deserves some explanation.
    var node = session.network.svg.select('g#nodes').selectAll('g.node').data(vnodes);
    node.exit().remove(); //Removing nodes with no representation in the dataset.
    node = node.enter().append('g').attr('class', 'node').attr('tabindex', '0') //Adding nodes that weren't represented in the dataset before.
      .call(d3.drag() //A bunch of mouse handlers.
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended))
      .on('mouseenter focusin', showNodeToolTip)
      .on('mouseout focusout', hideTooltip)
      .on('contextmenu', showContextMenu)
      .on('click', clickHandler)
      .on('keydown', n => {
        if(d3.event.code === 'Space') clickHandler(n);
        if(d3.event.shiftKey && d3.event.key === 'F10') showContextMenu(n);
      });

    // What's this?
    node.append('path')  // Adding a path?
      .attr('stroke', '#ffffff')
      .attr('stroke-width', '2px');
    node.append('text'); // And a text? Wouldn't those already be attached to the nodes?
    // Well, they would for nodes that already existed. The wouldn't for new nodes.
    // And until we merge the old and new nodes, `node` refers only to the *added* nodes.
    // Speaking of merging...
    node = node.merge(node);
    // E voila! node now refers to all the g.node elements in the network,
    // and they all have path and text elements, so we can confidently...
    node.select('path').attr('fill', $('#default-node-color').val());
    // And style them according to the DOM State instructions.
    redrawNodes();
    // And append our label text, too!
    node.select('text')
      .attr('dy', 5)
      .attr('dx', 8);

    var vlinks = getVLinks();

    // Links are considerably simpler.
    var link = session.network.svg.select('g#links').selectAll('line').data(vlinks);
    link.exit().remove();
    link.enter().append('line')
      .attr('stroke', $('#default-link-color').val())
      .attr('stroke-width', $('#default-link-width').val())
      .attr('opacity', $('#default-link-opacity').val())
      .on('mouseenter', showLinkToolTip)
      .on('mouseout', hideTooltip);

    setLinkColor();
    scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width');

    var nodes = session.network.svg.select('g#nodes').selectAll('g.node').data(vnodes);
    var links = session.network.svg.select('g#links').selectAll('line').data(vlinks);
    session.network.force.nodes(vnodes).on('tick', function(){
      nodes
        .attr('transform', d => d.fixed ? `translate(${d.fx}, ${d.fy})` : `translate(${d.x}, ${d.y})`);
      links
        .attr('x1', l => l.source.x)
        .attr('y1', l => l.source.y)
        .attr('x2', l => l.target.x)
        .attr('y2', l => l.target.y);
    });

    session.network.force.force('link').links(vlinks);

    $(window).on('node_selected', function(){
      nodes.select('path').classed('selected', d => d.selected);
      $('#numberOfSelectedNodes').text(session.data.nodes.filter(d => d.selected).length.toLocaleString());
    });
  };

  function getVLinks(){
    var vlinks = UltraDeepClone(session.data.links.filter(link => link.visible));
    var output = [];
    var n = vlinks.length;
    for(var i = 0; i < n; i++){
      if(vlinks[i].origin){
        if(typeof vlinks[i].origin === 'object'){
          vlinks[i].origin.forEach((o, j, l) => {
            output.push(Object.assign({}, vlinks[i], {
              origin: o,
              oNum: j,
              origins: l.length,
              source: session.data.nodes.find(d => d.id === vlinks[i].source),
              target: session.data.nodes.find(d => d.id === vlinks[i].target)
            }));
          });
        } else {
          output.push(Object.assign({}, vlinks[i], {
            oNum: 0,
            origins: 1,
            source: session.data.nodes.find(d => d.id === vlinks[i].source),
            target: session.data.nodes.find(d => d.id === vlinks[i].target)
          }));
        }
      } else {
        output.push(Object.assign({}, vlinks[i], {
          origin: 'Unknown',
          oNum: 0,
          origins: 1,
          source: session.data.nodes.find(d => d.id === vlinks[i].source),
          target: session.data.nodes.find(d => d.id === vlinks[i].target)
        }));
      }
    }
    return output;
  }

  session.network.updateStatistics = function(){
    if($('#hide_2d_network_statistics').is(':checked')) return;
    var llinks = _.filter(session.data.links, e => e.visible);
    var lnodes = _.filter(session.data.nodes, e => e.visible);
    var singletons = session.data.clusters.filter(c => c.nodes === 1).length;
    $('#numberOfSelectedNodes').text(lnodes.filter(d => d.selected).length.toLocaleString());
    $('#numberOfNodes').text(lnodes.length.toLocaleString());
    $('#numberOfVisibleLinks').text(llinks.length.toLocaleString());
    $('#numberOfSingletonNodes').text(singletons.toLocaleString());
    $('#numberOfDisjointComponents').text(session.data.clusters.length - singletons);
  }

  function dragstarted(d){
    if (!d3.event.active) session.network.force.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d){
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d){
    if (!d3.event.active) session.network.force.alphaTarget(0);
    if(!d.fixed){
      d.fx = null;
      d.fy = null;
    }
  }

  function clickHandler(n){
    if(!d3.event.ctrlKey){
      session.data.nodes
        .filter(node => node !== n)
        .forEach(node => node.selected = 0);
    }
    n.selected = !n.selected;
    $(window).trigger('node_selected');
  }

  new Clipboard('#copyID, #copySeq');

  function showContextMenu(d){
    d3.event.preventDefault();
    hideTooltip();
    $('#copyID').attr('data-clipboard-text', d.id);
    $('#copySeq').attr('data-clipboard-text', d.seq);
    d3.select('#viewAttributes').on('click', e => {
      showAttributeModal(d);
    }).node().focus();
    if(d.fixed){
      $('#pinNode').text('Unpin Node').click(e => {
        d.fx = null;
        d.fy = null;
        d.fixed = false;
        session.network.force.alpha(0.3).alphaTarget(0).restart();
        hideContextMenu();
      });
    } else {
      $('#pinNode').text('Pin Node').click(e => {
        d.fx = d.x;
        d.fy = d.y;
        d.fixed = true;
        hideContextMenu();
      });
    }
    $('#hideCluster').click(e => {
      session.data.clusters.find(c => c.id === d.cluster).visible = 0;
      app.setLinkVisibility();
      app.setNodeVisibility();
      session.network.render();
      session.network.force.alpha(0.3).alphaTarget(0).restart();
      hideContextMenu();
    });
    if(session.data.clusters.length < 2){
      $('#isolateCluster').hide();
    } else {
      if(session.data.clusters.filter(c => c.visible).length === 1){
        $('#isolateCluster').show().text('De-isolate Cluster').click(e => {
          session.data.clusters.forEach(c => c.visible = 1);
          app.setNodeVisibility();
          app.setLinkVisibility();
          session.network.render();
          session.network.force.alpha(0.3).alphaTarget(0).restart();
          hideContextMenu();
        });
      } else {
        $('#isolateCluster').show().text('Isolate Cluster').click(e => {
          session.data.clusters.forEach(c => c.visible = c.id === d.cluster);
          app.setLinkVisibility();
          app.setNodeVisibility();
          session.network.render();
          session.network.force.alpha(0.3).alphaTarget(0).restart();
          hideContextMenu();
        });
      }
    }
    $('#2d-context-menu').css({
      'z-index': 1,
      'display': 'block',
      'left': (d3.event.pageX) + 'px',
      'top': (d3.event.pageY-56) + 'px',
    }).animate({'opacity': 1}, 80);
  }

  function hideContextMenu(){
    $('#2d-context-menu').animate({'opacity': 0}, 80, function(){
      $(this).css('z-index', -1);
    });
  }

  function showAttributeModal(d){
    hideContextMenu();
    var target = $('#attributeModal tbody').empty();
    for(var attribute in d){
      target.append(`<tr><td><strong>${app.titleize(attribute)}</strong></td><td>${d[attribute]}</td></tr>`);
    }
    $('#attributeModal').modal('show');
  }

  function showNodeToolTip(d){
    if($('#highlight-neighbors').is(':checked')) highlightNeighbors(d);
    if($('#nodeTooltipVariable').val() === 'None') return;
    d3.select('#tooltip')
      .html(d[$('#nodeTooltipVariable').val()])
      .style('left', (d3.event.pageX + 8) + 'px')
      .style('top', (d3.event.pageY - 28) + 'px')
      .style('z-index', 1000)
      .transition().duration(100)
      .style('opacity', 1);
  }

  function highlightNeighbors(node){
    var links = getVLinks();
    var lindices = [], neighbors = [node.id];
    var n = links.length;
    for(var i = 0; i < n; i++){
      var l = links[i];
      if(l.source.id !== node.id && l.target.id !== node.id){
        lindices.push(l.index);
      } else {
        if(l.source.id === node.id){
          neighbors.push(l.target.id);
        } else {
          neighbors.push(l.source.id);
        }
      }
    }
    session.network.svg
      .select('g#nodes')
      .selectAll('g.node')
      .selectAll('path')
      .attr('opacity', d => neighbors.includes(d.id) ? 1 : .1);
    session.network.svg
      .select('g#links')
      .selectAll('line')
      .attr('opacity', l => lindices.includes(l.index) ? .1 : 1);
  }

  function showLinkToolTip(d){
    var v = $('#linkTooltipVariable').val();
    if(v === 'None') return;
    d3.select('#tooltip')
      .html((v === 'source' || v === 'target') ? d[v].id : d[v])
      .style('left', (d3.event.pageX + 8) + 'px')
      .style('top', (d3.event.pageY - 28) + 'px')
      .style('z-index', 1000)
      .transition().duration(100)
      .style('opacity', 1);
  }

  function hideTooltip(){
    if($('#highlight-neighbors').is(':checked')){
      var nodeOpacity = $('#default-node-opacity').val();
      session.network.svg
        .select('g#nodes')
        .selectAll('g.node')
        .selectAll('path')
        .attr('opacity', nodeOpacity);
      var linkOpacity = $('default-link-opacity').val();
      session.network.svg
        .select('g#links')
        .selectAll('line')
        .attr('opacity', linkOpacity);
    }
    var tooltip = d3.select('#tooltip');
    tooltip
      .transition().duration(100)
      .style('opacity', 0)
      .on('end', () => tooltip.style('z-index', -1));
  }

  function redrawNodes(){
    //Things to track in the function:
    //* Shapes:
    var type = d3[$('#default-node-symbol').val()];
    var symbolVariable = $('#nodeSymbolVariable').val();
    var o = (b => d3[$('#default-node-symbol').val()]);
    if(symbolVariable !== 'None'){
      var map = {};
      var values = _.uniq(session.data.nodes.map(d => d[symbolVariable])).sort();
      $('#nodeShapes select').each(function(i, el){
        map[values[i]] = $(this).val();
      });
      o = (v => map[v]);
    }
    //* Sizes:
    var defaultSize = $('#default-node-radius').val();
    var size = defaultSize;
    var sizeVariable = $('#nodeRadiusVariable').val();
    if(sizeVariable !== 'None'){
      var n = session.data.nodes.length;
      var min = Number.MAX_VALUE;
      var max = Number.MIN_VALUE;
      for(var i = 0; i < n; i++){
        if(typeof session.data.nodes[i][sizeVariable] === 'undefined') continue;
        if(session.data.nodes[i][sizeVariable] < min) min = session.data.nodes[i][sizeVariable];
        if(session.data.nodes[i][sizeVariable] > max) max = session.data.nodes[i][sizeVariable];
      }
      var oldrng = max - min;
      var med = oldrng / 2;
    }
    var vnodes = session.data.nodes.filter(n => n.visible);
    var nodes = session.network.svg.select('g#nodes').selectAll('g.node').data(vnodes);
    nodes.select('path').each(function(d){
      if(symbolVariable !== 'None') type = d3[o(d[symbolVariable])];
      if(sizeVariable !== 'None'){
        size = med;
        if(typeof d[sizeVariable] !== 'undefined'){
          size = d[sizeVariable];
        }
        size = (size - min + 1) / oldrng
        size = size * size * defaultSize;
      }
      d3.select(this).attr('d', d3.symbol().size(size).type(type));
    });
    //* and Labels:
    var labelVar = $('#nodeLabelVariable').val();
    nodes.select('text').text(n => n[labelVar]);
  }

  $('#toggle_2d_network_settings').click(function(){
    var pane = $('#2d_network_settings_pane');
    if(pane.is(':visible')){
      pane.animate({left: '-400px'}, function(){ pane.hide(); });
    } else {
      pane.show(0, function(){ pane.animate({left: '0px'}); });
    }
  });

  $('#nodeLabelVariable').change(e => {
    if(e.target.value === 'None'){
      session.network.svg.select('g#nodes').selectAll('g.node')
        .select('text').text('');
    } else {
      session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes.filter(n => n.visible))
        .select('text').text(d => d[e.target.value]);
    }
  });

  $('#default-node-symbol').on('input', redrawNodes);
  $('#nodeSymbolVariable').change(e => {
    $('#default-node-symbol').fadeOut();
    $('#nodeShapes').fadeOut(function(){$(this).remove()});
    var table = $('<tbody id="nodeShapes"></tbody>').appendTo('#network_group_key');
    if(e.target.value === 'None'){
      redrawNodes();
      $('#default-node-symbol').fadeIn();
      return table.fadeOut(e => table.remove());
    }
    table.append('<tr><th contenteditable>'+app.titleize(e.target.value)+'</th><th>Shape</th><tr>');
    var values = _.uniq(session.data.nodes.map(d => d[e.target.value])).sort();
    var symbolKeys = ['symbolCircle', 'symbolCross', 'symbolDiamond', 'symbolSquare', 'symbolStar', 'symbolTriangle', 'symbolWye', 'symbolTriangleDown', 'symbolTriangleLeft', 'symbolTriangleRight', 'symbolDiamondAlt', 'symbolDiamondSquare', 'symbolPentagon', 'symbolHexagon', 'symbolHexagonAlt', 'symbolOctagon', 'symbolOctagonAlt', 'symbolX'];
    var o = d3.scaleOrdinal(symbolKeys).domain(values);
    var options = $('#default-node-symbol').html();
    values.forEach(v => {
      var selector = $('<select></select>').append(options).val(o(v)).change(redrawNodes);
      var cell = $('<td></td>').append(selector);
      var row = $('<tr><td contenteditable>' + app.titleize(''+v) + '</td></tr>').append(cell);
      table.append(row);
    });
    redrawNodes();
    table.fadeIn();
  });

  $('#default-node-radius').on('input', redrawNodes);
  $('#nodeRadiusVariable').change(redrawNodes);

  $('#default-node-color').on('input', e => session.network.svg.select('g#nodes').selectAll('g.node').select('path').attr('fill', e.target.value));
  $('#nodeColorVariable').change(e => {
    var circles = session.network.svg.select('g#nodes').selectAll('g.node').data(session.data.nodes).select('path');
    if(e.target.value === 'None'){
      circles.attr('fill', $('#default-node-color').val());
      $('#node_color_value_row').slideDown();
      $('#nodeColors').remove();
      return;
    }
    $('#node_color_value_row').slideUp();
    $('#nodeColors').slideUp(function(){$(this).remove()});
    var table = $('<tbody id="nodeColors"></tbody>').appendTo('#network_group_key');
    table.append('<tr><th contenteditable>'+app.titleize(e.target.value)+'</th><th>Color</th><tr>');
    var values = _.uniq(session.data.nodes.map(d => d[e.target.value])).sort();
    var o = d3.scaleOrdinal([d3.schemeCategory10[0]].concat(d3.schemeCategory10.slice(2))).domain(values);
    circles.attr('fill', d => o(d[e.target.value]));
    values.forEach(value => {
      var input = $('<input type="color" value="'+o(value)+'" />')
        .on('input', evt => {
          circles
            .filter(d => d[e.target.value] === value)
            .attr('fill', d => evt.target.value);
        });
      var cell = $('<td></td>').append(input);
      var row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
      table.append(row);
    });
  });

  $('#default-node-charge').on('input', e => {
    session.network.force.force('charge').strength(-e.target.value);
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  $('#DirectedLinks').parent().click(e => {
    session.network.svg.select('g#links').selectAll('line').attr('marker-end', 'url(#end-arrow)');
  });

  $('#UndirectedLinks').parent().click(e => {
    session.network.svg.select('g#links').selectAll('line').attr('marker-end', null);
  });

  $('#default-link-length').on('input', e => {
    session.network.force.force('link').distance(e.target.value);
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  function setLinkColor(e){
    var variable = $('#linkColorVariable').val();
    if(variable === 'None'){
      session.network.svg.select('g#links').selectAll('line').attr('stroke', $('#default-link-color').val());
      $('#default-link-color').fadeIn();
      $('#linkColors').fadeOut();
      return;
    }
    $('#link-color-row').slideUp();
    var vlinks = getVLinks();
    var links = session.network.svg.select('g#links').selectAll('line').data(vlinks);
    $('#linkColors').remove();
    var table = $('<tbody id="linkColors"></tbody>').appendTo('#network_group_key');
    table.append('<tr><th contenteditable>'+app.titleize(variable)+'</th><th>Color</th><tr>');
    var values = _.uniq(vlinks.map(l => l[variable])).sort();
    var o = d3.scaleOrdinal(d3.schemePaired).domain(values);
    links
      .attr('stroke', d => o(d[variable]))
      .attr('stroke-dasharray', l => {
        var length = 15;
        var out = new Array(l.origins * 2);
        var ofs = new Array(l.origins).fill(1);
        var ons = new Array(l.origins).fill(0);
        ons[l.oNum] = 1;
        ofs[l.oNum] = 0;
        for(var i = 0; i < l.origins; i++){
          out[2*i] = ons[i] * length;
          out[2*i + 1] = ofs[i] * length;
        }
        return out.join(', ');
      });
    values.forEach(value => {
      var input = $('<input type="color" name="'+value+'-node-color-setter" value="'+o(value)+'" />')
        .on('input', evt => {
          links
            .filter(d => d[variable] === value)
            .attr('stroke', d => evt.target.value);
        });
      var cell = $('<td></td>').append(input);
      var row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
      table.append(row);
    });
    table.fadeIn();
  }

  $('#default-link-color').on('input', setLinkColor);
  $('#linkColorVariable').change(setLinkColor);

  function scaleLinkThing(scalar, variable, attribute, floor){
    var vlinks = getVLinks();
    var links = session.network.svg.select('g#links').selectAll('line').data(vlinks);
    if(variable === 'None'){
      return links.attr(attribute, scalar);
    }
    if(!floor){floor = 1;}
    var values = vlinks.map(l => l[variable]).filter(l => typeof l === 'undefined');
    var min = Math.min(values);
    var max = Math.max(values);
    var rng = max - min;
    var recip = $('#reciprocal-link-width').is(':checked');
    links.attr(attribute, d => {
      var v = d[variable];
      if(typeof v === 'undefined') v = rng / 2 + min;
      if(recip && attribute === 'stroke-width'){
        return scalar * (1 - (v - min) / rng) + floor;
      }
      return scalar * (v - min) / rng + floor;
    });
  }

  $('#default-link-opacity').on('input', e => scaleLinkThing($('#default-link-opacity').val(), $('#linkOpacityVariable').val(), 'opacity', .1));
  $('#linkOpacityVariable').change(e => scaleLinkThing($('#default-link-opacity').val(), $('#linkOpacityVariable').val(), 'opacity', .1));

  $('#default-link-width').on('input', e => scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width'));
  $('#linkWidthVariable').change(e => {
    if(e.target.value === 'None'){
      $('#link-reciprocalthickness-row').slideUp();
    } else {
      $('#link-reciprocalthickness-row').slideDown();
    }
    scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width');
  });
  $('#reciprocal-link-width').change(e => {
    scaleLinkThing($('#default-link-width').val(), $('#linkWidthVariable').val(), 'stroke-width');
  });

  $('#showMSTLinks, #showAllLinks, #ShowSingletons, #HideSingletons').on('change', e => {
    session.network.render();
    session.network.updateStatistics();
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  $('#linkSortVariable, #default-link-threshold').on('input', e => {
    session.network.render();
    session.network.updateStatistics();
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  $('#hide_2d_network_statistics').parent().click(function(){
    $('#networkStatistics').fadeOut();
  });

  $('#show_2d_network_statistics').parent().click(function(){
    session.network.updateStatistics();
    $('#networkStatistics').fadeIn();
  });

  $('#network-friction').on('input', e => {
    session.network.force.velocityDecay(e.target.value);
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  $('#network-gravity').on('input', e => {
    session.network.force.force('gravity').strength(e.target.value);
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  $('#main_panel').css('background-color', $('#network-color').val());

  $('#network-color').on('input', e => $('#main_panel').css('background-color', e.target.value));

  $('#svg_export').click(function(){
    var network = document.getElementById('network');
    var content = app.unparseSVG(network);
    var filetype = $('#export-img-file-type').val();
    if(filetype === 'svg'){
      var blob = new Blob([content], {type: 'image/svg+xml;charset=utf-8'});
      saveAs(blob, $('#export-svg-file-name').val() + '.' + filetype);
    } else {
      app.blobifySVG(content, network.width.baseVal.value, network.height.baseVal.value, 'png', function(blob, size){
        saveAs(blob, $('#export-svg-file-name').val() + '.' + filetype);
      });
    }
  });

  $('#fitbutton').click(session.network.fit);

  $('#pinbutton').click(function(){
    var nodes = session.network.svg
      .select('g#nodes')
      .selectAll('g.node')
      .data(session.data.nodes.filter(d => d.visible))
      .select('path');
    if(session.network.allPinned){
      nodes.each(function(d){
        delete d.fx;
        delete d.fy;
        d.fixed = false;
      });
      session.network.force.alpha(0.3).alphaTarget(0).restart();
    } else {
      nodes.each(function(d){
        d.fx = d.x;
        d.fy = d.y;
        d.fixed = true;
      });
    }
    session.network.allPinned = !session.network.allPinned;
  });

  $('#RevealAllTab').click(function(e) {
    session.network.render();
    session.network.fit();
    session.network.force.alpha(0.3).alphaTarget(0).restart();
  });

  d3.select(window).on('keydown keyup', function(){
    d3.select('g.brush')
        .attr('pointer-events', d3.event.ctrlKey ? 'all' : 'none')
      .select('rect.overlay')
        .attr('pointer-events', d3.event.ctrlKey ? 'all' : 'none');
  });

  setTimeout(function(){
    $('#nodeTooltipVariable').val('id');
    $('#linkColorVariable').val('origin');
    setLinkColor();
  }, 1500);
})();
</script>
