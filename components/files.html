<div id="file-panel" class="container-fluid">
  <div id="file-table" class="container">
    <p id="file-prompt" class="text-muted">Drag-and-Drop Files here, or click "Add File(s)" to load data.</p>
  </div>
</div>

<div id="file-footer">
  <div class="container" style="padding: 15px">
    <input type="file" id="data-files" multiple="true" />
    <button type="button" id="alignerControlsButton" class="btn btn-default btn-nr floater" data-toggle="modal" data-target="#alignerControlsModal">Settings</button>
    <button type="submit" id="main-submit" class="btn btn-success float-right" title="Please select a Network CSV or FASTA File">Submit</button>
  </div>
</div>

<div id="alignerControlsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="#alignerControlsModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="alignerControlsModalTitle" class="modal-title">Load Settings</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="nav-item active">
            <a href="#aligner-configurations" class="nav-link active" aria-controls="profile" role="tab" data-toggle="tab">Alignment</a>
          </li>
          <li role="presentation" class="nav-item">
            <a href="#distance-configurations" class="nav-link" aria-controls="profile" role="tab" data-toggle="tab">Distance</a>
          </li>
          <li role="presentation" class="nav-item">
            <a href="#system-configurations" class="nav-link" aria-controls="profile" role="tab" data-toggle="tab">System</a>
          </li>
        </ul>
        <!-- Tab panes -->
        <div class="tab-content">
          <div id="aligner-configurations" class="tab-pane fade show active" role="tabpanel">
            <div class="form-group row">
              <div class="col-12">
                <div class="alert alert-warning alert-dismissible" role="alert">
                  <p>MicrobeTrace is not intended to be an alignment program (although it can be used in that way). For best results, please align your sequences using <a href="https://en.wikipedia.org/wiki/List_of_sequence_alignment_software" target="_blank">an external tool</a> before loading them into MicrobeTrace.</p>
                  <p class="ifOnline"><a href="https://github.com/CDCgov/MicrobeTRACE/wiki/Alignment" target="_blank">Click here for additional information.</a></p>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="Should MicrobeTrace align your sequences?">Align</a>
              </div>
              <div class="col-9">
                <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                  <label class="btn btn-light active col" data-toggle="tooltip" title="Do Not Align Sequences (Recommended)">
                    <input type="radio" name="shouldAlign" id="doNotAlign" data-aligner="none" autocomplete="off" checked> None
                  </label>
                  <label class="btn btn-light col" data-toggle="tooltip" title="Align Sequences using Smith-Waterman aligner (Recommended)">
                    <input type="radio" name="shouldAlign" id="swAlign" data-aligner="sw" autocomplete="off"> Smith-Waterman
                  </label>
                  <label class="btn btn-light col" data-toggle="tooltip" title="Align Sequences using ungapped aligner (Not Recommended)">
                    <input type="radio" name="shouldAlign" id="nbeamAlign" data-aligner="nbeam" autocomplete="off"> NBEAM
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group row alignConfigRow">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="Against what sequence should MicrobeTrace align your sequences?">Reference</a>
              </div>
              <div class="col-9">
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="refSeqFileLoad" />
                  <label class="custom-file-label" for="refSeqFileLoad">HIV (HXB2.pol)</label>
                </div>
              </div>
            </div>
            <div class="form-group row alignConfigRow">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="How should MicrobeTrace align your sequences?">Type</a>
              </div>
              <div class="col-9">
                <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                  <label class="btn btn-light active col">
                    <input type="radio" name="alignScope" id="globalAlign" autocomplete="off" checked> Global
                  </label>
                  <label class="btn btn-light col">
                    <input type="radio" name="alignScope" id="localAlign" autocomplete="off"> Local
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group row alignConfigRow">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="How much should MicrobeTrace reward matching bases?"><label for="alignerMatch">Match</label></a>/
                <a href="#" data-toggle="tooltip" title="How much should MicrobeTrace penalize non-matching bases?"><label for="alignerMismatch">Mismatch</label></a>
              </div>
              <div class="col"><input type="number" id="alignerMatch" class="form-control" value="1" min="0"></input></div>
              <div class="col"><input type="number" id="alignerMismatch" class="form-control" value="-1" max="0"></input></div>
            </div>
            <div class="form-group row alignConfigRow">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="How much should MicrobeTrace Penalize opening a gap?"><label for="alignerGapO">Gap Open</label></a>/
                <a href="#" data-toggle="tooltip" title="How much should MicrobeTrace Penalize extending a gap?"><label for="alignerGapE">Extension</label></a>
              </div>
              <div class="col"><input type="number" id="alignerGapO" class="form-control" value="-5" max="0"></input></div>
              <div class="col"><input type="number" id="alignerGapE" class="form-control" value="-2" max="0"></input></div>
            </div>
            <div class="form-group row alignPreviewRow">
              <div class="col-3">
                <a href="#" data-toggle="tooltip" title="Generate a preview of the alignment, using the current configurations.">
                  <button type="button" id="previewAlignment" class="btn btn-light">Preview</button>
                </a>
              </div>
              <div class="col-9">
                <div class="text-center" id="alignmentPreview" style="overflow-x: scroll"><canvas></canvas></div>
              </div>
            </div>
          </div>
          <div id="distance-configurations" class="tab-pane fade" role="tabpanel">
            <div class="form-group row">
              <div class="col-4">
                <label for="distance-metrics">Distance metric(s)</label>
              </div>
              <div class="col-8">
                <select class="chosen-select custom-select-sm" id="distance-metrics" multiple>
                  <option value="tn93" selected>TN93</option>
                  <option value="snps" selected>SNPs</option>
                </select>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-4">
                <label for="default-distance-metric">Default Distance metric</label>
              </div>
              <div class="col-8">
                <select class="custom-select custom-select-sm" id="default-distance-metric">
                  <option value="tn93" selected>TN93</option>
                  <option value="snps">SNPs</option>
                </select>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-4">
                <label for="default-distance-threshold">Default Link Threshold</label>
              </div>
              <div class="col-8">
                <input type="number" id="default-distance-threshold" class="custom-select custom-select-sm" min="0" value="0.015" step="0.001"></input>
              </div>
            </div>
          </div>
          <div id="system-configurations" class="tab-pane fade" role="tabpanel">
            <div class="form-group row">
              <div class="col-2">
                <label for="default-View">Default View</label>
              </div>
              <div class="col-10">
                <select class="custom-select" id="default-View">
                  <option value="2d_network" selected>2D Network</option>
                  <option value="3d_network">3D Network</option>
                  <option value="bubbles">Bubbles</option>
                  <option value="table">Table</option>
                  <option value="phylogenetic_tree">Phylogenetic Tree</option>
                </select>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-2">
                <label for="available-cores">Cores</label>
              </div>
              <div class="col-10">
                <select class="custom-select" id="available-cores"><option selected>1</option></select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer clearfix">
        <button type="submit" class="btn btn-primary pull-right" data-dismiss="modal" title="Confirm Alignment Configurations are All Properly Set">Confirm</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){

  $('#data-files').on('change', function(e){
    var files = e.target.files;
    $('#file-prompt').remove();
    for(var i = 0, f; f = files[i]; i++) addFileToTable(f);
    $('#main-submit').css('display', 'inline').focus();
  }).filestyle({
    text: 'Add File(s)',
    input: false,
    btnClass: 'btn-primary'
  });

  $('#file-panel').on('dragover', function(evt){
    evt.stopPropagation();
    evt.preventDefault();
    evt.originalEvent.dataTransfer.dropEffect = 'copy';
  }).on('drop', function(evt){
    evt.stopPropagation();
    evt.preventDefault();
    var files = evt.originalEvent.dataTransfer.files;
    var n = files.length;
    $('#file-prompt').remove();
    for(var i = 0, f; f = files[i]; i++) addFileToTable(f);
    $('#main-submit').css('display', 'inline').focus();
  });

  function addFileToTable(file){
    session.files.push(file);
    var extension = file.name.split('.').pop().slice(0,3).toLowerCase();
    if(extension === 'mic'){
      var reader = new FileReader();
      reader.onloadend = function(out){
        session = JSON.parse(out.target.result);
        session.startTime = Date.now();
        session.style.nodeSymbolMap = function(){ return session.style.nodeSymbols[0]; };
        session.style.nodeColorMap  = function(){ return session.style.nodeColors[ 0]; };
        session.style.linkColorMap  = function(){ return session.style.linkColors[ 0]; };
        app.finishUp(true);
      };
      reader.readAsText(file);
      return;
    }
    var isFasta = (extension === 'fas');
    var isXL = (extension === 'lsx' || extension === 'xls');
    var isNode = file.name.toLowerCase().includes('node');
    if(isXL){
      var reader = new FileReader();
      reader.onload = function(e){
        var data = e.target.result;
        var workbook = XLSX.read(data, {type: 'array'});
        var data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        var headers = Object.keys(data[0]).map(filterXSS);
        addTableTile(headers);
      };
      reader.readAsArrayBuffer(file);
    } else {
      Papa.parse(file, {
        dynamicTyping: true,
        header: true,
        preview: 1,
        complete: function(output){
          var headers = output.meta.fields.map(filterXSS);
          addTableTile(headers);
        }
      });
    }
    var addTableTile = function(headers){
      var root = $('<div class="form-group row file-table-row"></div>');
      $('<div class="col-8 filename"></div>')
        .append($('<a href="#"><span class="oi oi-circle-x"></span></a>').click(function(e){
          session.files.splice(session.files.indexOf(file.name), 1);
          root.slideUp(function(){ root.remove(); });
        }))
        .append(`&nbsp;<a href="#" title="${file.name}">${file.name}</a>`)
        .appendTo(root);
      root.append(`
        <div class="col-4 text-right">
          <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
            <label class="btn btn-light${!isFasta&!isNode?' active':''}">
              <input type="radio" name="options-${file.name}" data-type="link" autocomplete="off"${!isFasta&!isNode?' checked':''}>Link</input>
            </label>
            <label class="btn btn-light${!isFasta&isNode?' active':''}">
              <input type="radio" name="options-${file.name}" data-type="node" autocomplete="off"${!isFasta&isNode?' checked':''}>Node</input>
            </label>
            <label class="btn btn-light">
              <input type="radio" name="options-${file.name}" data-type="distmat" autocomplete="off">Dist. Mat.</input>
            </label>
            <label class="btn btn-light${isFasta?' active':''}">
              <input type="radio" name="options-${file.name}" data-type="fasta" autocomplete="off"${isFasta?' checked':''}>FASTA</input>
            </label>
          </div>
        </div>
      `);
      var options = '<option>None</option>' + headers.map(function(h){ return '<option value="'+h+'">'+app.titleize(h)+'</option>'; }).join('\n');
      root.append(`<div class='col-4 '${isFasta?' style="display: none;"':''} data-file='${file.name}'>
      <label for="file-${file.name}-field-1">${isNode?'ID':'Source'}</label>
      <select id="file-${file.name}-field-1" class="custom-select custom-select-sm">${options}</select>
      </div>
      <div class='col-4 '${isFasta?' style="display: none;"':''} data-file='${file.name}'>
      <label for="file-${file.name}-field-2">${isNode?'Sequence':'Target'}</label>
      <select id="file-${file.name}-field-2" class="custom-select custom-select-sm">${options}</select>
      </div>`);

      function matchHeaders(type){
        var a = type === 'node' ? ['ID', 'Id', 'id'] : ['SOURCE', 'Source', 'source'],
            b = type === 'node' ? ['SEQUENCE', 'SEQ', 'Sequence', 'sequence', 'seq'] : ['TARGET', 'Target', 'target'],
            these = $(`[data-file='${file.name}'] select`);
        [a, b].forEach(function(list, i){
          list.forEach(function(title){
            if(headers.includes(title)){
              $(these.get(i)).val(title);
            }
          });
        });
      }

      root.appendTo('#file-table');
      matchHeaders($(`[name="options-${file.name}"]:checked`).data('type'));

      function refit(e){
        var type = $(e ? e.target : `[name="options-${file.name}"]:checked`).data('type'),
            these = $(`[data-file='${file.name}']`),
            first = $(these.get(0)),
            second = $(these.get(1));
        if(type === 'node'){
          first.slideDown().find('label').text('ID');
          second.slideDown().find('label').text('Sequence');
          matchHeaders(type);
        } else if(type === 'link'){
          first.slideDown().find('label').text('Source');
          second.slideDown().find('label').text('Target');
          matchHeaders(type);
        } else {
          these.slideUp();
        }
      }

      $(`[name="options-${file.name}"]`).change(refit);
      refit();
    };
  }

  $('#distance-metrics').chosen({width: "100%"}).change(function(e){
    $('#default-distance-metric').html($(this).val().map(function(v, i){
      return '<option value="' + v + '"' + (i == 0 ? ' selected': '') + '>' + app.titleize(v) + '</option>';
    }).join('\n'));
  });

  $('#default-distance-metric').change(function(e){
    session.state.widgets['default-distance-metric'] = e.target.value;
    if(e.target.value == 'snps'){
      $('#default-distance-threshold')
        .attr('step', 1)
        .val(16);
    } else {
      $('#default-distance-threshold')
        .attr('step', 0.001)
        .val(0.015);
    }
  });

  var data;
  function updatePreview(){
    if(!session.files.find(function(f){ return f.name.includes('fas'); })) return;
    if(!data){
      var reader = new FileReader();
      reader.onloadend = function(e){
        data = app.parseFASTA(e.target.result);
        data.forEach(function(node){
          node.id = filterXSS(node.id);
          node.seq = filterXSS(node.seq);
        });
        updatePreview();
      };
      reader.readAsText(session.files.find(function(f){ return f.name.includes('fas'); }), 'UTF-8');
      return;
    }
    $('#alignmentPreview').empty().append('<img src="img/spinner.gif" class="mx-auto" />');
    app.align({
      nodes: data,
      reference: session.data.reference,
      aligner: $('input[name="shouldAlign"]:checked').data('aligner'),
      isLocal: $('#localAlign').is(':checked'),
      match: [parseFloat($('#alignerMatch').val()), parseFloat($('#alignerMismatch').val())],
      gap: [parseFloat($('#alignerGapO').val()), parseFloat($('#alignerGapE').val())],
      cores: $('#available-cores').val()|0
    }, function(output){
      alignmentViewer(output, {
        showID: false
      }).then(function(canvas){
        $('#alignmentPreview').empty().append(canvas);
      });
    });
  }

  $('.alignConfigRow').hide();

  $('#swAlign').parent().click(function(){
    $('.alignConfigRow').slideDown();
    updatePreview();
  });

  $('#doNotAlign, #nbeamAlign').parent().click(function(){
    $('.alignConfigRow').slideUp();
    updatePreview();
  });

  $('#refSeqFileLoad').on('change', function(e){
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.onloadend = function(e){
      if (e.target.readyState == FileReader.DONE){
        var node = app.parseFASTA(e.target.result)[0];
        session.data.reference = filterXSS(node.seq);
        $('label[for="refSeqFileLoad"]').text(`${file.name} (${filterXSS(node.id)})`);
        updatePreview();
      }
    };
    reader.readAsText(file);
  });

  $('#alignerControlsButton, #previewAlignment').click(updatePreview);

  if(localStorage.getItem('default-View')){
    $('#default-View').val(localStorage.getItem('default-View'));
  }

  $('#default-View').change(e => {
    localStorage.setItem('default-View', e.target.value);
    session.layout.content[0].type = e.target.value;
  });

  $('#available-cores').html(
    _.range(1, (navigator.hardwareConcurrency|4)+1).map(i => {
      return `<option${i === Math.ceil((navigator.hardwareConcurrency|4)/2) ? ' selected' : ''}>${i}</option>`;
    }).join()
  );

  function message(msg){
    messages.push(msg);
    $('#loading-information').html(messages.join('<br />'));
  }

  var messageTimeout, messages = [];

  $('#main-submit').click(function(e){
    messages = [];
    session.startTime = Date.now();
    session.data = app.dataSkeleton();
    $('#loading-information').html('');

    $('#loading-information-modal').modal({
      backdrop: false,
      keyboard: false
    });

    messageTimeout = setTimeout(function(){
      $('#loadCancelButton').slideDown();
      alertify.warning('If you stare long enough, you can reverse the DNA Molecule\'s spin direction');
    }, 20000);

    var files = [];
    $('#file-panel .row').each((i, el) => {
      var $el = $(el);
      var fname = $el.find('.filename').text().trim();
      var selects = $el.find('select');
      files.push({
        file: session.files.find(function(file){ return file.name === fname; }),
        type: $el.find('input[type="radio"]:checked').data('type'),
        field1: selects.get(0).value,
        field2: selects.get(1).value
      });
    });
    session.files = files;

    var hierarchy = ['distmat', 'link', 'node', 'fasta'];

    var anySequences = false, metrics = $('#distance-metrics').val();

    files.sort((a, b) => hierarchy.indexOf(a.type) - hierarchy.indexOf(b.type));
    files.forEach((file, fileNum) => {
      var filename = file.file.name;
      var extension = _.last(filename.split('.')).toLowerCase();

      if(file.type === 'fasta'){

        message(`Parsing ${filename} as FASTA...`);
        var reader = new FileReader();
        reader.onloadend = function(e){
          anySequences = true;
          var n = 0;
          var seqs = app.parseFASTA(e.target.result);
          seqs.forEach(node => {
            node.id = filterXSS(node.id);
            node.seq = filterXSS(node.seq);
            node['origin'] = [filename];
            n += app.addNode(node);
          });
          message(` - Parsed ${n} New, ${seqs.length} Total Nodes from FASTA.`);
          if(fileNum === files.length - 1) nextStuff();
        };
        reader.readAsText(file.file, 'UTF-8');

      } else if(file.type === 'link'){

        message(`Parsing ${filename} as Link List...`);
        var l = 0;

        function forEachLink(link){
          Object.keys(link).forEach(function(key){
            link[key] = filterXSS(link[key]);
          });
          var base = {
            source: '' + link[file.field1],
            target: '' + link[file.field2],
            origin: [filename],
            visible: true
          };
          metrics.forEach(function(metric){
            metric = metric.toLowerCase();
            base[metric] = 0;
          });
          l += app.addLink(Object.assign(base, link));
        }

        if(extension == 'xls' || extension == 'xlsx'){

          var reader = new FileReader();
          reader.onload = function(e){
            var data = e.target.result;
            var workbook = XLSX.read(data, {type: 'array'});
            var data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            data.map(forEachLink);
            message(` - Parsed ${l} New, ${data.length} Total Links from Link CSV.`);
            Object.keys(data[0]).forEach(key => {
              key = filterXSS(key);
              if(!session.data.linkFields.includes(key)){
                session.data.linkFields.push(key);
              }
            });
            var n = 0;
            var nodeIDs = _.union(_.map(data, l => l[file.field1]), _.map(data, l => l[file.field2]));
            var t = nodeIDs.length;
            nodeIDs.forEach(d => n += app.addNode({
              id: '' + d,
              origin: [filename]
            }));
            message(` - Parsed ${n} New, ${t} Total Nodes from Link CSV.`);
            if(fileNum === files.length - 1) nextStuff();
          };
          reader.readAsArrayBuffer(file.file);

        } else {

          Papa.parse(file.file, {
            header: true,
            worker: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: results => {
              var data = results.data;
              data.map(forEachLink);
              message(` - Parsed ${l} New, ${data.length} Total Links from Link CSV.`);
              results.meta.fields.forEach(key => {
                key = filterXSS(key);
                if(!session.data.linkFields.includes(key)){
                  session.data.linkFields.push(key);
                }
              });
              var n = 0;
              var nodeIDs = _.union(_.map(data, l => l[file.field1]), _.map(data, l => l[file.field2]));
              var t = nodeIDs.length;
              nodeIDs.forEach(d => n += app.addNode({
                id: '' + d,
                origin: [filename]
              }));
              message(` - Parsed ${n} New, ${t} Total Nodes from Link CSV.`);
              if(fileNum === files.length - 1) nextStuff();
            }
          });
        }
      } else if(file.type === 'node'){

        message(`Parsing ${filename} as Node List...`);

        if(file.field2 !== 'None') anySequences = true;

        var m = 0, n = 0;

        if(extension == 'xls' || extension == 'xlsx'){

          var reader = new FileReader();
          reader.onload = function(e){
            var data = e.target.result;
            var workbook = XLSX.read(data, {type: 'array'});
            var data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            Object.keys(data[0]).forEach(key => {
              key = filterXSS(key);
              if(!session.data.nodeFields.includes(key)){
                session.data.nodeFields.push(key);
              }
            });
            data.forEach(results => {
              node = JSON.parse(filterXSS(JSON.stringify(results)));
              node.id = '' + node[file.field1];
              if(file.field2 !== 'None') node.seq = node[file.field2];
              node['origin'] = [filename];
              m += app.addNode(node);
            });
            message(` - Parsed ${m} New, ${n} Total Nodes from Node CSV.`);
            if(fileNum === files.length - 1) nextStuff();
          };
          reader.readAsArrayBuffer(file.file);

        } else {

          Papa.parse(file.file, {
            header: true,
            worker: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            step: results => {
              if(0 === n++){
                results.meta.fields.forEach(key => {
                  key = filterXSS(key);
                  if(!session.data.nodeFields.includes(key)){
                    session.data.nodeFields.push(key);
                  }
                });
              }
              node = JSON.parse(filterXSS(JSON.stringify(results.data[0])));
              node.id = '' + node[file.field1];
              if(file.field2 !== 'None') node.seq = node[file.field2];
              node['origin'] = [filename];
              m += app.addNode(node);
            },
            complete: () => {
              message(` - Parsed ${m} New, ${n} Total Nodes from Node CSV.`);
              if(fileNum === files.length - 1) nextStuff();
            }
          });
        }

      } else { //Distance Matrix

        message(`Parsing ${filename} as Distance Matrix...`);
        var defaultMetric = $('#default-distance-metric').val();
        Papa.parse(file.file, {
          worker: true,
          skipEmptyLines: true,
          complete: results => {
            var nodeIDs = [];
            var nn = 0, nl = 0;
            results.data.forEach((row, i) => {
              if(i == 0){
                nodeIDs = row.map(filterXSS);
                nodeIDs.forEach((cell, k) => {
                  if(k > 0){
                    nn += app.addNode({
                      id: '' + cell,
                      origin: [filename]
                    });
                  }
                });
              } else {
                row.forEach((cell, j) => {
                  if(j > i){
                    var base = {
                      source: '' + nodeIDs[i],
                      target: '' + nodeIDs[j],
                      origin: [filename]
                    };
                    metrics.forEach(function(metric){
                      metric = metric.toLowerCase();
                      base[metric] = 0;
                    });
                    base[defaultMetric] = parseFloat(cell),
                    nl += app.addLink(base);
                  }
                });
              }
            });
            message(` - Parsed ${nn} New, ${results.data.length - 1} Total Nodes from Distance Matrix.`);
            message(` - Parsed ${nl} New, ${(Math.pow(results.data.length-1, 2) - results.data.length + 1)/2} Total Links from Distance Matrix.`);
            if(fileNum === files.length - 1) nextStuff();
          }
        });
      }
    });

    function nextStuff(){
      if(!anySequences){
        $('.showForSequence').hide();
        app.finishUp();
        return;
      }
      $('.showForSequence').show();
      var allDashes = /^-*$/;
      var subset = session.data.nodes.filter(d => !allDashes.test(d.seq));
      if($('#doNotAlign').is(':checked')){
        computeLinks(subset);
      } else {
        message('Aligning Sequences...');
        app.align({
          reference: session.data.reference,
          aligner: $('input[name="shouldAlign"]:checked').data('aligner'),
          isLocal: $('#localAlign').is(':checked'),
          match: [$('#alignerMatch').val(), $('#alignerMismatch').val()].map(parseFloat),
          gap: [$('#alignerGapO').val(), $('#alignerGapE').val()].map(parseFloat),
          nodes: subset,
          cores: parseFloat($('#available-cores').val())
        }, function(response){
          subset.forEach(function(node){
            var match = response.find(function(possible){
              return possible.id === node.id;
            });
            if(match) Object.assign(node, match);
          });
          computeLinks(subset);
        });
      }
    };

    function computeLinks(subset){
      message('Computing Links based on Genomic Proximity...');
      var k = 0;
      var n = subset.length;
      var cores = parseFloat($('#available-cores').val());
      var computers = Array(cores);
      var nPerI = Math.ceil(n/cores);
      var returned = 0;
      for(var i = 0; i < cores; i++){
        computers[i] = new Worker('scripts/compute-links.js');
        computers[i].onmessage = function(response){
          response.data.forEach(function(link, j){
            k += app.addLink(link);
          });
          if(++returned === n){
            computers.forEach(c => c.terminate());
            message(` - Found ${k} New Links from Genomic Proximity`);
            app.computeDM(function(){
              $('.showForDM').show();
              app.computeNN(function(){
                $('.showForNN').show();
              });
            });
            app.finishUp();
          }
        };
      }
      for(var j = 0; j < n; j++){
        computers[j % cores].postMessage({
          j: j,
          nodes: subset
        });
      }
    };
  });

  app.finishUp = function(oldSession){
    clearTimeout(messageTimeout);
    ['node', 'link'].forEach(v => {
      session.data[v+'s'].forEach(d => {
        session.data[v+'Fields'].forEach(field => {
          if(!(field in d)) d[field] = null;
        });
      });
    });
    $('#links-filter-variable').html(
      session.data.linkFields.map(function(field){
        return '<option value="' + field + '"' + (field === session.state.linkSortVariable ? ' selected' : '') + '>' + app.titleize(field) + '</option>';
      }).join('\n')
    );
    $('#node-color-variable').html(
      '<option selected>None</option>' +
      session.data.nodeFields.map(function(field){
        return '<option value="' + field + '">' + app.titleize(field) + '</option>';
      }).join('\n')
    );
    $('#link-color-variable').html(
      '<option>None</option>' +
      session.data.linkFields.map(function(field){
        return '<option value="' + field + '">' + app.titleize(field) + '</option>';
      }).join('\n')
    );
    try {
      app.updateThresholdHistogram();
    } catch(error){
      console.error(error);
      $('#loading-information-modal').modal('hide');
      alertify
        .error('Something went wrong! Please start a new session and try again.')
        .delay(0)
        .ondismiss(function(){
          window.location.reload();
        });
    }
    app.setLinkVisibility();
    app.setNodeVisibility();
    app.tagClusters();
    app.computeDegree();
    app.updateStatistics();
    $('#network-statistics').fadeIn();
    session.loadTime = Date.now() - session.startTime;
    console.log('Network Loadtime:', (session.loadTime/1000).toLocaleString() + 's');
    if(oldSession){
      app.loadLayout(session.layout, true);
    } else {
      app.loadLayout({
        type: 'stack',
        content: [{
          type: $('#default-View').val()
        }]
      }, true);
    }
    $('.hideForHIVTrace').css('display', 'flex');
    setTimeout(function(){
      let files = layout.contentItems.find(item => item.componentName === 'files');
      if(files) files.remove();
      $('#loading-information-modal').modal('hide');
    }, 1200);
  };
})();
</script>
