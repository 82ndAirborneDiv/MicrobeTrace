  <svg id="bubble-view">
    <text id="bubble-xAxisLabel" y="20"></text>
    <text id="bubble-yAxisLabel" x="20" transform="rotate(90)"></text>
  </svg>

  <div class="view_controls">
    <button type="button" id="bubble-toggle-settings" class="btn btn-light btn-sm" data-toggle="button">
      <span class="oi oi-cog"></span>
    </button>
  </div>

  <div id="bubble-settings-pane" class="left_pane">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item active">
        <a href="#bubble-configurations" id="bubble-nodes-tab" class="nav-link active" aria-controls="bubble-configurations" role="tab" data-toggle="tab">Nodes</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="bubble-configurations" role="tabpanel" aria-labelledby="bubble-nodes-tab">
        <div class="form-group row">
          <div class="col-3">Color</div>
          <div class="col-9"><button class="btn btn-sm btn-light w-100 launch-color-options">Color Options</button></div>
        </div>
        <div class="form-group row">
          <div class="col-3">X</div>
          <div class="col-9">
            <select id="bubble-x" class="custom-select custom-select-sm nodeVariables"></select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Y</div>
          <div class="col-9">
            <select id="bubble-y" class="custom-select custom-select-sm nodeVariables"></select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-3">Size</div>
          <div class="col-9">
            <input type="range" id="bubble-size" min="1" value="5" max="15" step="0.1"></input>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  let width, height, center, forceStrength, simulation, vnodes,
    svg = d3.select('#bubble-view');

  function updateVNodes(){
    let newnodes = app.getVisibleNodes(true);
    if(!vnodes) vnodes = newnodes;
    newnodes.forEach(newNode => {
      let old = vnodes.find(oldNode => oldNode.id === newNode.id);
      if(old){
        newNode.x = old.x;
        newNode.y = old.y;
      };
    });
    vnodes = newnodes;
  }

  function reset(){
    let bv = $('#bubble-view');
    if(!bv.length) return;
    bv.css('background-color', session.style.widgets['background-color']);
    width = bv.parent().width();
    height = bv.parent().height();
    center = { x: width / 2, y: height / 2 };

    svg.attr('width', width).attr('height', height);

    svg
      .select('#bubble-xAxisLabel').attr('x', center.x);
    svg
      .select('#bubble-yAxisLabel').attr('y', center.y)
      .attr('transform', 'rotate(270, 10,' + (center.y-10) + ')');

    updateVNodes();

    let radius = $('#bubble-size').val();
    let bubble = svg.selectAll('circle').data(vnodes);
    bubble.exit().remove();
    bubble.enter().append('circle')
      .attr('r', radius)
      .attr('stroke', '#ffffff')
      .attr('stroke-width', 2)
      .on('click', function(d){
        let c = session.data.nodes.find(node => d.id === node.id);
        c.selected = !c.selected;
        $(window).trigger('node_selected');
      });

    updateNodeColors();

    forceStrength = 0.03;

    simulation = d3.forceSimulation().nodes(vnodes)
      .velocityDecay(0.2)
      .force('x', d3.forceX().strength(forceStrength).x(center.x))
      .force('y', d3.forceY().strength(forceStrength).y(center.y))
      .force('charge', d3.forceManyBody().strength(function(d){ return -50 * forceStrength }))
      .on('tick', function(){
        svg.selectAll('circle')
          .attr('cx', function(d){return d.x})
          .attr('cy', function(d){return d.y});
      });

    groupBubblesX();
    groupBubblesY();
  }

  $('#bubble-x').on('change', function(e){
    session.style.widgets['bubble-x'] = e.target.value;
    groupBubblesX();
  });

  function groupBubblesX(){
    let field = session.style.widgets['bubble-x'];
    if(field === 'None'){
      svg.select('#bubble-xAxisLabel').text('');
      svg.selectAll('.xtitle').remove();
      simulation.force('x', d3.forceX().strength(forceStrength).x(center.x));
      simulation.alpha(1).restart();
      return;
    }
    svg.select('#bubble-xAxisLabel').text(app.titleize(field));
    let values = [];
    vnodes.forEach(function(d){
      if(values.indexOf(d[field]) == -1) values.push(d[field]);
    });
    if(_.isNumber(values[0])){
      values.sort((a, b) => a - b);
    } else {
      values.sort();
    }
    let ratio = width/(values.length + 1);
    let titles = svg.selectAll('.xtitle').data(values);
    titles.exit().remove();
    titles.enter().append('text')
      .attr('class', 'xtitle')
      .attr('y', 50)
      .attr('text-anchor', 'middle')
      .merge(titles)
      .transition()
      .text(function(d){ return d })
      .attr('x', function(d){ return ratio * values.indexOf(d) + ratio });
    simulation.force('x', d3.forceX().strength(forceStrength).x(function(d){
      return ratio * values.indexOf(d[field]) + ratio;
    }));
    simulation.alpha(1).restart();
  }

  $('#bubble-y').on('change', function(e){
    session.style.widgets['bubble-y'] = e.target.value;
    groupBubblesY();
  });

  function groupBubblesY(){
    let field = session.style.widgets['bubble-y'];
    if(field === 'None'){
      svg.select('#bubble-yAxisLabel').text('');
      svg.selectAll('.ytitle').remove();
      simulation.force('y', d3.forceY().strength(forceStrength).y(center.y));
      simulation.alpha(1).restart();
      return;
    }
    svg.select('#bubble-yAxisLabel').text(app.titleize(field));
    let values = [];
    vnodes.forEach(function(d){
      if(values.indexOf(d[field]) == -1) values.push(d[field]);
    });
    if(_.isNumber(values[0])){
      values.sort((a, b) => b - a);
    } else {
      values.sort();
    }
    let ratio = height/(values.length + 1);
    let titles = svg.selectAll('.ytitle').data(values);
    titles.exit().remove();
    titles.enter().append('text')
      .attr('class', 'ytitle')
      .attr('x', 50)
      .merge(titles)
      .transition()
      .text(function(d){ return d })
      .attr('y', function(d){ return ratio * values.indexOf(d) + ratio })
      .attr('transform', function(d){ return 'rotate(270, 50,' + (ratio * values.indexOf(d) + ratio) + ')' });
    simulation.force('y', d3.forceY().strength(forceStrength).y(function(d){
      return ratio * values.indexOf(d[field]) + ratio;
    }));
    simulation.alpha(1).restart();
  }

  $('#bubble-size').on('input', function(e){
    let v = parseFloat(e.target.value);
    svg.selectAll('circle').attr('r', v);
    session.style.widgets['bubble-size'] = v;
  });

  function updateNodeColors(){
    let field = session.style.widgets['node-color-variable'];
    let bubble = svg.selectAll('circle').data(vnodes);
    bubble.attr('stroke', d => d.selected ? session.style.widgets['selected-color'] : '#ffffff');
    if(field === 'None'){
      let color = session.style.widgets['node-color'];
      bubble.transition().attr('fill', color);
    } else {
      bubble.transition().attr('fill', d => session.style.nodeColorMap(d[field]));
    }
  }

  $('#bubble-toggle-settings').click(function(){
    let pane = $('#bubble-settings-pane');
    if($(this).hasClass('active')){
      pane.animate({left: '-400px'}, function(){ pane.hide(); });
    } else {
      pane.show(0, function(){ pane.animate({left: '0px'}); });
    }
  });

  layout.on('stateChanged', reset);

  $(window)
    .on('node-color-change selected-color-change', updateNodeColors)
    .on('link-threshold-change node_visibility node_selected background-color-change', reset);
})();
</script>
</body>
</html>
