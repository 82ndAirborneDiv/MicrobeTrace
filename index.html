<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MicrobeTrace</title>
  <script async src="https://googletagmanager.com/gtag/js?id=UA-116308624-1"></script>
  <script>
    if(window.location.protocol !== 'https:') window.location.replace('https://' + window.location.hostname + window.location.pathname);
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-116308624-1');
  </script>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="img/icon.ico" />
  <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-light-theme.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/chosen-js/chosen.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/alertifyjs/build/css/alertify.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/open-iconic/font/css/open-iconic-bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/tabulator-tables/dist/css/tabulator.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/tabulator-tables/dist/css/bootstrap/tabulator_bootstrap4.min.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/main.css" />
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-xl navbar-light bg-light">
    <ul class="nav mr-auto">
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File</a>
        <div class="dropdown-menu">
          <a href="#" id="StashDataTab" class="dropdown-item" data-toggle="modal" data-target="#session-stash-modal">Stash</a>
          <a href="#" id="RecallDataTab" class="dropdown-item">Recall</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="SaveDataTab" class="dropdown-item" data-toggle="modal" data-target="#session-save-modal">Save</a>
          <label class="dropdown-item" for="OpenTab">Open</label><input type="file" class="d-none" id="OpenTab" />
          <div class="dropdown-divider"></div>
          <a href="#" id="AddDataTab" class="dropdown-item">Add Data</a>
          <a href="#" id="NewTab" class="dropdown-item">New</a>
        </div>
      </li>
      <li class="nav-item">
        <a href="#" id="SettingsTab" class="nav-link py-0" data-toggle="modal" data-target="#aligner-controls-modal">Settings</a>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">View</a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item viewbutton" data-href="2d_network">2D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="3d_network">3D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="histogram">Histogram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="table">Table</a>
          <a href="#" class="dropdown-item viewbutton" data-href="aggregation">Aggregation</a>
          <a href="#" class="dropdown-item viewbutton" data-href="bubbles">Bubbles</a>
          <a href="#" class="dropdown-item viewbutton" data-href="flow_diagram">Flow Diagram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="scatterplot">Scatterplot</a>
          <!--a href="#" class="dropdown-item viewbutton" data-href="waterfall">Waterfall</a-->
          <a href="#" class="dropdown-item viewbutton" data-href="geo_map">Map</a>
          <a href="#" class="dropdown-item viewbutton" data-href="gantt">Gantt</a>
          <a href="#" class="dropdown-item viewbutton" data-href="timeline">Timeline</a>
          <a href="#" class="dropdown-item viewbutton" data-href="heatmap">Heatmap</a>
          <a href="#" class="dropdown-item viewbutton" data-href="phylogenetic_tree">Phylogenetic Tree</a>
          <div class="dropdown-divider show-for-seq"></div>
          <a href="#" class="dropdown-item viewbutton show-for-seq" data-href="sequences">Sequences</a>
          <!-- <a href="#" class="dropdown-item viewbutton show-for-seq" data-href="auditor">Auditor</a> -->
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Window</a>
        <div class="dropdown-menu">
          <a href="#" id="PhylogeographyTab" class="dropdown-item">Phylogeography Mode</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="ReloadTab" class="dropdown-item">Reload</a>
          <a href="#" id="FullScreenTab" class="dropdown-item">Toggle Full Screen</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Help</a>
        <div class="dropdown-menu">
          <a href="#" id="HelpTab" class="viewbutton dropdown-item" data-href="help">Help</a>
          <a href="https://github.com/CDCgov/MicrobeTrace/issues/new" class="dropdown-item ifOnline" target="_blank">Report Bug</a>
          <div class="dropdown-divider ifOnline"></div>
          <a href="#" id="AboutTab" class="dropdown-item" data-toggle="modal" data-target="#about-modal">About</a>
        </div>
      </li>
    </ul>
    <form class="navbar-form navbar-right" role="search">
      <input type="search" id="search" class="form-control py-0" placeholder="Search" />
    </form>
  </nav>

  <div id="ie-warning">
    This application does not support Internet Explorer. To use MicrobeTrace, please switch to one of the following browsers:<br />
    <a href='https://support.google.com/chrome/answer/95346'>Chrome</a> /
    <a href='https://www.mozilla.org/en-US/firefox/new/'>Firefox</a>
  </div>

  <div id="licenseAgreement" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="licenseAgreement">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="licenseAgreement" class="modal-title">License Agreement</h5>
        </div>
        <div class="modal-body">
          <pre>The material embodied in this software is provided to you "As-is" and without
warranty of any kind, express, implied or otherwise, including without
limitation, any warranty of fitness for a particular purpose. In no event shall
the Centers for Disease Control and Prevention (CDC) or the United States (U.S.)
government be liable to you or anyone else for any direct, special, incidental,
indirect or consequential damages of any kind, or any damages whatsoever,
including without limitation, loss of profit, loss of use, savings or revenue,
or the claims of third parties, whether or not CDC or the U.S. Government has
been advised of the possibility of such loss, however caused and on any theory
of liability, arising out of or in connection with the possession, use or
performance of this software.</pre>
          <p>Please Click "Accept" to accept this agreement, or "Reject" to close this application.</p>
        </div>
        <div class="modal-footer">
          <a href="https://www.cdc.gov/" id="rejectAgreement" class="btn btn-danger" role="button">Reject</a>
          <button id="acceptAgreement" type="button" class="btn btn-primary" data-dismiss="modal">Accept</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="loading-information-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Loading File</h5>
        </div>
        <div class="modal-body">
          <div class="dna">
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
            <div class="ele"></div>
          </div>
          <a class="btn btn-primary" data-toggle="collapse" href="#loading-information-collapse" role="button" aria-expanded="true" aria-controls="loading-information-collapse">Details</a>
          <div id="loading-information-collapse" class="collapse show">
            <div id="loading-information" class="card card-body"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="main-panel" class="pane-container pane-horizontal">
    <noscript class="container-fluid">
      <div class="jumbotron">
        <h1>Sorry!</h1>
        <p class="lead">MicrobeTrace requires Javascript to run. Please enable Javascript and refresh MicrobeTrace.</p>
      </div>
    </noscript>
  </div>

  <div id="group-key-wrapper" class="floater">
    <div id="group-key-draghandle"><span class="oi oi-move"></span></div>
    <table id="group-key"></table>
  </div>

  <div id="group-key-context" class="dropdown-menu">
    <a href="#" id="group-key-drag" class="dropdown-item">Drag</a>
    <a href="#" id="group-key-hide" class="dropdown-item">Hide</a>
    <a href="#" id="group-key-expand" class="dropdown-item">Expand</a>
  </div>

  <div id="network-statistics-wrapper" class="floater">
    <div id="network-statistics-draghandle"><span class="oi oi-move"></span></div>
    <table id="network-statistics">
      <tbody>
        <tr>
          <td class="text-right">
            <span id="numberOfNodes"></span>
            (<span id="numberOfSelectedNodes"></span>)
          </td>
          <td>Nodes (Selected)</td>
        </tr>
        <tr>
          <td id="numberOfVisibleLinks" class="text-right"></td>
          <td>Links</td>
        </tr>
        <tr>
          <td id="numberOfDisjointComponents" class="text-right"></td>
          <td>Clusters</td>
        </tr>
        <tr id="singletonsRow">
          <td id="numberOfSingletonNodes" class="text-right"></td>
          <td>Singletons</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="network-statistics-context" class="dropdown-menu">
    <a href="#" id="moveStats" class="dropdown-item">Drag</a>
    <a href="#" id="hideStats" class="dropdown-item">Hide</a>
  </div>

  <span id="tooltip"></span>

  <div id="global-settings-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Global Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item active">
              <a class="nav-link active" id="filtering-tab" data-toggle="tab" href="#filtering-config" role="tab" aria-controls="home" aria-selected="true">Filtering</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="style-tab" data-toggle="tab" href="#style-config" role="tab" aria-controls="home" aria-selected="true">Styling</a>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="filtering-config" role="tabpanel" aria-labelledby="filtering-tab">
              <div class="form-group row show-for-nn" title="By what algorithm would you like to prune links from the network?">
                <div class="col-4">Prune With</div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col" title="Show all links within threshold">
                      <input type="radio" name="NNOptions" id="links-show-all" autocomplete="off" checked> None
                    </label>
                    <label class="btn btn-light col" title="Prune links by Nearest Neighbor">
                      <input type="radio" name="NNOptions" id="links-show-nn" autocomplete="off"> Nearest Neighbor
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row" title="By what variable would you like to prune links from the network?">
                <div class="col-4"><label for="link-sort-variable">Filter Links on</label></div>
                <div class="col-8"><select id="link-sort-variable" class="custom-select custom-select-sm linkVariables"><option value="distance" selected>Distance</option></select></div>
              </div>
              <div class="form-group row" title="What's the maximum genetic distance you're willing to call a link?">
                <div class="col-4"><label for="link-threshold">Filtering Threshold</label></div>
                <div class="col-8"><svg id="link-threshold-sparkline"></svg></div>
                <div class="col-8 offset-4"><input type="number" class="form-control custom-select-sm" id="link-threshold" value="0.015" step="0.001" /></div>
              </div>
              <div class="form-group row" title="Would you like to show or hide nodes with no visible links?">
                <div class="col-4"><label for="node-singletons-show">Singletons</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="singletons" id="node-singletons-show" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="singletons" id="node-singletons-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row" title="Click to reveal all hidden elements of the network.">
                <div class="col-4"><label for="RevealAllTab">Reveal</label></div>
                <div class="col-8"><button id="RevealAllTab" type="button" class="btn btn-light btn-sm w-100">Everything</button></div>
              </div>
              <hr />
              <div class="form-group row" title="Display a table of overview statistics for the network">
                <div class="col-4">Statistics</div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col" title="Show a table of overview statistics for the network">
                      <input type="radio" name="network-statistics-visibility" id="network-statistics-show" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col" title="Do not show a table of overview statistics for the network">
                      <input type="radio" name="network-statistics-visibility" id="network-statistics-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="style-config" role="tabpanel" aria-labelledby="style-tab">
              <div class="form-group row" title="By what variable nodes be colored?">
                <div class="col-4"><label for="node-color-variable">Color Nodes By</label></div>
                <div class="col-8"><select id="node-color-variable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
              </div>
              <div id="node_color_value_row" class="form-group row" title="What color should the nodes be?">
                <div class="col-4"><label for="node-color">Nodes</label></div>
                <div class="col-8"><input type="color" id="node-color" class="custom-select custom-select-sm" value="#1f77b4" /></div>
              </div>
              <div class="form-group row" title="By what variable should links be colored?">
                <div class="col-4"><label for="link-color-variable">Color Links By</label></div>
                <div class="col-8"><select id="link-color-variable" class="custom-select custom-select-sm linkVariables"><option>None</option></select></div>
              </div>
              <div id="link-color-row" class="form-group row" title="What color should the links be?">
                <div class="col-4"><label for="link-color">Links</label></div>
                <div class="col-8"><input type="color" id="link-color" class="custom-select custom-select-sm" value="#a6cee3" /></div>
              </div>
              <div class="form-group row" title="What color should denote selection?">
                <div class="col-4"><label for="selected-color">Selected</label></div>
                <div class="col-8"><input type="color" id="selected-color" class="custom-select custom-select-sm" value="#ff8300" /></div>
              </div>
              <div class="form-group row" title="What color should the background be?">
                <div class="col-4"><label for="background-color">Background</label></div>
                <div class="col-8"><input type="color" id="background-color" class="custom-select custom-select-sm" value="#ffffff" /></div>
              </div>
              <div class="form-group row" title="Should MicrobeTrace display the table of colors?">
                <div class="col-4">Color Table</div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="colorTableShowHide" id="color-table-show" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="colorTableShowHide" id="color-table-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row" title="Load an existing MicrobeTrace style file">
                <div class="col-4">Apply Style</div>
                <div class="col-8">
                  <input type="file" id="apply-style" class="d-none" />
                  <label class="custom-file-label" for="apply-style">Choose MicrobeTrace Style File</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="btn-group" data-toggle="buttons">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
          </div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="session-save-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-8">
              <input type="text" id="save-file-name" class="form-control form-control-sm" title="What would you like to call your MicrobeTrace Save File?" placeholder="Filename" />
            </div>
            <div class="col-4">
              <select id="save-file-format" class="form-control form-control-sm" title="What format file would you like to save?">
                <option selected>microbetrace</option>
                <option>hivtrace</option>
                <option>microbetracestyle</option>
              </select>
            </div>
          </div>
          <div class="form-group row" title="Should MicrobeTrace compress this save file?">
            <div class="col">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="save-file-compress" checked />
                <label class="form-check-label" for="save-file-compress">Compress?</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="save-data" class="btn btn-primary" data-dismiss="modal">Save</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="session-stash-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Stash</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row" title="What would you like to call this Stash?">
            <div class="col">
              <input type="text" id="stash-name" class="form-control form-control-sm" placeholder="Name your stash!" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="stash-data" class="btn btn-primary" data-dismiss="modal">Stash!</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="session-recall-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Recall Stash</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="recall-stashes-available" class="table-sm"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="recall-delete-stash">Delete</button>
          <button type="button" class="btn" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="recall-load-stash">Recall</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">About MicrobeTrace</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <h3>MicrobeTrace <small>v<span id="version"></span></small></h3>
          <p class="text-muted">Commit: <a id="commit" target="_blank"></a> on <a id="branch" target="_blank"></a></p>
          <p>MicrobeTrace is a desktop application that renders existing data from high-risk contact networks in an easy-to-use Graphical User Interface (GUI). The network visualization can be customized according to supplemental data sources and mathematical inferences like the most probable transmission pathways. MicrobeTrace is a highly responsive, visual sequence analytics tool which can reduce the gap between data production and analytics and help you to discover, understand, and display relationships (links) between patients (nodes). MicrobeTrace can be deployed on laptops to locations without any Internet access, thereby reducing both the startup cost and analysis time and effort.</p>
          <p class="ifOnline"><a href="https://github.com/CDCgov/MicrobeTrace/wiki" target="_blank">Click Here to Learn More</a></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exit-modal" tabindex="-1" role="dialog" aria-labelledby="exitModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exitModalLabel">Leave MicrobeTrace Session?</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          Are you certain you want to leave this MicrobeTrace session? Any unsaved configurations will be lost!
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
          <button type="button" id="exit-button" class="btn btn-danger" data-dismiss="modal">Leave Session</button>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts/polyfills.js"></script>
  <script src="node_modules/underscore/underscore-min.js"></script>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/alertifyjs/build/alertify.min.js"></script>
  <script src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
  <script src="node_modules/chosen-js/chosen.jquery.min.js"></script>
  <script src="node_modules/fileto/index.js"></script>
  <script src="node_modules/screenfull/dist/screenfull.js"></script>
  <script src="node_modules/clipboard/dist/clipboard.min.js"></script>
  <script src="node_modules/moment/min/moment-with-locales.min.js"></script>
  <script src="node_modules/papaparse/papaparse.min.js"></script>
  <script src="node_modules/jszip/dist/jszip.min.js"></script>
  <script src="node_modules/xlsx/dist/xlsx.core.min.js"></script>
  <script src="node_modules/xss/dist/xss.min.js"></script>
  <script src="node_modules/tn93/dist/tn93.min.js"></script>
  <script src="node_modules/d3/dist/d3.min.js"></script>
  <script src="node_modules/d3-force-attract/dist/d3-force-attract.min.js"></script>
  <script src="node_modules/d3-symbol-extra/build/d3-symbol-extra.min.js"></script>
  <script src="node_modules/html5sortable/dist/html5sortable.min.js"></script>
  <script src="node_modules/plotly.js/dist/plotly.min.js"></script>
  <script src="node_modules/tabulator-tables/dist/js/tabulator.min.js"></script>
  <script src="node_modules/tidytree/dist/tidytree.min.js"></script>
  <script src="node_modules/3d-force-graph/dist/3d-force-graph.min.js"></script>
  <script src="node_modules/leaflet/dist/leaflet.js"></script>
  <script src="node_modules/alignment-viewer/dist/alignment-viewer.min.js"></script>
  <script src="node_modules/marked/marked.min.js"></script>
  <script src="vendor/FileSaver.min.js"></script>
  <script src="vendor/saveSvgAsPng.js"></script>
  <script src="vendor/shpwrite.js"></script>
  <script src="node_modules/localforage/dist/localforage.min.js"></script>
  <script src="scripts/common.js"></script>
  <script>
  $(function(){
    'use strict';

    $('#ie-warning').remove();

    // Before anything else gets done, ask the user to accept the legal agreement
    if(!localStorage.getItem('licenseAccepted')){
      $('#acceptAgreement').on('click', function(){
        localStorage.setItem('licenseAccepted', new Date());
      });
      $('#licenseAgreement').modal({
        backdrop: 'static',
        keyboard: false
      });
    }

    if ('serviceWorker' in window.navigator) {
      window.navigator.serviceWorker.register('sw.js', {scope: './'}).catch(function(error) {
        console.error('Service Worker Registration failed with ' + error);
      });
    }

    window.session = app.sessionSkeleton();
    window.temp = app.tempSkeleton();

    window.layout = new window.GoldenLayout({
      settings: {
        selectionEnabled: true,
        showPopoutIcon: false
      },
      content: [{
        type: 'stack',
        content: []
      }]
    }, $('#main-panel'));

    layout.init();

    layout.contentItems = [];

    $('.modal-header').on('mousedown', function(e1){
      var body = $('body');
      var parent = $(this).parent().parent().parent();
      body.on('mousemove', e2 => {
        parent
          .css('top', parseFloat(parent.css('top')) + e2.originalEvent.movementY + 'px')
          .css('left', parseFloat(parent.css('left')) + e2.originalEvent.movementX + 'px');
      });
      body.on('mouseup', e3 => body.off('mousemove').off('mouseup'));
    });

    // Let's set up the Nav Bar
    $('#stash-data').on('click', function(){
      localforage.setItem('stash-'+Date.now()+'-'+$('#stash-name').val(), JSON.stringify(session)).then(function(){
        alertify.success('Session Stashed Successfully!');
      });
    });

    var table = new Tabulator('#recall-stashes-available', {
      height: '100%',
      layout: "fitColumns",
      selectable: 1,
      columns: [
        {title:"Name", field:"name"},
        {title:"Date", field:"date", align:"right", sorter:"date"}
      ]
    });

    function updateTable(){
      localforage.keys().then(function(keys){
        var rows = [];
        keys.forEach(function(k){
          if(!k.substring(0, 5) === 'stash') return;
          rows.push({
            fullname: k,
            name: k.substring(20),
            date: (new Date(parseFloat(k.substring(6,19)))).toISOString()
          });
        });
        table.setData(rows);
      });
    }

    $('#RecallDataTab').on('click', function(){
      updateTable();
      $('#session-recall-modal').modal('show');
    });

    $('#recall-delete-stash').on('click', function(){
      var key = table.getSelectedData()[0].fullname;
      localforage.removeItem(key).then(function(){
        updateTable();
        alertify.success('That stash has been deleted.');
      });
    });

    $('#recall-load-stash').on('click', function(){
      var key = table.getSelectedData()[0].fullname;
      localforage.getItem(key).then(function(json){
        app.applySession(JSON.parse(json));
        $('#session-recall-modal').modal('hide');
      });
    });

    $('#save-data').on('click', function(){
      var name = $('#save-file-name').val();
      var format = $('#save-file-format').val();
      var data;
      if(format === 'microbetracestyle'){
        data = JSON.stringify(session.style);
      } else if(format === 'hivtrace'){
        data = app.exportHIVTRACE();
      } else {
        data = JSON.stringify(session);
      }
      if($('#save-file-compress').is(':checked')){
        var zip = new JSZip();
        zip.file(name + '.' + format, data);
        zip.generateAsync({
          type:"blob",
          compression: "DEFLATE",
          compressionOptions: {
          level: 9
        }}).then(function(content) {
          saveAs(content, name + '.zip');
        });
      } else {
        var blob = new Blob([data], {type: 'application/json;charset=utf-8'});
        saveAs(blob, name + '.' + format);
      }
    });

    $('#OpenTab').on('change', function(e){
      if(e.target.files.length > 0){
        var extension = e.target.files[0].name.split('.').pop().toLowerCase();
        if(extension === 'zip'){
          var new_zip = new JSZip();
          new_zip.loadAsync(e.target.files[0])
            .then(function(zip) {
              zip.forEach(function(relativePath, zipEntry){
                extension = zipEntry.name.split('.').pop();
                zipEntry.async("string").then(function(c){
                  app.processJSON(c, extension);
                });
              });
            });
        } else {
          var reader = new FileReader();
          reader.onloadend = function(out){
            app.processJSON(out.target.result, extension);
          };
          reader.readAsText(e.target.files[0], 'UTF-8');
        }
      }
    });

    $('#AddDataTab').on('click', function(){
      $('#network-statistics-hide').trigger('click');
      app.launchView('files');
    });

    $('#NewTab').on('click', function(){
      $('#exit-modal').modal();
    });

    $('#exit-button').on('click', app.reset);

    $('.viewbutton').on('click', function(){ app.launchView($(this).data('href')); });

    $('#ReloadTab').on('click', function(){
      $('#exit-button').on('click', function(){ window.location.reload(); });
      $('#exit-modal').modal();
    });

    $('#FullScreenTab').on('click', function(){ screenfull.toggle(); });

    $('[name="NNOptions"]').on('change', function(){
      app.updateNetwork($('#node-singletons-hide').is(':checked'));
    });

    $('#link-sort-variable').on('change', function(e){
      session.style.widgets['link-sort-variable'] = e.target.value;
      app.updateThresholdHistogram();
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    app.updateThresholdHistogram = function(){
      var width = 280,
          height = 48,
          svg = d3.select('svg#link-threshold-sparkline')
            .html(null)
            .attr('width', width)
            .attr('height', height);

      var lsv = session.style.widgets['link-sort-variable'],
          n = session.data.links.length,
          max = Number.MIN_SAFE_INTEGER,
          min = Number.MAX_SAFE_INTEGER,
          data = Array(n);
      for(var i = 0; i < n; i++){
        var x = parseFloat(session.data.links[i][lsv]);
        data[i] = x;
        if(x < min) min = x;
        if(x > max) max = x;
      }
      var range = max - min;
      var ticks = 40;

      var x = d3.scaleLinear()
        .domain([min, max])
        .range([0, width]);

      var bins = d3.histogram()
          .domain(x.domain())
          .thresholds(x.ticks(ticks))
          (data);

      var y = d3.scaleLinear()
          .domain([0, d3.max(bins, function(d) { return d.length; })])
          .range([height, 0]);

      var bar = svg.selectAll('.bar').data(bins)
        .enter().append('g')
          .attr('class', 'bar')
          .attr('transform', function(d) { return 'translate(' + x(d.x0) + ',' + y(d.length) + ')'; });

      bar.append('rect')
          .attr('x', 1)
          .attr('width', 6)
          .attr('height', function(d) { return height - y(d.length); });

      function updateThreshold(){
        var xc = d3.mouse(svg.node())[0];
        session.style.widgets['link-threshold'] = xc / width * range * 1.05 + min;
        $('#link-threshold').val(parseFloat(session.style.widgets['link-threshold'].toLocaleString()));
      }

      svg.on('click', function(){
        updateThreshold();
        app.setLinkVisibility();
        app.tagClusters();
        if($('#node-singletons-hide').is(':checked')) app.setNodeVisibility();
        app.computeDegree();
        app.updateStatistics();
        $(window).trigger('link-threshold-change');
      });

      svg.on('mousedown', function(){
        d3.event.preventDefault();
        svg.on('mousemove', updateThreshold);
        svg.on('mouseup mouseleave', function(){
          app.setLinkVisibility();
          app.tagClusters();
          if($('#node-singletons-hide').is(':checked')) app.setNodeVisibility();
          app.computeDegree();
          app.updateStatistics();
          $(window).trigger('link-threshold-change');
          svg
            .on('mousemove', null)
            .on('mouseup', null)
            .on('mouseleave', null);
        });
      });
      $(window).trigger('link-threshold-change');
    };

    $('#node-singletons-show, #node-singletons-hide').on('change', function(e){
      app.setNodeVisibility();
      app.updateStatistics();
    });

    $('#links-show-nn, #links-show-all').on('change', function(e){
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    $('#link-threshold').on('input', function(){
      app.setLinkVisibility();
      app.tagClusters();
      if($('#node-singletons-hide').is(':checked')) app.setNodeVisibility();
      app.computeDegree();
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    $('#network-statistics-hide').parent().on('click', function(){
      $('#network-statistics-wrapper').fadeOut();
    });

    $('#network-statistics-show').parent().on('click', function(){
      app.updateStatistics();
      $('#network-statistics-wrapper').fadeIn();
    });

    $('#network-statistics-wrapper').on('contextmenu', function(e){
      e.preventDefault();
      $('#network-statistics-context').css({
        top: e.clientY,
        left: e.clientX,
        display: 'block'
      });
    });

    $('#hideStats').on('click', function(e){
      $(this).parent().hide();
      $('#network-statistics-hide').parent().click();
    });

    $('#moveStats').on('click', function(){
      var $this = $(this);
      $this.parent().hide();
      if($this.text() == 'Drag'){
        $('#network-statistics-draghandle').slideDown();
        $this.text('Pin');
      } else {
        $('#network-statistics-draghandle').slideUp();
        $this.text('Drag');
      }
    });

    $('#network-statistics-draghandle').on('mousedown', function(){
      var body = $('body');
      var parent = $(this).parent();
      body.on('mousemove', e2 => {
        parent
          .css('bottom', parseFloat(parent.css('bottom')) - e2.originalEvent.movementY + 'px')
          .css('right', parseFloat(parent.css('right')) - e2.originalEvent.movementX + 'px');
      });
      body.on('mouseup', e3 => body.off('mousemove').off('mouseup'));
    });

    $('#RevealAllTab').on('click', function(e){
      session.data.clusters.forEach(function(c){ c.visible = true; });
      app.setLinkVisibility();
      $('#node-singletons-show').parent().click(); //calls app.setNodeVisibility();
    });

    $('#node-color-variable')
      .val(session.style.widgets['node-color-variable'])
      .on('change', function(e){
        var variable = e.target.value;
        session.style.widgets['node-color-variable'] = variable;
        if(variable === 'None'){
          $('#node_color_value_row').slideDown();
          $('#nodeColors').remove();
          $(window).trigger('node-color-change');
          return;
        }
        $('#node_color_value_row').slideUp();
        $('#nodeColors').remove();
        var table = $('<tbody id="nodeColors"></tbody>').appendTo('#group-key');
        table.append('<tr><th contenteditable>Node '+app.titleize(variable)+'</th><th>Color</th><tr>');
        var values = app.createNodeColorMap();
        values.forEach(function(value, i){
          var input = $('<input type="color" value="'+temp.style.nodeColorMap(value)+'" />')
            .on('change', function(evt){
              session.style.nodeColors.splice(i, 1, evt.target.value);
              temp.style.nodeColorMap = d3.scaleOrdinal(session.style.nodeColors).domain(values);
              $(window).trigger('node-color-change');
            });
          var cell = $('<td></td>').append(input);
          var row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
          table.append(row);
        });
        $(window).trigger('node-color-change');
      });

    $('#node-color')
      .on('change', function(e){
        session.style.widgets['node-color'] = e.target.value;
        $(window).trigger('node-color-change');
      })
      .val(session.style.widgets['node-color']);

    $('#link-color-variable')
      .val(session.style.widgets['link-color-variable'])
      .on('change', function(e){
        var variable = e.target.value;
        session.style.widgets['link-color-variable'] = variable;
        if(variable === 'None'){
          $('#link-color-row').slideDown();
          $('#link-colors').remove();
          $(window).trigger('link-color-change');
          return;
        }
        $('#link-color-row').slideUp();
        $('#link-colors').remove();
        var values = app.createLinkColorMap();
        var table = $('<tbody id="link-colors"></tbody>').appendTo('#group-key');
        table.append('<tr><th contenteditable>Link '+app.titleize(variable)+'</th><th>Color</th><tr>');
        values.forEach(function(value, i){
          var input = $('<input type="color" value="'+temp.style.linkColorMap(value)+'" />')
            .on('change', function(evt){
              session.style.linkColors.splice(i, 1, evt.target.value);
              temp.style.linkColorMap = d3.scaleOrdinal(session.style.linkColors).domain(values);
              $(window).trigger('link-color-change');
            });
          var cell = $('<td></td>').append(input);
          var row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
          table.append(row);
        });
        $(window).trigger('link-color-change');
      });

    $('#link-color').on('change', function(e){
      session.style.widgets['link-color'] = e.target.value;
      $(window).trigger('link-color-change');
    });

    $('#selected-color').on('change', function(e){
      session.style.widgets['selected-color'] = e.target.value;
      session.style.widgets['selected-color-contrast'] = app.contrastColor(e.target.value);
      $(window).trigger('selected-color-change');
    });

    $('#background-color').on('change', function(e){
      session.style.widgets['background-color'] = e.target.value;
      session.style.widgets['background-color-contrast'] = app.contrastColor(e.target.value);
      $(window).trigger('background-color-change');
    });

    $('#color-table-show').parent().on('click', function(){
      $('#group-key').fadeIn();
    });

    $('#color-table-hide').parent().on('click', function(){
      $('#group-key').fadeOut();
    });

    $('#apply-style').on('change', function(){
      if(this.files.length > 0){
        var reader = new FileReader();
        reader.onload = function(e){
          app.applyStyle(JSON.parse(e.target.result));
        };
        reader.readAsText(this.files[0]);
      }
    });

    $('#PhylogeographyTab').on('click', function(){
      var l = {"type":"column","content":[{"type":"row","content":[{"type":"stack","content":[{"type":"geo_map"}]},{"type":"stack","content":[{"type":"phylogenetic_tree"}]}]},{"type":"stack","content":[{"type":"timeline"}]}]};
      app.loadLayout(l);
      setTimeout(function(){ app.loadLayout(l); }, 80);
    })

    if(window.navigator.onLine){
      $('#HelpTab')
        .removeClass('viewbutton')
        .attr('href', 'https://github.com/CDCgov/MicrobeTrace/wiki')
        .attr('target', '_blank');
      $('.ifOnline').show();
    }

    $.getJSON('package.json', function(r){
      app.manifest = r;
      $('#version').html(r.version);
    });

    $.get('.git/HEAD', function(ref){
      var branch = ref.split('/').pop();
      $('#branch')
        .attr('href', 'https://github.com/CDCgov/MicrobeTRACE/tree/' + branch)
        .text(branch);
      $.get('.git/' + ref.split(' ').pop(), function(r){
        $('#commit')
          .attr('href', 'https://github.com/CDCgov/MicrobeTrace/commit/' + r)
          .text(r.slice(0,7));
      });
    }).fail(function(){
      $('#branch').parent().remove();
    });

    $('#group-key-wrapper').on('contextmenu', function(e){
      e.preventDefault();
      $('#group-key-context').css({
        top: e.clientY,
        left: e.clientX,
        display: 'block'
      });
    });

    $('#group-key-drag').on('click', function(){
      var $this = $(this);
      $this.parent().hide();
      if($this.text() == 'Drag'){
        $('#group-key-draghandle').slideDown();
        $this.text('Pin');
      } else {
        $('#group-key-draghandle').slideUp();
        $this.text('Drag');
      }
    });

    $('#group-key-draghandle').on('mousedown', function(){
      var body = $('body');
      var parent = $(this).parent();
      body.on('mousemove', e2 => {
        parent
          .css('top', parseFloat(parent.css('top')) + e2.originalEvent.movementY + 'px')
          .css('right', parseFloat(parent.css('right')) - e2.originalEvent.movementX + 'px');
      });
      body.on('mouseup', e3 => body.off('mousemove').off('mouseup'));
    });

    $('#group-key-hide').on('click', function(){
      $(this).parent().hide();
      $('#color-table-hide').parent().click();
    });

    $('#group-key-expand').on('click', function(){
      var $this = $(this);
      if($this.text() === 'Expand'){
        $('#group-key-wrapper').css({
          'max-height': 'none',
          'overflow-y': 'auto'
        });
        $this.text('Contract');
      } else {
        $('#group-key-wrapper').css({
          'max-height': '400px',
          'overflow-y': 'scroll'
        });
        $this.text('Expand');
      }
    });

    $('form').on('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        e.stopPropagation();
      }
    });

    $('#search').on('input', function(e){
      if(e.target.value === ''){
        session.data.nodes.forEach(function(n){ n.selected = false; });
      } else {
        session.data.nodes.forEach(function(n){ n.selected = (n.id.indexOf(e.target.value)>-1); });
        if(!session.data.nodes.some(function(n){ return n.selected; })) alertify.warning('No matches!');
      }
      $(window).trigger('node-selected');
    });

    app.launchView('files');

    $(document).on('keydown', function(e){
      if(e.ctrlKey && e.key === 'f'){
        e.preventDefault();
        $('#search').focus();
      }
      if(e.ctrlKey && e.key === 's'){
        e.preventDefault();
        $('#session-save-modal').modal();
      }
    });

    layout.on('stateChanged', function(){ session.layout = app.cacheLayout(layout.root.contentItems[0]); });

    $(window)
      .on('node-selected', function(){
        $('#numberOfSelectedNodes').text(session.data.nodes.filter(function(d){ return d.selected; }).length.toLocaleString());
      })
      .on('click', function(){
        $('#network-statistics-context, #group-key-context').hide();
      })
      .on('link-threshold-change', function(){
        if(session.style.widgets['link-color-variable'] !== 'None'){
          $('#link-color-variable').trigger('change');
        }
      })
      .on('node-visibility', function(){
        if(session.style.widgets['node-color-variable'] !== 'None'){
          $('#node-color-variable').trigger('change');
        }
      })
      .on('resize', function(){
        layout.updateSize();
      })
      .on('beforeunload', function(e){
        e.preventDefault();
        $('#exit-button').on('click', function(){ window.location.reload(); });
        $('#exit-modal').modal();
        e.returnValue = 'Are you certain? This session will be lost!';
      });
  });

  alertify.defaults.transition = 'slide';
  alertify.defaults.theme.ok = 'btn btn-primary';
  alertify.defaults.theme.cancel = 'btn btn-danger';
  alertify.defaults.theme.input = 'form-control';
  </script>

</body>
</html>
